# üîß Troubleshooting: –°–æ–∑–¥–∞–Ω–∏–µ —É—Å–ª—É–≥ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:
1. State Machine —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ Supabase (`bot_states` —Ç–∞–±–ª–∏—Ü–∞)
2. –í—Å–µ 4 —à–∞–≥–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ

## üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

### 1. SQL –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard ‚Üí Table Editor ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ç–∞–±–ª–∏—Ü—ã `bot_states`

**–†–µ—à–µ–Ω–∏–µ:** –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –º–∏–≥—Ä–∞—Ü–∏—é:
```sql
-- –°–º. migrations/create_bot_states_table.sql
```

### 2. –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è (JSONB)
**–°–∏–º–ø—Ç–æ–º:** –°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É —à–∞–≥–∞–º–∏

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –í –ª–æ–≥–∞—Ö Worker –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è:
- `[handleStateBasedMessage]` - –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —à–∞–≥–æ–≤
- `[addService]` - –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏

### 3. –ü–∞—Ä—Ç–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ `partners`
**–°–∏–º–ø—Ç–æ–º:** –û—à–∏–±–∫–∞ FK constraint

**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞—Ä—Ç–Ω–µ—Ä —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ `partners` (–Ω–µ —Ç–æ–ª—å–∫–æ –≤ `partner_applications`)

### 4. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –≤ `botState.data`
**–°–∏–º–ø—Ç–æ–º:** `serviceData` —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–æ–ª—è

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –õ–æ–≥–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å:
```
[handleServiceCategorySelection] Saving service with data: {...}
```

## üß™ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É bot_states:**
   ```sql
   SELECT * FROM bot_states LIMIT 10;
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Worker:**
   ```bash
   cd cloudflare/workers/partner-webhook
   wrangler tail --env=""
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–∞—Ä—Ç–Ω–µ—Ä —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:**
   ```sql
   SELECT chat_id FROM partners WHERE chat_id = 'YOUR_CHAT_ID';
   ```

## üìã –ü–æ—à–∞–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:

1. ‚úÖ –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start` –≤ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π –±–æ—Ç
2. ‚úÖ –ù–∞–∂–º–∏—Ç–µ: üìù –ö–æ–Ω—Ç–µ–Ω—Ç ‚Üí üõ†Ô∏è –£—Å–ª—É–≥–∏ ‚Üí ‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —É—Å–ª—É–≥—É
3. ‚úÖ –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–®–∞–≥ 1)
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –ë–î: `SELECT * FROM bot_states WHERE chat_id = 'YOUR_CHAT_ID'`
5. ‚úÖ –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ `awaiting_service_description`
6. ‚úÖ –í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–®–∞–≥ 2)
7. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `awaiting_service_price`
8. ‚úÖ –í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É (–®–∞–≥ 3)
9. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `awaiting_service_category`
10. ‚úÖ –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é (–®–∞–≥ 4)
11. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –ë–î: `SELECT * FROM services WHERE partner_chat_id = 'YOUR_CHAT_ID' ORDER BY created_at DESC LIMIT 1`

## üîß –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Worker –Ω–∞ –æ—à–∏–±–∫–∏
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `SUPABASE_URL` –∏ `SUPABASE_KEY` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ `services` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ Supabase

# üìù –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Cloudflare Webhooks

**–°—Ç–∞—Ç—É—Å:** –í –ø—Ä–æ—Ü–µ—Å—Å–µ  
**–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø:** –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

---

## ‚úÖ –®–ê–ì 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–ó–ê–í–ï–†–®–ï–ù–û)

–Ø —É–∂–µ —Å–æ–∑–¥–∞–ª:
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞ (`cloudflare/`)
- ‚úÖ –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Supabase –∏ Telegram
- ‚úÖ –ë–∞–∑–æ–≤—ã–µ handlers –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –±–æ—Ç–∞
- ‚úÖ Webhook endpoint –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –±–æ—Ç–∞
- ‚úÖ –°–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhooks (`scripts/setup_webhooks.py`)
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏

---

## üìã –®–ê–ì 2: –ß—Ç–æ –í–ê–ú –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –°–ï–ô–ß–ê–°

### 2.1 –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Cloudflare Wrangler CLI

**–ù–∞ macOS:**
```bash
npm install -g wrangler
# –∏–ª–∏
brew install cloudflare-wrangler
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:**
```bash
wrangler --version
```

### 2.2 –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç Cloudflare (–µ—Å–ª–∏ –Ω–µ—Ç)

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://dash.cloudflare.com/
2. –°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç (–µ—Å–ª–∏ –Ω–µ—Ç)
3. –ó–∞–ø–∏—à–∏—Ç–µ –≤–∞—à account ID (–±—É–¥–µ—Ç –Ω—É–∂–µ–Ω –ø–æ–∑–∂–µ)

### 2.3 –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ Wrangler

```bash
wrangler login
```

–≠—Ç–æ –æ—Ç–∫—Ä–æ–µ—Ç –±—Ä–∞—É–∑–µ—Ä –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Cloudflare.

---

## üìã –®–ê–ì 3: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### 3.1 –î–æ–±–∞–≤–∏—Ç—å –≤ `.env` —Ñ–∞–π–ª —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

```bash
# Cloudflare Webhook URLs (–±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è)
CLOUDFLARE_CLIENT_WEBHOOK_URL=
CLOUDFLARE_PARTNER_WEBHOOK_URL=
CLOUDFLARE_ADMIN_WEBHOOK_URL=

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: Secret tokens –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ webhooks
WEBHOOK_SECRET_TOKEN_CLIENT=
WEBHOOK_SECRET_TOKEN_PARTNER=
WEBHOOK_SECRET_TOKEN_ADMIN=
```

### 3.2 –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –≤ Cloudflare

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –∫–∞–∂–¥–æ–≥–æ worker, –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã:

```bash
# –î–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –±–æ—Ç–∞
cd cloudflare/workers/client-webhook
wrangler secret put TOKEN_CLIENT
wrangler secret put SUPABASE_URL
wrangler secret put SUPABASE_KEY
wrangler secret put FRONTEND_URL
wrangler secret put WELCOME_BONUS_AMOUNT
# –∏ –¥—Ä—É–≥–∏–µ —Å–µ–∫—Ä–µ—Ç—ã –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ
```

---

## üìã –®–ê–ì 4: –î–µ–ø–ª–æ–π –ø–µ—Ä–≤–æ–≥–æ worker (–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –±–æ—Ç)

### 4.1 –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Node.js –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã)

–ü–æ–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–µ –Ω—É–∂–Ω—ã, –≤—Å–µ –≤—Å—Ç—Ä–æ–µ–Ω–æ –≤ Cloudflare Workers.

### 4.2 –î–µ–ø–ª–æ–π –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –±–æ—Ç–∞

```bash
cd /Users/ghbi/Downloads/loyalitybot/cloudflare/workers/client-webhook
wrangler deploy
```

**–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:**
1. –ó–∞–ø–∏—à–∏—Ç–µ URL worker'–∞ (–±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è)
2. –î–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ `.env` –∫–∞–∫ `CLOUDFLARE_CLIENT_WEBHOOK_URL`

### 4.3 –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –±–æ—Ç–∞

```bash
cd cloudflare/workers/client-webhook
wrangler secret put TOKEN_CLIENT
# –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –±–æ—Ç–∞

wrangler secret put SUPABASE_URL
# –í–≤–µ–¥–∏—Ç–µ URL Supabase –ø—Ä–æ–µ–∫—Ç–∞

wrangler secret put SUPABASE_KEY
# –í–≤–µ–¥–∏—Ç–µ Supabase API key

wrangler secret put FRONTEND_URL
# –í–≤–µ–¥–∏—Ç–µ URL —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, https://loyalitybot.netlify.app)

wrangler secret put WELCOME_BONUS_AMOUNT
# –í–≤–µ–¥–∏—Ç–µ 100 (–∏–ª–∏ –¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
```

### 4.4 –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç

```bash
cd /Users/ghbi/Downloads/loyalitybot
python3 scripts/setup_webhooks.py
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ Telegram API:

```bash
# –£–¥–∞–ª–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π webhook (–µ—Å–ª–∏ –µ—Å—Ç—å)
curl -X POST "https://api.telegram.org/bot<TOKEN_CLIENT>/deleteWebhook?drop_pending_updates=true"

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π webhook
curl -X POST "https://api.telegram.org/bot<TOKEN_CLIENT>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{"url": "https://loyalitybot-client-webhook.<your-subdomain>.workers.dev"}'
```

### 4.5 –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start` –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –±–æ—Ç
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Cloudflare Dashboard
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç

---

## üìã –®–ê–ì 5: –°–æ–∑–¥–∞—Ç—å handlers –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–≥–æ –∏ –∞–¥–º–∏–Ω-–±–æ—Ç–∞

**–≠—Ç–æ —Å–¥–µ–ª–∞—é –Ø, –≤—ã –ø–æ–∫–∞ –∂–¥–µ—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –®–ê–ì–ê 2-4**

–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫:
- ‚úÖ Wrangler —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
- ‚úÖ –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –±–æ—Ç –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –í—ã —Å–æ–æ–±—â–∏—Ç–µ –º–Ω–µ –æ–± —É—Å–ø–µ—Ö–µ

–Ø —Å–æ–∑–¥–∞–º:
- Handlers –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–≥–æ –±–æ—Ç–∞
- Handlers –¥–ª—è –∞–¥–º–∏–Ω-–±–æ—Ç–∞
- Webhook endpoints –¥–ª—è –Ω–∏—Ö

---

## üìã –®–ê–ì 6: –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å REST API

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è –≤—Å–µ—Ö –±–æ—Ç–æ–≤, —è –∞–¥–∞–ø—Ç–∏—Ä—É—é `secure_api.py` –¥–ª—è Cloudflare Workers.

---

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø

1. **–ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ —Å—Ç–∞—Ä—ã–µ –±–æ—Ç—ã —Å—Ä–∞–∑—É** - –¥–µ—Ä–∂–∏—Ç–µ –∏—Ö —Ä–∞–±–æ—Ç–∞—é—â–∏–º–∏ –¥–æ –ø–æ–ª–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
2. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∫–∞–∂–¥—ã–π —ç—Ç–∞–ø** –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
3. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏** –≤ Cloudflare Dashboard
4. **–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ backup** —Ç–µ–∫—É—â–∏—Ö –±–æ—Ç–æ–≤ –Ω–∞ Fly.io

---

## üìû –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?

1. **–í—ã–ø–æ–ª–Ω–∏—Ç–µ –®–ê–ì 2-4** (—É—Å—Ç–∞–Ω–æ–≤–∫–∞ Wrangler, –¥–µ–ø–ª–æ–π –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –±–æ—Ç–∞)
2. **–°–æ–æ–±—â–∏—Ç–µ –º–Ω–µ**, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
3. **–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏** —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –±–æ—Ç–∞

**–ö–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã - –Ω–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ, –∏ —è –ø—Ä–æ–¥–æ–ª–∂—É!** üöÄ

# ‚úÖ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–º–∏—Å—Å–∏–π - –ó–ê–í–ï–†–®–ï–ù–û

**–î–∞—Ç–∞:** 2025-01-XX  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

---

## üì¶ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. SQL –ú–∏–≥—Ä–∞—Ü–∏—è (`ecosystem_migration.sql`)
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `base_reward_percent` –≤ —Ç–∞–±–ª–∏—Ü—É `partners` (–¥–µ—Ñ–æ–ª—Ç 5%)

### 2. –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫–æ–º–∏—Å—Å–∏–π (`referral_calculator.py`)
‚úÖ –°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å —Å –∫–ª–∞—Å—Å–æ–º `ReferralCalculator`
‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è MLM –ª–æ–≥–∏–∫–∞ (5%/5%/5% + 85% —Å–∏—Å—Ç–µ–º–µ)
‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ B2B Deal –ª–æ–≥–∏–∫–∞ (70% –ø–∞—Ä—Ç–Ω–µ—Ä—É, 30% —Å–∏—Å—Ç–µ–º–µ, –ë–ï–ó MLM)
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã unit-—Ç–µ—Å—Ç—ã

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `supabase_manager.py`
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `ReferralCalculator` (—Å fallback –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏)
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
   - `_get_partner_data_for_calculator()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä—Ç–Ω–µ—Ä–∞
   - `_get_active_b2b_deals_for_calculator()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö B2B —Å–¥–µ–ª–æ–∫
   - `_build_users_dict_for_calculator()` - –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–ª–æ–≤–∞—Ä—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - `_apply_commission_distribution()` - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—Å—á–µ—Ç–∞
‚úÖ –ü–µ—Ä–µ–ø–∏—Å–∞–Ω–∞ `process_referral_transaction_bonuses()`:
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—É—é –ª–æ–≥–∏–∫—É –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ `raw_amount` –∏ `seller_partner_id`
   - Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É (8%/4%/2%) –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ `execute_transaction()` –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ `raw_amount` –∏ `seller_partner_id`

---

## üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å

### –®–∞–≥ 1: –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏—é

–í Supabase Dashboard ‚Üí SQL Editor –≤—ã–ø–æ–ª–Ω–∏—Ç—å:

```sql
-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è base_reward_percent
ALTER TABLE partners
ADD COLUMN IF NOT EXISTS base_reward_percent NUMERIC DEFAULT 0.05;

COMMENT ON COLUMN partners.base_reward_percent IS '–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç —Å—É–º–º—ã —á–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–∞—Ä—Ç–Ω–µ—Ä-–ø—Ä–æ–¥–∞–≤–µ—Ü –æ—Ç–¥–∞–µ—Ç –≤ –∫–æ–º–∏—Å—Å–∏–æ–Ω–Ω—ã–π —Ñ–æ–Ω–¥ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π MLM –ª–æ–≥–∏–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5%)';
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä

```bash
python3 referral_calculator.py
```

–î–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏ –æ–±–∞ —Ç–µ—Å—Ç–∞:
- `test_standard_logic` ‚úÖ
- `test_b2b_deal_logic` ‚úÖ

### –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç—ã

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –±–æ—Ç—ã (Ctrl+C)
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ
python3 bot.py
python3 admin_bot.py
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ (MLM)

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
- –ö–ª–∏–µ–Ω—Ç –ë–æ–± (–ø—Ä–∏—à–µ–ª –æ—Ç –ê–ª–∏—Å—ã) –ø–æ–∫—É–ø–∞–µ—Ç –Ω–∞ 10 000 —Ä—É–± —É –ø–∞—Ä—Ç–Ω–µ—Ä–∞ "–†–µ—Å—Ç–æ—Ä–∞–Ω"
- –£ "–†–µ—Å—Ç–æ—Ä–∞–Ω–∞" `base_reward_percent = 5%`
- –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π B2B —Å–¥–µ–ª–∫–∏

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –§–æ–Ω–¥: 10 000 √ó 0.05 = 500 —Ä—É–±
- –ê–ª–∏—Å–∞ (L1): 500 √ó 0.05 = 25 —Ä—É–± –≤ `commission_balance`
- –°–∏—Å—Ç–µ–º–∞: 500 √ó 0.85 = 425 —Ä—É–±

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ø–æ–∫—É–ø–∫—É —á–µ—Ä–µ–∑ –±–æ—Ç
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î —Ç–∞–±–ª–∏—Ü—É `users`: `commission_balance` –ê–ª–∏—Å—ã –¥–æ–ª–∂–µ–Ω —É–≤–µ–ª–∏—á–∏—Ç—å—Å—è –Ω–∞ 25
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å "New commission logic applied (standard)"

### –¢–µ—Å—Ç 2: B2B Deal –ª–æ–≥–∏–∫–∞

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
- –ö–ª–∏–µ–Ω—Ç –ë–æ–± (–ø—Ä–∏—à–µ–ª –æ—Ç –ë–ª–æ–≥–µ—Ä–∞) –ø–æ–∫—É–ø–∞–µ—Ç –Ω–∞ 10 000 —Ä—É–± —É –ø–∞—Ä—Ç–Ω–µ—Ä–∞ "–†–µ—Å—Ç–æ—Ä–∞–Ω"
- –ï—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è B2B —Å–¥–µ–ª–∫–∞: –†–µ—Å—Ç–æ—Ä–∞–Ω ‚Üí –ë–ª–æ–≥–µ—Ä (seller_pays=10%, buyer_gets=15%)

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –§–æ–Ω–¥: 10 000 √ó 0.10 = 1 000 —Ä—É–±
- –°–∏—Å—Ç–µ–º–∞: 1 000 √ó 0.30 = 300 —Ä—É–±
- –ë–ª–æ–≥–µ—Ä: 1 000 √ó 0.70 = 700 —Ä—É–± –≤ `commission_balance`
- –ë–æ–± (–ø–æ–∫—É–ø–∞—Ç–µ–ª—å): 10 000 √ó 0.15 = 1 500 –±–∞–ª–ª–æ–≤ –≤ `balance` (—Å–ø–µ—Ü-–∫—ç—à–±—ç–∫)
- **MLM –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è** (–Ω–µ—Ç L1/L2/L3)

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
1. –°–æ–∑–¥–∞—Ç—å B2B —Å–¥–µ–ª–∫—É —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–±–æ—Ç–∞ –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –≤ –ë–î
2. –°–æ–∑–¥–∞—Ç—å –ø–æ–∫—É–ø–∫—É –∫–ª–∏–µ–Ω—Ç–∞ –æ—Ç –±–ª–æ–≥–µ—Ä–∞
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î:
   - `commission_balance` –±–ª–æ–≥–µ—Ä–∞: +700
   - `balance` –ø–æ–∫—É–ø–∞—Ç–µ–ª—è: +1500 (—Å–ø–µ—Ü-–∫—ç—à–±—ç–∫)
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: "New commission logic applied (b2b)"

---

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

**–£—Å–ø–µ—à–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏:**
```
INFO: New commission logic applied (standard): 4 commissions, system_total=425.00
INFO: Commission awarded: u_alice +25.00 (L1)
```

**Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É:**
```
WARNING: ReferralCalculator not available: ...
# –∏–ª–∏
ERROR: Error in new referral commission logic, falling back to old: ...
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∫–æ–º–∏—Å—Å–∏–π
SELECT 
    referrer_chat_id,
    points,
    description,
    created_at
FROM referral_rewards
WHERE reward_type = 'transaction'
ORDER BY created_at DESC
LIMIT 10;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å commission_balance –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
SELECT 
    chat_id,
    commission_balance,
    balance
FROM users
WHERE commission_balance > 0
ORDER BY commission_balance DESC;
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é:**
- –ï—Å–ª–∏ `ReferralCalculator` –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞
- –ï—Å–ª–∏ –Ω–µ—Ç `raw_amount` –∏–ª–∏ `seller_partner_id` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞
- –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–µ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ —Å—Ç–∞—Ä—É—é

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚úÖ **–í—Å–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∞—Ç–æ–º–∞—Ä–Ω—ã:**
- –û—à–∏–±–∫–∞ –≤ –æ–¥–Ω–æ–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ –Ω–µ —Å–ª–æ–º–∞–µ—Ç –¥—Ä—É–≥–∏–µ
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

‚ö†Ô∏è **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ)
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö B2B —Å–¥–µ–ª–æ–∫ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ)

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. **–î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
2. **–°–æ–∑–¥–∞—Ç—å UI** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è B2B —Å–¥–µ–ª–∫–∞–º–∏ (—Å–µ–π—á–∞—Å —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ë–î)
3. **–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏** –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ (–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å, –∫–∞–∫–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞)
4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤** (–∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [x] SQL –º–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (–∏–ª–∏ –≥–æ—Ç–æ–≤–∞ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é)
- [x] –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–æ–∑–¥–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `supabase_manager.py` –∑–∞–≤–µ—Ä—à–µ–Ω–∞
- [x] Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ
- [ ] **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥–µ** (–ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è)
- [ ] **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–µ—Ä–≤—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π** (–ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è)

---

**–ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é!** üöÄ

#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞—á –≤ Linear –∏ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Cloudflare

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    python3 cleanup_and_recreate_linear_tasks.py --dry-run  # –ü–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ
    python3 cleanup_and_recreate_linear_tasks.py --cleanup-only  # –¢–æ–ª—å–∫–æ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞–¥–∞—á–∏
    python3 cleanup_and_recreate_linear_tasks.py --create-only  # –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
    python3 cleanup_and_recreate_linear_tasks.py  # –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ
"""

import os
import sys
import requests
import time
from typing import List, Dict, Optional
from dotenv import load_dotenv

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á
sys.path.append(os.path.dirname(__file__))
from linear_task_creator import create_linear_task, get_teams

load_dotenv()

LINEAR_API_URL = "https://api.linear.app/graphql"

# –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã Linear: 1=Urgent, 2=High, 3=Medium, 4=Low
PRIORITY_MAP = {
    "P0": 1,  # Urgent (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ)
    "P1": 2,  # High (–≤–∞–∂–Ω—ã–µ)
    "P2": 3,  # Medium (–æ–±—ã—á–Ω—ã–µ)
    "P3": 4,  # Low (–Ω–∏–∑–∫–∏–µ)
}

# –ó–∞–¥–∞—á–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Cloudflare
TESTING_TASKS = [
    # –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï (P0) - –ë–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–æ–≤
    {
        "id": "TEST-CF-001",
        "title": "[Cloudflare] –¢–µ—Å—Ç: –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –±–æ—Ç - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ /start",
        "description": """**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Cloudflare**

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ `/start`
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É `/start partner_123`
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
- –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ welcome bonus

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ö–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è
- –ü–æ–ª—É—á–∞–µ—Ç welcome bonus
- –í–∏–¥–∏—Ç –∫–Ω–æ–ø–∫–∏ "–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" –∏ "–ú–æ–π –±–∞–ª–∞–Ω—Å"
- –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î

**–®–∞–≥–∏:**
1. –û—Ç–∫—Ä—ã—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –±–æ—Ç —Å –Ω–æ–≤–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/start`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –≤ –ë–î
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `users`

**Worker:** `cloudflare/workers/client-webhook`
**Handler:** `handleStart`""",
        "priority": PRIORITY_MAP["P0"],
        "team": "ENG",
        "category": "–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –¢–ï–°–¢–´"
    },
    {
        "id": "TEST-CF-002",
        "title": "[Cloudflare] –¢–µ—Å—Ç: –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π –±–æ—Ç - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
        "description": """**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Cloudflare**

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞ —á–µ—Ä–µ–∑ `/start`
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –¥–ª—è –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
- –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é –¥–ª—è Influencer (–±–µ–∑ –û–ø–µ—Ä–∞—Ü–∏–π –∏ –ö–æ–Ω—Ç–µ–Ω—Ç–∞)

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–∞—Ä—Ç–Ω–µ—Ä –≤–∏–¥–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –º–µ–Ω—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
- –ö–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –°—Ç–∞—Ç—É—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è (Pending, Approved, Rejected)

**–®–∞–≥–∏:**
1. –û—Ç–∫—Ä—ã—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π –±–æ—Ç —Å –Ω–æ–≤–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/start`
3. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ –ø–∞—Ä—Ç–Ω–µ—Ä
4. –ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
5. –î–ª—è Influencer –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Ä–µ–∑–∞–Ω–Ω–æ–µ –º–µ–Ω—é

**Worker:** `cloudflare/workers/partner-webhook`
**Handler:** `handleStart`, `showPartnerMainMenu`""",
        "priority": PRIORITY_MAP["P0"],
        "team": "ENG",
        "category": "–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –¢–ï–°–¢–´"
    },
    {
        "id": "TEST-CF-003",
        "title": "[Cloudflare] –¢–µ—Å—Ç: Webhook –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω",
        "description": """**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è webhook secret token
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞
- CORS preflight –∑–∞–ø—Ä–æ—Å—ã

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ó–∞–ø—Ä–æ—Å—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º –ø—Ä–æ—Ö–æ–¥—è—Ç
- –ó–∞–ø—Ä–æ—Å—ã –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è (–µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
- CORS —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–®–∞–≥–∏:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook URL –≤ Telegram
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å —Ç–æ–∫–µ–Ω–æ–º
3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –±–µ–∑ —Ç–æ–∫–µ–Ω–∞
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤ Cloudflare Dashboard

**Worker:** –í—Å–µ webhook workers
**Handler:** `index.js` (main handler)""",
        "priority": PRIORITY_MAP["P0"],
        "team": "ENG",
        "category": "–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨"
    },
    
    # –í–ê–ñ–ù–´–ï (P1) - –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    {
        "id": "TEST-CF-004",
        "title": "[Cloudflare] –¢–µ—Å—Ç: –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –±–æ—Ç - –±–∞–ª–∞–Ω—Å –∏ NPS",
        "description": """**–í–∞–∂–Ω—ã–π —Ç–µ—Å—Ç**

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- Callback "–ú–æ–π –±–∞–ª–∞–Ω—Å"
- NPS —Ä–µ–π—Ç–∏–Ω–≥ (callback `nps_rate_X`)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ callback queries

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ë–∞–ª–∞–Ω—Å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- NPS —Ä–µ–π—Ç–∏–Ω–≥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
- Callback queries –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

**–®–∞–≥–∏:**
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/start` –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º –±–æ—Ç–µ
2. –ù–∞–∂–∞—Ç—å "–ú–æ–π –±–∞–ª–∞–Ω—Å"
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å NPS –∑–∞–ø—Ä–æ—Å (–µ—Å–ª–∏ –µ—Å—Ç—å)
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞

**Worker:** `cloudflare/workers/client-webhook`
**Handler:** `handleBalance`, `handleNpsRating`""",
        "priority": PRIORITY_MAP["P1"],
        "team": "ENG",
        "category": "–û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò"
    },
    {
        "id": "TEST-CF-005",
        "title": "[Cloudflare] –¢–µ—Å—Ç: –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π –±–æ—Ç - –º–µ–Ω—é –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è",
        "description": """**–í–∞–∂–Ω—ã–π —Ç–µ—Å—Ç**

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- –í—Å–µ –∫–Ω–æ–ø–∫–∏ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
- –ü–æ–¥–º–µ–Ω—é (–û–ø–µ—Ä–∞—Ü–∏–∏, –ö–æ–Ω—Ç–µ–Ω—Ç, –ê–Ω–∞–ª–∏—Ç–∏–∫–∞, Revenue Share, –ï—â—ë)
- Callback queries –¥–ª—è –º–µ–Ω—é
- –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∞–∑–∞–¥

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í—Å–µ –∫–Ω–æ–ø–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –º–µ–Ω—é
- Callback queries –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
- –ù–∞–≤–∏–≥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–®–∞–≥–∏:**
1. –í–æ–π—Ç–∏ –≤ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π –±–æ—Ç
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∂–¥—É—é –∫–Ω–æ–ø–∫—É –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–º–µ–Ω—é
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å callback queries –≤ –ª–æ–≥–∞—Ö

**Worker:** `cloudflare/workers/partner-webhook`
**Handler:** `handleMenuButton`, `handleCallback`""",
        "priority": PRIORITY_MAP["P1"],
        "team": "ENG",
        "category": "–û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò"
    },
    {
        "id": "TEST-CF-006",
        "title": "[Cloudflare] –¢–µ—Å—Ç: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Supabase",
        "description": """**–í–∞–∂–Ω—ã–π —Ç–µ—Å—Ç**

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase –∏–∑ Cloudflare Workers
- –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (users, partners)
- –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö (—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ë–î

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ Supabase —Ä–∞–±–æ—Ç–∞—é—Ç
- –î–∞–Ω–Ω—ã–µ —á–∏—Ç–∞—é—Ç—Å—è –∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è gracefully

**–®–∞–≥–∏:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Cloudflare –Ω–∞ –æ—à–∏–±–∫–∏ Supabase
2. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ –ë–î
4. –ü—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ (–Ω–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á, —Å–µ—Ç—å)

**Worker:** –í—Å–µ workers
**Utils:** `cloudflare/utils/supabase.js`""",
        "priority": PRIORITY_MAP["P1"],
        "team": "ENG",
        "category": "–ò–ù–¢–ï–ì–†–ê–¶–ò–ò"
    },
    {
        "id": "TEST-CF-007",
        "title": "[Cloudflare] –¢–µ—Å—Ç: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram API",
        "description": """**–í–∞–∂–Ω—ã–π —Ç–µ—Å—Ç**

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ Telegram API
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞–º–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ callback queries
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ Telegram API

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- Callback queries –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
- –û—à–∏–±–∫–∏ API –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

**–®–∞–≥–∏:**
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É
3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
4. –ù–∞–∂–∞—Ç—å –Ω–∞ –∫–Ω–æ–ø–∫—É
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É callback
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ API

**Worker:** –í—Å–µ workers
**Utils:** `cloudflare/utils/telegram.js`""",
        "priority": PRIORITY_MAP["P1"],
        "team": "ENG",
        "category": "–ò–ù–¢–ï–ì–†–ê–¶–ò–ò"
    },
    
    # –û–ë–´–ß–ù–´–ï (P2) - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    {
        "id": "TEST-CF-008",
        "title": "[Cloudflare] –¢–µ—Å—Ç: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ",
        "description": """**–û–±—ã—á–Ω—ã–π —Ç–µ—Å—Ç**

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –≤ handlers
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- –í–æ–∑–≤—Ä–∞—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö HTTP –æ—Ç–≤–µ—Ç–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ retry –æ—Ç Telegram

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ Cloudflare Dashboard
- Telegram –ø–æ–ª—É—á–∞–µ—Ç 200 OK (—á—Ç–æ–±—ã –Ω–µ retry)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

**–®–∞–≥–∏:**
1. –°–æ–∑–¥–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é —Å –æ—à–∏–±–∫–æ–π (–Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, —Å–µ—Ç—å)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤ Cloudflare Dashboard
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç webhook (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 200 OK)
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

**Worker:** –í—Å–µ workers
**Handler:** Error handling –≤ `index.js`""",
        "priority": PRIORITY_MAP["P2"],
        "team": "ENG",
        "category": "–ù–ê–î–ï–ñ–ù–û–°–¢–¨"
    },
    {
        "id": "TEST-CF-009",
        "title": "[Cloudflare] –¢–µ—Å—Ç: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –∑–∞–¥–µ—Ä–∂–∫–∏",
        "description": """**–û–±—ã—á–Ω—ã–π —Ç–µ—Å—Ç**

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ webhook
- –ó–∞–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Supabase
- –ó–∞–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Telegram API
- Edge network performance

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ < 1 —Å–µ–∫—É–Ω–¥—ã
- –ù–µ—Ç —Ç–∞–π–º–∞—É—Ç–æ–≤
- –ë—ã—Å—Ç—Ä–∞—è —Ä–∞–±–æ—Ç–∞ Edge network

**–®–∞–≥–∏:**
1. –ò–∑–º–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ `/start`
2. –ò–∑–º–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ callback
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ Cloudflare Dashboard
4. –°—Ä–∞–≤–Ω–∏—Ç—å —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–µ–π (Fly.io)

**Worker:** –í—Å–µ workers
**Metrics:** Cloudflare Analytics""",
        "priority": PRIORITY_MAP["P2"],
        "team": "ENG",
        "category": "–ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨"
    },
    {
        "id": "TEST-CF-010",
        "title": "[Cloudflare] –¢–µ—Å—Ç: –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ —Å–µ–∫—Ä–µ—Ç—ã",
        "description": """**–û–±—ã—á–Ω—ã–π —Ç–µ—Å—Ç**

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤—Å–µ—Ö env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–π —Å–µ–∫—Ä–µ—Ç–æ–≤
- FRONTEND_URL —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ Cloudflare Pages
- –í—Å–µ —Ç–æ–∫–µ–Ω—ã –±–æ—Ç–æ–≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã
- –ó–Ω–∞—á–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- –ù–µ—Ç –æ—à–∏–±–æ–∫ "undefined" –≤ –ª–æ–≥–∞—Ö

**–®–∞–≥–∏:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ Cloudflare Dashboard
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ "undefined"
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å FRONTEND_URL (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å Cloudflare Pages)
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏

**Worker:** –í—Å–µ workers
**Config:** Cloudflare Workers Secrets""",
        "priority": PRIORITY_MAP["P2"],
        "team": "ENG",
        "category": "–ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø"
    },
    {
        "id": "TEST-CF-011",
        "title": "[Cloudflare] –¢–µ—Å—Ç: –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –∏ –ø–∞—Ä—Ç–Ω–µ—Ä—ã",
        "description": """**–û–±—ã—á–Ω—ã–π —Ç–µ—Å—Ç**

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ `/start partner_123`
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ referral_source
- –°–≤—è–∑—å –∫–ª–∏–µ–Ω—Ç–∞ —Å –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- Referral source —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
- –ö–ª–∏–µ–Ω—Ç —Å–≤—è–∑–∞–Ω —Å –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

**–®–∞–≥–∏:**
1. –°–æ–∑–¥–∞—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –ø–∞—Ä—Ç–Ω–µ—Ä–∞
2. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫—É
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `users.referral_source` –≤ –ë–î
4. –û—Ç–∫—Ä—ã—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞

**Worker:** `cloudflare/workers/client-webhook`
**Handler:** `handleStart`""",
        "priority": PRIORITY_MAP["P2"],
        "team": "ENG",
        "category": "–†–ï–§–ï–†–ê–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê"
    },
    {
        "id": "TEST-CF-012",
        "title": "[Cloudflare] –¢–µ—Å—Ç: –ê–¥–º–∏–Ω-–±–æ—Ç (–µ—Å–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω)",
        "description": """**–û–±—ã—á–Ω—ã–π —Ç–µ—Å—Ç**

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- –†–∞–±–æ—Ç–∞ –∞–¥–º–∏–Ω-–±–æ—Ç–∞ –Ω–∞ Cloudflare
- –ö–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∞
- –û–¥–æ–±—Ä–µ–Ω–∏–µ/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
- –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–µ–π

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ê–¥–º–∏–Ω-–±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –¥–æ—Å—Ç—É–ø–Ω—ã
- –ó–∞—è–≤–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

**–®–∞–≥–∏:**
1. –û—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω-–±–æ—Ç
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã
3. –û–¥–æ–±—Ä–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞—è–≤–∫—É
4. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –Ω–æ–≤–æ—Å—Ç—å

**Worker:** `cloudflare/workers/admin-webhook` (–µ—Å–ª–∏ –µ—Å—Ç—å)
**Status:** TODO - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é""",
        "priority": PRIORITY_MAP["P2"],
        "team": "ENG",
        "category": "–ê–î–ú–ò–ù-–ë–û–¢"
    },
    {
        "id": "TEST-CF-013",
        "title": "[Cloudflare] –¢–µ—Å—Ç: REST API Worker",
        "description": """**–û–±—ã—á–Ω—ã–π —Ç–µ—Å—Ç**

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- –†–∞–±–æ—Ç–∞ REST API –Ω–∞ Cloudflare
- –í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º
- –û–±—Ä–∞–±–æ—Ç–∫–∞ CORS

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- API –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã
- –í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ –º–æ–∂–µ—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ API

**–®–∞–≥–∏:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API URL
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å CORS headers
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º

**Worker:** `cloudflare/workers/api`
**Status:** TODO - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é""",
        "priority": PRIORITY_MAP["P2"],
        "team": "ENG",
        "category": "REST API"
    },
]

# –ó–∞–¥–∞—á–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (—Å—Ç–∞—Ä—ã–µ/–Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ)
TASKS_TO_DELETE_PATTERNS = [
    # –°—Ç–∞—Ä—ã–µ –∑–∞–¥–∞—á–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–æ –º–∏–≥—Ä–∞—Ü–∏–∏)
    "TC-",
    "PREFLIGHT-",
    # –°—Ç–∞—Ä—ã–µ –∑–∞–¥–∞—á–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ (—É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã)
    "–ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ Cloudflare",
    "CLOUDFLARE_MIGRATION",
    # –ó–∞–¥–∞—á–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å Fly.io (—Å—Ç–∞—Ä–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
    "Fly.io",
    "long polling",
    # –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∑–∞–¥–∞—á–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    "TEST-",  # –°—Ç–∞—Ä—ã–µ —Ç–µ—Å—Ç—ã (–Ω–æ –Ω–µ TEST-CF-)
]


def get_linear_api_key():
    """–ü–æ–ª—É—á–∏—Ç—å API –∫–ª—é—á Linear"""
    api_key = os.getenv("LINEAR_API_KEY")
    if not api_key:
        raise ValueError("LINEAR_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è. –î–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ .env —Ñ–∞–π–ª.")
    return api_key


def get_all_issues(team_id: Optional[str] = None) -> List[Dict]:
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ –∏–∑ Linear"""
    api_key = get_linear_api_key()
    headers = {
        "Authorization": api_key,
        "Content-Type": "application/json"
    }
    
    # GraphQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
    query = """
    query($after: String, $teamId: ID) {
        issues(
            first: 100,
            after: $after,
            filter: { team: { id: { eq: $teamId } } }
        ) {
            nodes {
                id
                identifier
                title
                description
                state {
                    name
                }
                priority
                createdAt
                updatedAt
            }
            pageInfo {
                hasNextPage
                endCursor
            }
        }
    }
    """
    
    all_issues = []
    cursor = None
    
    while True:
        variables = {"after": cursor}
        if team_id:
            variables["teamId"] = team_id
        
        try:
            response = requests.post(
                LINEAR_API_URL,
                headers=headers,
                json={"query": query, "variables": variables}
            )
            
            if response.status_code != 200:
                print(f"‚ùå –û—à–∏–±–∫–∞ HTTP: {response.status_code}")
                print(response.text)
                break
            
            data = response.json()
            
            if "errors" in data:
                print(f"‚ùå –û—à–∏–±–∫–∏ GraphQL: {data['errors']}")
                break
            
            issues = data["data"]["issues"]["nodes"]
            all_issues.extend(issues)
            
            page_info = data["data"]["issues"]["pageInfo"]
            if not page_info["hasNextPage"]:
                break
            
            cursor = page_info["endCursor"]
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–¥–∞—á: {e}")
            break
    
    return all_issues


def delete_issue(issue_id: str) -> bool:
    """–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É –∏–∑ Linear"""
    api_key = get_linear_api_key()
    headers = {
        "Authorization": api_key,
        "Content-Type": "application/json"
    }
    
    mutation = """
    mutation($issueId: String!) {
        issueDelete(id: $issueId) {
            success
        }
    }
    """
    
    try:
        response = requests.post(
            LINEAR_API_URL,
            headers=headers,
            json={"query": mutation, "variables": {"issueId": issue_id}}
        )
        
        if response.status_code != 200:
            return False
        
        data = response.json()
        
        if "errors" in data:
            return False
        
        return data["data"]["issueDelete"]["success"]
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ {issue_id}: {e}")
        return False


def should_delete_task(title: str, description: str = "") -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É"""
    text = f"{title} {description}".lower()
    
    for pattern in TASKS_TO_DELETE_PATTERNS:
        if pattern.lower() in text:
            # –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª—è–µ–º –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ TEST-CF-
            if pattern.lower() == "test-" and "test-cf-" in text:
                continue
            return True
    
    return False


def main():
    import argparse
    
    parser = argparse.ArgumentParser(
        description='–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞—á –≤ Linear –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Cloudflare'
    )
    parser.add_argument(
        '--dry-run',
        action='store_true',
        help='–ü–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ, –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π'
    )
    parser.add_argument(
        '--cleanup-only',
        action='store_true',
        help='–¢–æ–ª—å–∫–æ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞–¥–∞—á–∏'
    )
    parser.add_argument(
        '--create-only',
        action='store_true',
        help='–¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏'
    )
    parser.add_argument(
        '--team',
        type=str,
        help='–ö–ª—é—á –∫–æ–º–∞–Ω–¥—ã –≤ Linear (–Ω–∞–ø—Ä–∏–º–µ—Ä, ENG, QA). –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–≤–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è'
    )
    parser.add_argument(
        '--yes',
        action='store_true',
        help='–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞'
    )
    
    args = parser.parse_args()
    
    print("üöÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏ –≤ Linear –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Cloudflare\n")
    print("=" * 60)
    
    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–∞–Ω–¥—ã
    teams_result = get_teams()
    if not teams_result.get("success"):
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥: {teams_result.get('error')}")
        return
    
    teams = {team['key']: team for team in teams_result['teams']}
    print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ –∫–æ–º–∞–Ω–¥: {list(teams.keys())}\n")
    
    # –í—ã–±–∏—Ä–∞–µ–º –∫–æ–º–∞–Ω–¥—É
    team_key = args.team
    if team_key and team_key not in teams:
        print(f"‚ö†Ô∏è  –ö–æ–º–∞–Ω–¥–∞ {team_key} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é")
        team_key = None
    
    if not team_key:
        team_key = list(teams.keys())[0] if teams else None
    
    if not team_key:
        print("‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥")
        return
    
    print(f"üìå –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞: {team_key} ({teams[team_key]['name']})\n")
    
    # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞—á
    if not args.create_only:
        print("üìã –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–¥–∞—á –∏–∑ Linear...")
        all_issues = get_all_issues()
        print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ –∑–∞–¥–∞—á: {len(all_issues)}\n")
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
        tasks_to_delete = []
        for issue in all_issues:
            if should_delete_task(issue['title'], issue.get('description', '')):
                tasks_to_delete.append(issue)
        
        print(f"üóëÔ∏è  –ù–∞–π–¥–µ–Ω–æ –∑–∞–¥–∞—á –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: {len(tasks_to_delete)}\n")
        
        if tasks_to_delete:
            print("–ó–∞–¥–∞—á–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:")
            for issue in tasks_to_delete:
                state = issue['state']['name'] if issue.get('state') else 'Unknown'
                print(f"   - {issue['identifier']}: {issue['title']} (–°—Ç–∞—Ç—É—Å: {state})")
            print()
        
        if not args.dry_run and tasks_to_delete:
            should_delete = args.cleanup_only or args.yes
            if not should_delete:
                try:
                    should_delete = input("–£–¥–∞–ª–∏—Ç—å —ç—Ç–∏ –∑–∞–¥–∞—á–∏? (y/n): ").lower() == 'y'
                except EOFError:
                    # –ù–µ–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ
                    print("‚è≠Ô∏è  –ù–µ–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ --yes –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)")
                    should_delete = False
            
            if should_delete:
                print("\nüóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á...")
                deleted_count = 0
                for issue in tasks_to_delete:
                    if delete_issue(issue['id']):
                        print(f"   ‚úÖ –£–¥–∞–ª–µ–Ω–æ: {issue['identifier']}")
                        deleted_count += 1
                        time.sleep(0.5)  # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                    else:
                        print(f"   ‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: {issue['identifier']}")
                
                print(f"\n‚úÖ –£–¥–∞–ª–µ–Ω–æ –∑–∞–¥–∞—á: {deleted_count}/{len(tasks_to_delete)}")
            else:
                print("‚è≠Ô∏è  –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ")
        elif args.dry_run:
            print("üîç DRY-RUN: –ó–∞–¥–∞—á–∏ –ù–ï –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–µ–∑ --dry-run –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è)")
    
    print()
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
    if not args.cleanup_only:
        print(f"üìù –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ({len(TESTING_TASKS)} –∑–∞–¥–∞—á)...\n")
        
        if args.dry_run:
            print("üîç DRY-RUN: –ó–∞–¥–∞—á–∏ –ù–ï –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–µ–∑ --dry-run –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è)\n")
            print("–ó–∞–¥–∞—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã:")
            for task in TESTING_TASKS:
                priority_name = {1: "Urgent", 2: "High", 3: "Medium", 4: "Low"}.get(task['priority'], "Unknown")
                print(f"   - [{priority_name}] {task['title']}")
        else:
            created_count = 0
            errors_count = 0
            
            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º
            by_priority = {1: [], 2: [], 3: [], 4: []}
            for task in TESTING_TASKS:
                priority = task['priority']
                if priority in by_priority:
                    by_priority[priority].append(task)
            
            for priority_label, tasks in [
                ("P0 (Urgent - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ)", by_priority[1]),
                ("P1 (High - –í–∞–∂–Ω—ã–µ)", by_priority[2]),
                ("P2 (Medium - –û–±—ã—á–Ω—ã–µ)", by_priority[3]),
                ("P3 (Low - –ù–∏–∑–∫–∏–µ)", by_priority[4])
            ]:
                if tasks:
                    print(f"\n   {priority_label}:")
                    for task in tasks:
                        result = create_linear_task(
                            title=task['title'],
                            description=task['description'],
                            team_key=team_key,
                            priority=task['priority']
                        )
                        
                        if result['success']:
                            print(f"      ‚úÖ {result['identifier']}: {task['title']}")
                            created_count += 1
                        else:
                            error_msg = result.get('error', 'Unknown error')
                            if 'already exists' in error_msg.lower() or 'duplicate' in error_msg.lower():
                                print(f"      ‚è≠Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ (–¥—É–±–ª–∏–∫–∞—Ç): {task['title']}")
                            else:
                                print(f"      ‚ùå –û—à–∏–±–∫–∞: {task['title']}")
                                print(f"         {error_msg}")
                                errors_count += 1
                        
                        time.sleep(0.5)  # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
            
            print("\n" + "=" * 60)
            print("üìä –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:")
            print(f"   ‚úÖ –°–æ–∑–¥–∞–Ω–æ –∑–∞–¥–∞—á: {created_count}")
            print(f"   ‚ùå –û—à–∏–±–æ–∫: {errors_count}")
            print(f"   üìã –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {len(TESTING_TASKS)}")
            print("=" * 60)
            
            if created_count > 0:
                print("\n‚úÖ –ó–∞–¥–∞—á–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã –≤ Linear!")
                print("   –û—Ç–∫—Ä–æ–π—Ç–µ Linear.app –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á")
    
    print("\nüéâ –ì–æ—Ç–æ–≤–æ!")


if __name__ == "__main__":
    main()

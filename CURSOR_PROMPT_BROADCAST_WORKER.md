# –ó–∞–¥–∞—á–∞: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—ã–±–æ—Ä –∞—É–¥–∏—Ç–æ—Ä–∏–∏ —Ä–∞—Å—Å—ã–ª–∫–∏ –≤ Cloudflare Worker

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –±–æ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∫–∞–∫ **Cloudflare Worker** –≤ `cloudflare/workers/partner-webhook/`.
–ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã:
- `partner.js` ‚Äî –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –±–æ—Ç–∞ (4400+ —Å—Ç—Ä–æ–∫)
- `supabase.js` ‚Äî —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Supabase (REST API —á–µ—Ä–µ–∑ `supabaseRequest`)
- `telegram.js` ‚Äî —Ö–µ–ª–ø–µ—Ä—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Telegram

–°–æ—Å—Ç–æ—è–Ω–∏–µ (multi-step flow) —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Supabase —á–µ—Ä–µ–∑ `getBotState` / `setBotState` / `clearBotState` / `updateBotStateData` (–∏–∑ `supabase.js`). –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–æ–ª–µ `data` –æ–±—ä–µ–∫—Ç–∞ bot_state.

---

## –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

### 1. `supabase.js` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å 4 —Ñ—É–Ω–∫—Ü–∏–∏

**a) `getPartnerClientChatIdsForBroadcast(env, partnerChatId, limit = 500)`**
–ö–ª–∏–µ–Ω—Ç—ã, –ø—Ä–∏—à–µ–¥—à–∏–µ –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ –ø–∞—Ä—Ç–Ω—ë—Ä–∞.
```js
// –ó–∞–ø—Ä–æ—Å: users?referral_source=eq.partner_{partnerChatId}&select=chat_id&limit={limit*3}
// –§–∏–ª—å—Ç—Ä: –∏—Å–∫–ª—é—á–∏—Ç—å VIA_PARTNER_*, —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–≤—ã–µ chat_id, –±–µ–∑ –¥—É–±–ª–µ–π
// –í–µ—Ä–Ω—É—Ç—å: string[]
```

**b) `getPartnerClientChatIdsByTransactions(env, partnerChatId, limit = 500)`**
–ö–ª–∏–µ–Ω—Ç—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å —ç—Ç–∏–º –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º.
```js
// –ó–∞–ø—Ä–æ—Å: transactions?partner_chat_id=eq.{partnerChatId}&select=client_chat_id&limit={limit*3}
// –§–∏–ª—å—Ç—Ä: –∏—Å–∫–ª—é—á–∏—Ç—å VIA_PARTNER_*, —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–≤—ã–µ chat_id, –±–µ–∑ –¥—É–±–ª–µ–π
// –í–µ—Ä–Ω—É—Ç—å: string[]
```

**c) `getPartnerClientChatIdsCombined(env, partnerChatId, limit = 500)`**
–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–≤—É—Ö —Å–ø–∏—Å–∫–æ–≤ –≤—ã—à–µ –±–µ–∑ –¥—É–±–ª–µ–π (Set union), –æ–±—Ä–µ–∑–∞—Ç—å –¥–æ limit.
```js
// –í–µ—Ä–Ω—É—Ç—å: string[]
```

**d) `canPartnerRunBroadcast(env, partnerChatId, maxPerDay = 1)`**
–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞: –Ω–µ –±–æ–ª–µ–µ `maxPerDay` —Ä–∞—Å—Å—ã–ª–æ–∫ –≤ —Å—É—Ç–∫–∏.
```js
// –ó–∞–ø—Ä–æ—Å: partner_broadcast_campaigns?partner_chat_id=eq.{partnerChatId}&created_at=gte.{startOfToday}&select=id&limit=5
// –í–µ—Ä–Ω—É—Ç—å: boolean
```

**e) `createBroadcastCampaign(env, partnerChatId, templateId, recipientCount, audienceType = null)`**
–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –∫–∞–º–ø–∞–Ω–∏–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `partner_broadcast_campaigns`.
```js
// INSERT: { partner_chat_id, template_id, recipient_count, sent_count: 0, status: 'running', audience_type (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω) }
// –í–µ—Ä–Ω—É—Ç—å: id (number) –∏–ª–∏ null
```

---

### 2. `partner.js` ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å `handleInviteClient`

–°–µ–π—á–∞—Å —Ñ—É–Ω–∫—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É. –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É —Ä–∞—Å—Å—ã–ª–∫–∏:

```
üë• –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞

–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π: https://t.me/BOT?start=partner_ID

[üì¢ –†–∞–∑–æ—Å–ª–∞—Ç—å –≤—Å–µ–º –º–æ–∏–º –∫–ª–∏–µ–Ω—Ç–∞–º]  ‚Üê –Ω–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ (callback: invite_broadcast_start)
```

---

### 3. `partner.js` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É 5 –Ω–æ–≤—ã—Ö callback –≤ `handleCallback`

#### `invite_broadcast_start`
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `canPartnerRunBroadcast` ‚Äî –µ—Å–ª–∏ false, –æ—Ç–ø—Ä–∞–≤–∏—Ç—å: "‚ö†Ô∏è –†–∞—Å—Å—ã–ª–∫–∞ –≤–æ–∑–º–æ–∂–Ω–∞ –Ω–µ —á–∞—â–µ –æ–¥–Ω–æ–≥–æ —Ä–∞–∑–∞ –≤ —Å—É—Ç–∫–∏."
2. –ï—Å–ª–∏ OK ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤—ã–±–æ—Ä–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–∏:

```
üì¢ –í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏—Ç–æ—Ä–∏—é –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏:

‚Ä¢ –ü–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ ‚Äî –∫–ª–∏–µ–Ω—Ç—ã, –ø—Ä–∏—à–µ–¥—à–∏–µ –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ
‚Ä¢ –ü–æ –≤–∏–∑–∏—Ç–∞–º ‚Äî –∫–ª–∏–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞–ª–∏ –ø–æ–∫—É–ø–∫–∏
‚Ä¢ –í—Å–µ –º–æ–∏ –∫–ª–∏–µ–Ω—Ç—ã ‚Äî –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤

[üë• –ü–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ]   callback: invite_broadcast_audience_referral
[üõí –ü–æ –≤–∏–∑–∏—Ç–∞–º]               callback: invite_broadcast_audience_transactions
[üìã –í—Å–µ –º–æ–∏ –∫–ª–∏–µ–Ω—Ç—ã]          callback: invite_broadcast_audience_combined
[‚ùå –û—Ç–º–µ–Ω–∞]                    callback: invite_broadcast_cancel
```

#### `invite_broadcast_audience_referral` / `_transactions` / `_combined`
1. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–µ–π –∏–∑ supabase.js.
2. –ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤.
3. –ï—Å–ª–∏ –µ—Å—Ç—å ‚Äî —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç —à–∞–±–ª–æ–Ω–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ (—Å–º. –Ω–∏–∂–µ).
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ bot_state —á–µ—Ä–µ–∑ `setBotState(env, chatId, 'broadcast_preview', { recipients: [...], audienceType, partnerId: chatId })`.
5. –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é —Å–æ–æ–±—â–µ–Ω–∏—è + –∫–Ω–æ–ø–∫–∏:

```
[‚úÖ –†–∞–∑–æ—Å–ª–∞—Ç—å N –∫–ª–∏–µ–Ω—Ç–∞–º]   callback: invite_broadcast_confirm
[‚ùå –û—Ç–º–µ–Ω–∞]                  callback: invite_broadcast_cancel
```

**–®–∞–±–ª–æ–Ω —Ä–∞—Å—Å—ã–ª–∫–∏** (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `getOrCreateReferralCode` –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ chatId):
```
–ü—Ä–∏–≤–µ—Ç! –ü–∞—Ä—Ç–Ω—ë—Ä –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç –≤–∞—Å –≤ –ø—Ä–æ–≥—Ä–∞–º–º—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏.

–ù–∞–∫–∞–ø–ª–∏–≤–∞–π—Ç–µ –±–∞–ª–ª—ã, –ø–æ–ª—É—á–∞–π—Ç–µ —Å–∫–∏–¥–∫–∏ –∏ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∏ –ø–æ–ª—É—á–∏—Ç–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –±–∞–ª–ª—ã:
https://t.me/{BOT_USERNAME}?start=partner_{chatId}
```

#### `invite_broadcast_confirm`
1. –ó–∞–≥—Ä—É–∑–∏—Ç—å state —á–µ—Ä–µ–∑ `getBotState`. –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ.
2. `createBroadcastCampaign(env, partnerId, 'referral_program', recipients.length, audienceType)`.
3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∂–¥–æ–º—É –ø–æ–ª—É—á–∞—Ç–µ–ª—é (–∏—Å–ø–æ–ª—å–∑—É—è `sendTelegramMessage` —Å `env.TOKEN_CLIENT` ‚Äî –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–º —Ç–æ–∫–µ–Ω–æ–º).
4. –ü–æ—Å–ª–µ —Ä–∞—Å—Å—ã–ª–∫–∏ ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å state —á–µ—Ä–µ–∑ `clearBotState`.
5. –û—Ç—á—ë—Ç: "‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: N —Å–æ–æ–±—â–µ–Ω–∏–π."

#### `invite_broadcast_cancel`
1. –û—á–∏—Å—Ç–∏—Ç—å state —á–µ—Ä–µ–∑ `clearBotState`.
2. –°–æ–æ–±—â–µ–Ω–∏–µ: "‚ùå –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞."

---

### 4. `partner.js` ‚Äî –≤ `routeUpdate` –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ callback –≤ –¥–∏—Å–ø–µ—Ç—á–µ—Ä

–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `handleCallback` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö callback_data.

---

## –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏

- **–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ç–æ–∫–µ–Ω**: —Ä–∞—Å—Å—ã–ª–∫—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —á–µ—Ä–µ–∑ `env.TOKEN_CLIENT` (–Ω–µ `env.TOKEN_PARTNER`), —Ç.–∫. –ø–æ–ª—É—á–∞—Ç–µ–ª–∏ ‚Äî –∫–ª–∏–µ–Ω—Ç—ã –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –±–æ—Ç–∞.
- **–ë–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π**: –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–¥–Ω–æ–º—É –∫–ª–∏–µ–Ω—Ç—É –Ω–µ –¥–æ–ª–∂–Ω–∞ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É –æ—Å—Ç–∞–ª—å–Ω—ã–º (try/catch –≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞).
- **–õ–æ–≥**: —Å—á–∏—Ç–∞—Ç—å `sentCount` –∏ `errorCount`, –æ—Ç—Ä–∞–∑–∏—Ç—å –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –æ—Ç—á—ë—Ç–µ.
- **–ó–∞–¥–µ—Ä–∂–∫–∞**: –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏ –¥–æ–±–∞–≤–∏—Ç—å `await new Promise(r => setTimeout(r, 50))` —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã Telegram API (30 msg/sec).
- –í—Å–µ –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ supabase.js —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ `export async function`.
- –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ `partner.js` –∏–∑ `./supabase.js`.

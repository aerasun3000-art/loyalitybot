# üí∞ –†–£–ö–û–í–û–î–°–¢–í–û –ü–û –ù–ê–°–¢–†–û–ô–ö–ï –†–ê–°–ß–ï–¢–ê –î–û–•–û–î–ê –ü–ê–†–¢–ù–ï–†–ê

**–î–∞—Ç–∞:** –ù–æ—è–±—Ä—å 2025  
**–§–∞–π–ª:** `bot.py` ‚Üí —Ñ—É–Ω–∫—Ü–∏—è `update_partner_stats_on_transaction()`

---

## üìã –û–ë–ó–û–†

–§—É–Ω–∫—Ü–∏—è `update_partner_stats_on_transaction()` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ª–∏—á–Ω—ã–π –¥–æ—Ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. –≠—Ç–æ—Ç –¥–æ—Ö–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ PV (Partner Value)
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è Revenue Share
- –ü—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–∏–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ Revenue Share

---

## ‚öôÔ∏è –¢–ï–ö–£–©–ê–Ø –õ–û–ì–ò–ö–ê

**–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:** –ü–∞—Ä—Ç–Ω–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —É–∫–∞–∑–∞–Ω–Ω—ã–π –≤ –ø–æ–ª–µ `commission_rate` —Ç–∞–±–ª–∏—Ü—ã `partners` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10%).

```python
commission_rate = float(partner.data.get('commission_rate', 10.0))
income_from_transaction = transaction_amount * (commission_rate / 100.0)
```

---

## üîß –í–ê–†–ò–ê–ù–¢–´ –ù–ê–°–¢–†–û–ô–ö–ò

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å commission_rate –∏–∑ –±–∞–∑—ã (–¢–ï–ö–£–©–ò–ô)

**–ü–ª—é—Å—ã:**
- –ì–∏–±–∫–æ—Å—Ç—å: –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ
- –ü—Ä–æ—Å—Ç–æ—Ç–∞: –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ–¥–∞

**–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
```sql
-- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–º–∏—Å—Å–∏—é 15% –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞
UPDATE partners 
SET commission_rate = 15.0 
WHERE chat_id = '123456789';
```

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è + –ø—Ä–æ—Ü–µ–Ω—Ç

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è –∑–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
- –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞

**–ö–æ–¥:**
```python
fixed_commission = 5.0  # –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è $5
percentage_commission = transaction_amount * 0.10  # 10% –æ—Ç —Å—É–º–º—ã
income_from_transaction = fixed_commission + percentage_commission
```

**–ü—Ä–∏–º–µ—Ä:**
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è $100 ‚Üí –¥–æ—Ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ = $5 + $10 = $15
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è $50 ‚Üí –¥–æ—Ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ = $5 + $5 = $10

---

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –ï—Å–ª–∏ —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —É—Å–ª—É–≥ –∏–º–µ—é—Ç —Ä–∞–∑–Ω—É—é –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Å—Ç–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–¥–∞–∂–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —É—Å–ª—É–≥

**–ö–æ–¥:**
```python
if transaction_type == 'premium':
    income_from_transaction = transaction_amount * 0.20  # 20% –¥–ª—è –ø—Ä–µ–º–∏—É–º
elif transaction_type == 'standard':
    income_from_transaction = transaction_amount * 0.10  # 10% –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö
else:
    income_from_transaction = transaction_amount * 0.05  # 5% –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
```

**–ö–∞–∫ –ø–µ—Ä–µ–¥–∞—Ç—å transaction_type:**
```python
# –í —Ñ—É–Ω–∫—Ü–∏–∏ complete_partner_transaction()
update_partner_stats_on_transaction(
    partner_chat_id=partner_chat_id,
    transaction_amount=amount,
    transaction_type='premium'  # –∏–ª–∏ 'standard', –∏–ª–∏ –¥—Ä—É–≥–æ–π —Ç–∏–ø
)
```

---

### –í–∞—Ä–∏–∞–Ω—Ç 4: –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∞

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –ï—Å–ª–∏ —Ä–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–∞ –∏–º–µ—é—Ç —Ä–∞–∑–Ω—ã–µ –∫–æ–º–∏—Å—Å–∏–∏
- –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Å—Ç–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–æ—Å—Ç –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤

**–ö–æ–¥:**
```python
partner_type = partner.data.get('partner_type', 'partner')
if partner_type == 'master':
    income_from_transaction = transaction_amount * 0.15  # 15% –¥–ª—è –º–∞—Å—Ç–µ—Ä-–ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
elif partner_type == 'regional':
    income_from_transaction = transaction_amount * 0.12  # 12% –¥–ª—è —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã—Ö
else:
    income_from_transaction = transaction_amount * 0.10  # 10% –¥–ª—è –æ–±—ã—á–Ω—ã—Ö
```

---

### –í–∞—Ä–∏–∞–Ω—Ç 5: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ —Å–ª–æ–∂–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
- –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –º–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≥–∏–±–∫–æ—Å—Ç—å

**–ö–æ–¥:**
```python
# –ë–∞–∑–æ–≤–∞—è –∫–æ–º–∏—Å—Å–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
partner_type = partner.data.get('partner_type', 'partner')
base_rate = {
    'master': 0.15,
    'regional': 0.12,
    'partner': 0.10
}.get(partner_type, 0.10)

# –ë–æ–Ω—É—Å –∑–∞ —Ç–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
transaction_bonus = {
    'premium': 0.05,  # +5% –∑–∞ –ø—Ä–µ–º–∏—É–º —É—Å–ª—É–≥–∏
    'standard': 0.0,
    'basic': -0.02   # -2% –∑–∞ –±–∞–∑–æ–≤—ã–µ —É—Å–ª—É–≥–∏
}.get(transaction_type, 0.0)

# –§–∏–Ω–∞–ª—å–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è
final_rate = base_rate + transaction_bonus
income_from_transaction = transaction_amount * final_rate

# –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
min_commission = 2.0
if income_from_transaction < min_commission:
    income_from_transaction = min_commission
```

---

## üìä –ü–†–ò–ú–ï–†–´ –†–ê–°–ß–ï–¢–û–í

### –ü—Ä–∏–º–µ—Ä 1: –ü—Ä–æ—Å—Ç–æ–π –ø—Ä–æ—Ü–µ–Ω—Ç (—Ç–µ–∫—É—â–∏–π)
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: $100
- commission_rate: 10%
- –î–æ—Ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞: $10

### –ü—Ä–∏–º–µ—Ä 2: –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è + –ø—Ä–æ—Ü–µ–Ω—Ç
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: $100
- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è: $5
- –ü—Ä–æ—Ü–µ–Ω—Ç: 10% = $10
- –î–æ—Ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞: $15

### –ü—Ä–∏–º–µ—Ä 3: –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: $100
- –¢–∏–ø: premium
- –ö–æ–º–∏—Å—Å–∏—è: 20%
- –î–æ—Ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞: $20

---

## üîÑ –ö–ê–ö –ò–ó–ú–ï–ù–ò–¢–¨ –õ–û–ì–ò–ö–£

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `bot.py`
2. –ù–∞–π–¥–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `update_partner_stats_on_transaction()` (—Å—Ç—Ä–æ–∫–∞ ~897)
3. –ù–∞–π–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π `# –õ–û–ì–ò–ö–ê –†–ê–°–ß–ï–¢–ê –î–û–•–û–î–ê –ü–ê–†–¢–ù–ï–†–ê`
4. –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –Ω—É–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª
6. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç

---

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í—Å–µ–≥–¥–∞ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–æ–≤—É—é –ª–æ–≥–∏–∫—É –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–æ–º
2. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –Ω–µ –ª–æ–º–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–∞—Å—á–µ—Ç—ã
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –ò–∑–±–µ–≥–∞–π—Ç–µ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á–µ—Ç–∞
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –î–æ–±–∞–≤—å—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:
   ```python
   logger.info(f"–†–∞—Å—á–µ—Ç –¥–æ—Ö–æ–¥–∞ –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞ {partner_chat_id}: "
               f"—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è=${transaction_amount}, –¥–æ—Ö–æ–¥=${income_from_transaction}")
   ```

---

## üìù –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

1. **–ù–∞—á–Ω–∏—Ç–µ —Å –ø—Ä–æ—Å—Ç–æ–≥–æ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç 1 (commission_rate –∏–∑ –ë–î)
2. **–î–æ–±–∞–≤–ª—è–π—Ç–µ —Å–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ:** –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–º –≤–∞—Ä–∏–∞–Ω—Ç–∞–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
3. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:** –ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ, –ø–æ—á–µ–º—É –≤—ã–±—Ä–∞–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É
4. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:** –°–ª–µ–¥–∏—Ç–µ –∑–∞ —Ç–µ–º, –∫–∞–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–ª–∏—è—é—Ç –Ω–∞ –¥–æ—Ö–æ–¥—ã –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤

---

## üÜò –ü–û–î–î–ï–†–ñ–ö–ê

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±–æ—Ç–∞: `tail -f bot_output.log`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ: `SELECT * FROM partners WHERE chat_id = '...'`
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏: `python3 check_mlm_database.py`

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** –ù–æ—è–±—Ä—å 2025  
**–í–µ—Ä—Å–∏—è:** 1.0
















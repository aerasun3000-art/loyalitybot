# üìã –¢–ó: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–º–∏—Å—Å–∏–π (–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è MLM + B2B Deal)

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-01-XX  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

---

## üéØ –¶–µ–ª—å

–í–Ω–µ–¥—Ä–∏—Ç—å –≥–∏–±–∫—É—é —Å–∏—Å—Ç–µ–º—É —Ä–∞—Å—á–µ—Ç–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–º–∏—Å—Å–∏–π —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–≤—É—Ö —Ä–µ–∂–∏–º–æ–≤:
1. **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è MLM –ª–æ–≥–∏–∫–∞** (3 —É—Ä–æ–≤–Ω—è: 5%/5%/5%)
2. **B2B Deal –ª–æ–≥–∏–∫–∞** (–ø—Ä—è–º–∞—è —Å–¥–µ–ª–∫–∞ –º–µ–∂–¥—É –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º–∏: 70%/30%, –±–µ–∑ MLM)

---

## üìä –û–ø–∏—Å–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏

### 1. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ (MLM)

**–ö–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è:** –ï—Å–ª–∏ —É –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –ù–ï–¢ –∞–∫—Ç–∏–≤–Ω–æ–π B2B —Å–¥–µ–ª–∫–∏ –º–µ–∂–¥—É –ø—Ä–æ–¥–∞–≤—Ü–æ–º –∏ –µ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–º.

**–§–æ—Ä–º—É–ª–∞:**
```
1. –ö–æ–º–∏—Å—Å–∏–æ–Ω–Ω—ã–π —Ñ–æ–Ω–¥ = –°—É–º–º–∞_—á–µ–∫–∞ √ó partner.base_reward_percent
   (–≥–¥–µ base_reward_percent - –ø—Ä–æ—Ü–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–¥–∞–≤–µ—Ü –æ—Ç–¥–∞–µ—Ç –≤ –∫–æ–º–∏—Å—Å–∏–æ–Ω–Ω—ã–π —Ñ–æ–Ω–¥, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5%)

2. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ–Ω–¥–∞:
   - L1 (–ø—Ä—è–º–æ–π —Ä–µ—Ñ–µ—Ä–µ—Ä): 5% –æ—Ç —Ñ–æ–Ω–¥–∞
   - L2 (—Ä–µ—Ñ–µ—Ä–µ—Ä —Ä–µ—Ñ–µ—Ä–µ—Ä–∞): 5% –æ—Ç —Ñ–æ–Ω–¥–∞
   - L3 (—Ä–µ—Ñ–µ—Ä–µ—Ä —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞): 5% –æ—Ç —Ñ–æ–Ω–¥–∞
   - –°–∏—Å—Ç–µ–º–∞: 85% –æ—Ç —Ñ–æ–Ω–¥–∞
```

**–ü—Ä–∏–º–µ—Ä:**
- –ß–µ–∫: 10 000 —Ä—É–±
- `base_reward_percent` –ø—Ä–æ–¥–∞–≤—Ü–∞: 5%
- –§–æ–Ω–¥: 10 000 √ó 0.05 = **500 —Ä—É–±**
- L1 –ø–æ–ª—É—á–∞–µ—Ç: 500 √ó 0.05 = **25 —Ä—É–±**
- L2 –ø–æ–ª—É—á–∞–µ—Ç: 500 √ó 0.05 = **25 —Ä—É–±**
- L3 –ø–æ–ª—É—á–∞–µ—Ç: 500 √ó 0.05 = **25 —Ä—É–±**
- –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª—É—á–∞–µ—Ç: 500 √ó 0.85 = **425 —Ä—É–±**

---

### 2. B2B Deal –ª–æ–≥–∏–∫–∞ (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è)

**–ö–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è:** –ï—Å–ª–∏ —É –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –ï–°–¢–¨ –∞–∫—Ç–∏–≤–Ω–∞—è B2B —Å–¥–µ–ª–∫–∞ –º–µ–∂–¥—É –ø—Ä–æ–¥–∞–≤—Ü–æ–º –∏ –µ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–º (L1 —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–º).

**–§–æ—Ä–º—É–ª–∞:**
```
1. –ö–æ–º–∏—Å—Å–∏–æ–Ω–Ω—ã–π —Ñ–æ–Ω–¥ = –°—É–º–º–∞_—á–µ–∫–∞ √ó deal.seller_pays_percent
   (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10% –æ—Ç —á–µ–∫–∞)

2. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ–Ω–¥–∞:
   - –°–∏—Å—Ç–µ–º–∞: 30% –æ—Ç —Ñ–æ–Ω–¥–∞ (–∫–æ–º–∏—Å—Å–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã)
   - –ü–∞—Ä—Ç–Ω–µ—Ä-–∏—Å—Ç–æ—á–Ω–∏–∫ (L1): 70% –æ—Ç —Ñ–æ–Ω–¥–∞ (–ë–ï–ó –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ MLM!)

3. –°–ø–µ—Ü-–∫—ç—à–±—ç–∫ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é (–Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –≤ balance):
   - buyer_reward = –°—É–º–º–∞_—á–µ–∫–∞ √ó deal.buyer_gets_percent
   (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15% –æ—Ç —á–µ–∫–∞)
```

**–ü—Ä–∏–º–µ—Ä:**
- –ß–µ–∫: 10 000 —Ä—É–±
- `seller_pays_percent`: 10%
- –§–æ–Ω–¥: 10 000 √ó 0.10 = **1 000 —Ä—É–±**
- –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª—É—á–∞–µ—Ç: 1 000 √ó 0.30 = **300 —Ä—É–±**
- –ü–∞—Ä—Ç–Ω–µ—Ä-–∏—Å—Ç–æ—á–Ω–∏–∫ –ø–æ–ª—É—á–∞–µ—Ç: 1 000 √ó 0.70 = **700 —Ä—É–±**
- –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å–ø–µ—Ü-–∫—ç—à–±—ç–∫: 10 000 √ó 0.15 = **1 500 –±–∞–ª–ª–æ–≤** (–≤ balance)

**–í–∞–∂–Ω–æ:** –í B2B –ª–æ–≥–∏–∫–µ **–ù–ï –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è** 3-—É—Ä–æ–≤–Ω–µ–≤–∞—è MLM —Ü–µ–ø–æ—á–∫–∞. –í—Å—è –∫–æ–º–∏—Å—Å–∏—è –∏–¥–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –ø–∞—Ä—Ç–Ω–µ—Ä—É-–∏—Å—Ç–æ—á–Ω–∏–∫—É.

---

## üóÑÔ∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### 1. –¢–∞–±–ª–∏—Ü–∞ `partners` (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)

**–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ:**
```sql
ALTER TABLE partners
ADD COLUMN IF NOT EXISTS base_reward_percent NUMERIC DEFAULT 0.05;
```

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç —Å—É–º–º—ã —á–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–∞—Ä—Ç–Ω–µ—Ä-–ø—Ä–æ–¥–∞–≤–µ—Ü –æ—Ç–¥–∞–µ—Ç –≤ –∫–æ–º–∏—Å—Å–∏–æ–Ω–Ω—ã–π —Ñ–æ–Ω–¥ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π MLM –ª–æ–≥–∏–∫–∏.

**–î–µ—Ñ–æ–ª—Ç:** 0.05 (5%)

---

### 2. –¢–∞–±–ª–∏—Ü–∞ `partner_deals` (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ `ecosystem_migration.sql`)

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª–µ–π:**
- `source_partner_chat_id` (–∫—Ç–æ –ø—Ä–∏–≤–µ–ª –∫–ª–∏–µ–Ω—Ç–∞)
- `target_partner_chat_id` (–∫—É–¥–∞ –ø—Ä–∏—à–µ–ª –∫–ª–∏–µ–Ω—Ç = –ø—Ä–æ–¥–∞–≤–µ—Ü)
- `client_cashback_percent` (—ç—Ç–æ `buyer_gets_percent`)
- `referral_commission_percent` (—ç—Ç–æ `seller_pays_percent`)

**–ï—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å/–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å:**
```sql
-- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —è–≤–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏:
ALTER TABLE partner_deals
ADD COLUMN IF NOT EXISTS seller_pays_percent NUMERIC,
ADD COLUMN IF NOT EXISTS buyer_gets_percent NUMERIC;

-- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å –º–∞–ø–ø–∏–Ω–≥–æ–º:
-- referral_commission_percent -> seller_pays_percent
-- client_cashback_percent -> buyer_gets_percent
```

---

### 3. –¢–∞–±–ª–∏—Ü–∞ `users` (—É–∂–µ –µ—Å—Ç—å `commission_balance`)

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:** –ü–æ–ª–µ `commission_balance` –¥–æ–ª–∂–Ω–æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å (–¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ `ecosystem_migration.sql`).

---

## üîß –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### 1. –§–∞–π–ª `referral_calculator.py` (—Å–æ–∑–¥–∞–Ω)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤  
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `/Users/ghbi/Downloads/loyalitybot/referral_calculator.py`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –°–æ–¥–µ—Ä–∂–∏—Ç –∫–ª–∞—Å—Å `ReferralCalculator` —Å –º–µ—Ç–æ–¥–æ–º `calculate_commissions()`
- –†–µ–∞–ª–∏–∑—É–µ—Ç –æ–±–µ –ª–æ–≥–∏–∫–∏ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è + B2B)
- –ò–º–µ–µ—Ç unit-—Ç–µ—Å—Ç—ã

---

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `supabase_manager.py`

**–ù—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é:** `process_referral_transaction_bonuses()`

**–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ (—Å—Ç—Ä–æ–∫–∞ ~3459):**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—É—é —Ñ–æ—Ä–º—É–ª—É: `bonus_points = earned_points * percent` (8%/4%/2%)
- –ù–∞—á–∏—Å–ª—è–µ—Ç –≤ `commission_balance`

**–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞:**
1. **–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å** `ReferralCalculator` –∏–∑ `referral_calculator.py`
2. **–°–æ–∑–¥–∞—Ç—å** –æ–±—ä–µ–∫—Ç –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ë–î
3. **–í—ã–∑–≤–∞—Ç—å** `calculate_commissions()` –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–π –ª–æ–≥–∏–∫–∏
4. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å** —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: –Ω–∞—á–∏—Å–ª–∏—Ç—å –∫–æ–º–∏—Å—Å–∏–∏ –≤ `commission_balance` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è

**–ü—Å–µ–≤–¥–æ–∫–æ–¥:**
```python
from referral_calculator import ReferralCalculator, PurchaseInput, PartnerData, B2BDeal

def process_referral_transaction_bonuses(self, user_chat_id: str, earned_points: int, 
                                         transaction_amount: float, seller_partner_id: str, 
                                         transaction_id: int = None) -> bool:
    # 1. –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥–∞–≤—Ü–∞
    seller_data = self.get_partner_data(seller_partner_id)
    
    # 2. –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ B2B —Å–¥–µ–ª–∫–∏
    active_deals = self.get_active_b2b_deals()
    
    # 3. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Å–ª–æ–≤–∞—Ä—å users –¥–ª—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
    users_dict = self._build_users_dict_for_calculator(user_chat_id)
    
    # 4. –°–æ–∑–¥–∞—Ç—å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
    calculator = ReferralCalculator(users_dict, active_deals)
    
    # 5. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–æ–º–∏—Å—Å–∏–∏
    purchase = PurchaseInput(
        user_id=user_chat_id,
        amount=transaction_amount,
        seller_partner_id=seller_partner_id
    )
    result = calculator.calculate_commissions(purchase, seller_data)
    
    # 6. –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: –Ω–∞—á–∏—Å–ª–∏—Ç—å –∫–∞–∂–¥–æ–º—É –ø–æ–ª—É—á–∞—Ç–µ–ª—é
    for commission in result.commissions:
        if commission.user_id != "SYSTEM":
            self._add_to_commission_balance(commission.user_id, commission.amount)
    
    # 7. –ï—Å–ª–∏ –µ—Å—Ç—å —Å–ø–µ—Ü-–∫—ç—à–±—ç–∫ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é (B2B), –Ω–∞—á–∏—Å–ª–∏—Ç—å –≤ balance
    if result.buyer_special_reward:
        self._add_to_balance(user_chat_id, result.buyer_special_reward)
    
    return True
```

---

### 3. –ù–æ–≤—ã–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –≤ `supabase_manager.py`

**–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**

```python
def get_partner_data(self, partner_chat_id: str) -> Optional[PartnerData]:
    """–ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –¥–ª—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞"""
    # –ó–∞–ø—Ä–æ—Å –∫ –ë–î partners, –≤–æ–∑–≤—Ä–∞—Ç PartnerData

def get_active_b2b_deals(self) -> List[B2BDeal]:
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö B2B —Å–¥–µ–ª–æ–∫"""
    # –ó–∞–ø—Ä–æ—Å –∫ –ë–î partner_deals, —Ñ–∏–ª—å—Ç—Ä –ø–æ status='active'

def _build_users_dict_for_calculator(self, start_user_id: str) -> Dict[str, User]:
    """–°—Ç—Ä–æ–∏—Ç —Å–ª–æ–≤–∞—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ (—Å —Ü–µ–ø–æ—á–∫–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤)"""
    # –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Å–æ–±–∏—Ä–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∏—Ö —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–≤
```

---

## üìù –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ë–î (5 –º–∏–Ω—É—Ç)

1. –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏—é:
   ```sql
   ALTER TABLE partners
   ADD COLUMN IF NOT EXISTS base_reward_percent NUMERIC DEFAULT 0.05;
   ```

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É `partner_deals` (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º)

---

### –≠—Ç–∞–ø 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ (10 –º–∏–Ω—É—Ç)

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å unit-—Ç–µ—Å—Ç—ã:
   ```bash
   python3 referral_calculator.py
   ```

2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

---

### –≠—Ç–∞–ø 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `supabase_manager.py` (30-60 –º–∏–Ω—É—Ç)

1. –î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç `ReferralCalculator`
2. –î–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã (`get_partner_data`, `get_active_b2b_deals`, `_build_users_dict_for_calculator`)
3. –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å `process_referral_transaction_bonuses()` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –∫–∞–∫ fallback –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–æ–∫)

---

### –≠—Ç–∞–ø 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (30 –º–∏–Ω—É—Ç)

1. **–¢–µ—Å—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –ª–æ–≥–∏–∫–∏:**
   - –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ø–æ–∫—É–ø–∫—É –ë–ï–ó B2B —Å–¥–µ–ª–∫–∏
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–æ–º–∏—Å—Å–∏–∏ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –ø–æ MLM (5%/5%/5%)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å—É–º–º—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

2. **–¢–µ—Å—Ç B2B –ª–æ–≥–∏–∫–∏:**
   - –°–æ–∑–¥–∞—Ç—å B2B —Å–¥–µ–ª–∫—É –º–µ–∂–¥—É –¥–≤—É–º—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º–∏
   - –°–æ–∑–¥–∞—Ç—å –ø–æ–∫—É–ø–∫—É –∫–ª–∏–µ–Ω—Ç–∞, –ø—Ä–∏—à–µ–¥—à–µ–≥–æ –æ—Ç source –ø–∞—Ä—Ç–Ω–µ—Ä–∞
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–æ–º–∏—Å—Å–∏—è –∏–¥–µ—Ç —Ç–æ–ª—å–∫–æ source –ø–∞—Ä—Ç–Ω–µ—Ä—É (70%), —Å–∏—Å—Ç–µ–º–µ (30%)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ MLM –ù–ï –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª —Å–ø–µ—Ü-–∫—ç—à–±—ç–∫

3. **–¢–µ—Å—Ç edge cases:**
   - –ü–æ–∫—É–ø–∫–∞ –±–µ–∑ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ (–∫–æ–º–∏—Å—Å–∏—è —É—Ö–æ–¥–∏—Ç —Å–∏—Å—Ç–µ–º–µ)
   - –ü–æ–∫—É–ø–∫–∞ —Å 1-2 —É—Ä–æ–≤–Ω—è–º–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ (–Ω–µ–ø–æ–ª–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞)
   - B2B —Å–¥–µ–ª–∫–∞ —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º

---

### –≠—Ç–∞–ø 5: –î–µ–ø–ª–æ–π –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (15 –º–∏–Ω—É—Ç)

1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç—ã
2. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–≤—ã–µ —Ä–µ–∞–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] SQL –º–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
- [ ] Unit-—Ç–µ—Å—Ç—ã –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `supabase_manager.py` –∑–∞–≤–µ—Ä—à–µ–Ω–∞
- [ ] –¢–µ—Å—Ç—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –ª–æ–≥–∏–∫–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] –¢–µ—Å—Ç—ã B2B –ª–æ–≥–∏–∫–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] Edge cases –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ (fallback –Ω–∞ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É –ø—Ä–∏ —Å–±–æ—è—Ö)

---

## üö® –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ `amount > 0`
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [0, 1]
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/–ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
   - –ï—Å–ª–∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–∞–¥–∞–µ—Ç ‚Üí fallback –Ω–∞ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É (8%/4%/2%)
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ—à–∏–±–∫–∏
   - –ù–µ –Ω–∞—á–∏—Å–ª—è—Ç—å –∫–æ–º–∏—Å—Å–∏–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

3. **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å:**
   - –í—Å–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ë–î
   - –ï—Å–ª–∏ –æ–¥–Ω–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –Ω–µ –ø—Ä–æ—à–ª–æ ‚Üí –æ—Ç–∫–∞—Ç–∏—Ç—å –≤—Å–µ

---

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ (TTL 5 –º–∏–Ω—É—Ç)
   - –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ B2B —Å–¥–µ–ª–∫–∏ (TTL 1 –º–∏–Ω—É—Ç–∞)

2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤:**
   - –°–æ–±–∏—Ä–∞—Ç—å —Ü–µ–ø–æ—á–∫—É —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º (JOIN)
   - –ù–µ –¥–µ–ª–∞—Ç—å N+1 –∑–∞–ø—Ä–æ—Å–æ–≤

---

### –Æ–∑–∞–±–∏–ª–∏—Ç–∏

1. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:**
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å, –∫–∞–∫–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ (standard/b2b)
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å—É–º–º—ã –∫–æ–º–∏—Å—Å–∏–π
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π

2. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤:**
   - –í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å, –ø–æ –∫–∞–∫–æ–π –ª–æ–≥–∏–∫–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∞ –∫–æ–º–∏—Å—Å–∏—è
   - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏ B2B —Å–¥–µ–ª–æ–∫

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –î–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤-–ø—Ä–æ–¥–∞–≤—Ü–æ–≤

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞:**
- –í—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç–µ `base_reward_percent` (—Å–∫–æ–ª—å–∫–æ % –æ—Ç —á–µ–∫–∞ –∏–¥–µ—Ç –≤ –∫–æ–º–∏—Å—Å–∏–æ–Ω–Ω—ã–π —Ñ–æ–Ω–¥)
- –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç —ç—Ç–æ—Ç —Ñ–æ–Ω–¥ –ø–æ MLM (5%/5%/5%/85%)

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç B2B —Å–¥–µ–ª–∫–∞:**
- –í—ã –¥–æ–≥–æ–≤–∞—Ä–∏–≤–∞–µ—Ç–µ—Å—å —Å –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º (–±–ª–æ–≥–µ—Ä–æ–º) –æ –∫–æ–º–∏—Å—Å–∏–∏
- –°–æ–∑–¥–∞–µ—Ç–µ B2B —Å–¥–µ–ª–∫—É –≤ —Å–∏—Å—Ç–µ–º–µ
- –ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ –∫–ª–∏–µ–Ω—Ç–∞ –æ—Ç —ç—Ç–æ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞: 70% –∫–æ–º–∏—Å—Å–∏–∏ –∏–¥–µ—Ç –ø–∞—Ä—Ç–Ω–µ—Ä—É, 30% —Å–∏—Å—Ç–µ–º–µ
- MLM –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è (—ç–∫–æ–Ω–æ–º–∏—è –¥–ª—è –≤–∞—Å)

### –î–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (–±–ª–æ–≥–µ—Ä–æ–≤)

**B2B —Å–¥–µ–ª–∫–∞:**
- –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ 70% –æ—Ç –∫–æ–º–∏—Å—Å–∏–æ–Ω–Ω–æ–≥–æ —Ñ–æ–Ω–¥–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞
- –≠—Ç–æ –±–æ–ª—å—à–µ, —á–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è MLM (–≥–¥–µ –≤—ã –±—ã –ø–æ–ª—É—á–∏–ª–∏ —Ç–æ–ª—å–∫–æ 5%)
- –ù–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã –ø—Ä–∏–≤–µ–ª–∏ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø—Ä–æ–¥–∞–≤—Ü—É

---

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

**–í–æ–ø—Ä–æ—Å:** –ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏?

**–û—Ç–≤–µ—Ç:** –ù–∏—á–µ–≥–æ. –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ **–Ω–æ–≤—ã–º** —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º. –°—Ç–∞—Ä—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å.

**–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å:**
- –°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
- –ó–∞–ø—É—Å—Ç–∏—Ç—å –µ–≥–æ –≤—Ä—É—á–Ω—É—é –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –±–æ—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å unit-—Ç–µ—Å—Ç—ã
3. –°–≤—è–∑–∞—Ç—å—Å—è —Å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º

---

**–î–æ–∫—É–º–µ–Ω—Ç –∞–∫—Ç—É–∞–ª–µ–Ω –Ω–∞:** 2025-01-XX  
**–í–µ—Ä—Å–∏—è:** 1.0

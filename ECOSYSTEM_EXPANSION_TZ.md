# üåç –¢–ó: –≠–∫–æ—Å–∏—Å—Ç–µ–º–∞ LoyalityBot 2.0 (Multi-Niche + B2B Deals)

**–í–µ—Ä—Å–∏—è:** 2.0 (Unified)
**–î–∞—Ç–∞:** –Ø–Ω–≤–∞—Ä—å 2026
**–¶–µ–ª—å:** –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ CRM –¥–ª—è —Å–∞–ª–æ–Ω–æ–≤ –≤ –≥–æ—Ä–æ–¥—Å–∫—É—é —ç–∫–æ—Å–∏—Å—Ç–µ–º—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Å –≥–∏–±–∫–∏–º–∏ B2B —Å–≤—è–∑—è–º–∏.

---

## 1. –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ò –ë–ê–ó–ê –î–ê–ù–ù–´–•

### 1.1. –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ (–¢–∞–±–ª–∏—Ü–∞ `partners`)
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –∏ –¥–∞—Ç—å –∏–º –≥–∏–±–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.

**SQL –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
```sql
ALTER TABLE partners 
ADD COLUMN category_group TEXT DEFAULT 'beauty' CHECK (category_group IN ('beauty', 'food', 'retail', 'activity', 'influencer')),
ADD COLUMN ui_config JSONB DEFAULT '{}'::jsonb,
ADD COLUMN is_verified BOOLEAN DEFAULT false; -- –ì–∞–ª–æ—á–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
```

**–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª–µ–π:**
*   `category_group`: –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤.
*   `ui_config`: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.
    *   `show_booking`: false (–¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤/–±–ª–æ–≥–µ—Ä–æ–≤)
    *   `action_button_text`: "–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–ª" / "–ö—É–ø–∏—Ç—å"
    *   `menu_url`: –°—Å—ã–ª–∫–∞ –Ω–∞ PDF/–°–∞–π—Ç

### 1.2. –°–∏—Å—Ç–µ–º–∞ B2B –°–¥–µ–ª–æ–∫ (–ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ `partner_deals`)
–°—É—â–Ω–æ—Å—Ç—å, —Ä–µ–≥—É–ª–∏—Ä—É—é—â–∞—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º–∏.

**SQL —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```sql
CREATE TABLE partner_deals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    source_partner_id TEXT REFERENCES partners(chat_id), -- –ö—Ç–æ –ø—Ä–∏–≤–µ–ª (–ë–ª–æ–≥–µ—Ä, –†–µ—Å—Ç–æ—Ä–∞–Ω)
    target_partner_id TEXT REFERENCES partners(chat_id), -- –ö—É–¥–∞ –ø—Ä–∏—à–ª–∏ (–°–∞–ª–æ–Ω)
    
    -- –£—Å–ª–æ–≤–∏—è —Å–¥–µ–ª–∫–∏
    client_cashback_percent NUMERIC NOT NULL DEFAULT 5.0, -- –í—ã–≥–æ–¥–∞ –∫–ª–∏–µ–Ω—Ç–∞
    referral_commission_percent NUMERIC NOT NULL DEFAULT 10.0, -- –í—ã–≥–æ–¥–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∞-–∏—Å—Ç–æ—á–Ω–∏–∫–∞
    
    -- –°—Ç–∞—Ç—É—Å –∏ —Å—Ä–æ–∫–∏
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'active', 'rejected', 'expired', 'paused')),
    created_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP,
    
    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    notes TEXT, -- "–î–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å –Ω–∞ –º–µ—Å—è—Ü —Ç–µ—Å—Ç–∞"
    UNIQUE(source_partner_id, target_partner_id) -- –¢–æ–ª—å–∫–æ 1 –∞–∫—Ç–∏–≤–Ω–∞—è —Å–¥–µ–ª–∫–∞ –º–µ–∂–¥—É –ø–∞—Ä–æ–π
);

CREATE INDEX idx_deals_source ON partner_deals(source_partner_id);
CREATE INDEX idx_deals_target ON partner_deals(target_partner_id);
```

---

## 2. –ë–≠–ö–ï–ù–î –õ–û–ì–ò–ö–ê (Smart Calculation)

### 2.1. –ê–ª–≥–æ—Ä–∏—Ç–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (`execute_transaction`)
–õ–æ–≥–∏–∫–∞ –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–∞–ª–∏—á–∏–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π —Å–¥–µ–ª–∫–∏ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª.

**–ü—Å–µ–≤–¥–æ–∫–æ–¥:**
```python
def calculate_points_and_commissions(transaction):
    user = transaction.user
    target_partner = transaction.partner # –ì–¥–µ –ø–ª–∞—Ç—è—Ç
    source_partner = user.referred_by # –ö—Ç–æ –ø—Ä–∏–≤–µ–ª (–µ—Å–ª–∏ –µ—Å—Ç—å)

    # 1. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (Defaults)
    cashback_pct = target_partner.default_cashback (5%)
    commission_pct = target_partner.default_referral (10%)

    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ B2B –°–¥–µ–ª–∫–∏ (Override)
    if source_partner:
        deal = db.get_active_deal(source=source_partner.id, target=target_partner.id)
        if deal:
            cashback_pct = deal.client_cashback_percent     # –ù–∞–ø—Ä–∏–º–µ—Ä, 15%
            commission_pct = deal.referral_commission_percent # –ù–∞–ø—Ä–∏–º–µ—Ä, 20%

    # 3. –†–∞—Å—á–µ—Ç
    client_points = amount * cashback_pct
    partner_reward = amount * commission_pct
    
    return client_points, partner_reward
```

### 2.2. –õ–æ–≥–∏–∫–∞ –¥–ª—è –ë–ª–æ–≥–µ—Ä–æ–≤ (Influencers)
–ë–ª–æ–≥–µ—Ä—ã –Ω–µ –ø—Ä–æ–≤–æ–¥—è—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ "—É —Å–µ–±—è". –û–Ω–∏ —è–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ `source_partner`.
*   –ò—Ö –¥–æ—Ö–æ–¥ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –∏–∑ `referral_commission_percent` –æ—Ç —Å–¥–µ–ª–æ–∫ —Å —Å–∞–ª–æ–Ω–∞–º–∏/—Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º–∏.
*   –í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –±–ª–æ–≥–µ—Ä–∞ –Ω–µ—Ç –∫–Ω–æ–ø–∫–∏ "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR", –Ω–æ –µ—Å—Ç—å "–ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–ø–ª–∞—Ç".

---

## 3. –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–´ (UI/UX)

### 3.1. Web App (–ö–ª–∏–µ–Ω—Ç)
1.  **–§–∏–ª—å—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π:** –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ç–∞–±—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–π: [–ö—Ä–∞—Å–æ—Ç–∞] [–ï–¥–∞] [–ú–∞–≥–∞–∑–∏–Ω—ã].
2.  **–ö–∞—Ä—Ç–æ—á–∫–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∞:**
    *   –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π Deal –º–µ–∂–¥—É "–º–æ–∏–º —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–º" –∏ —ç—Ç–∏–º –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º -> –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–µ–π–¥–∂: üî• "–í–∞–º +15% –∫—ç—à–±—ç–∫–∞ –æ—Ç @FoodBlogNY".

### 3.2. Partner Bot (B2B Tinder)
–ù–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª "–ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ" (`/collaboration`):
1.  **–ü–æ–∏—Å–∫ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤:** –°–ø–∏—Å–æ–∫ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ –Ω–∏—à–∞–º.
2.  **–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ñ—Ñ–µ—Ä–∞:**
    *   –í–≤–æ–¥ `% –∫—ç—à–±—ç–∫–∞` –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞.
    *   –í–≤–æ–¥ `% –∫–æ–º–∏—Å—Å–∏–∏` –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞.
3.  **–í—Ö–æ–¥—è—â–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:** –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ [–ü—Ä–∏–Ω—è—Ç—å] / [–û—Ç–∫–ª–æ–Ω–∏—Ç—å].

---

## 4. ROADMAP (–ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è)

### –§–∞–∑–∞ 1: –§—É–Ω–¥–∞–º–µ–Ω—Ç (–ù–µ–¥–µ–ª–∏ 1-2)
*   [Backend] –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î (`partners`, `partner_deals`).
*   [Backend] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π Pydantic/SQLAlchemy.
*   [Bot] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–ª–æ—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–≤—ã–±–æ—Ä –Ω–∏—à–∏).

### –§–∞–∑–∞ 2: –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è (–ù–µ–¥–µ–ª–∏ 3-4)
*   [Web] –§–∏–ª—å—Ç—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–∞ –≥–ª–∞–≤–Ω–æ–π.
*   [Web] –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ (—Å–∫—Ä—ã—Ç–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤).
*   [Web] –ë–µ–π–¥–∂–∏ "–ü–æ–≤—ã—à–µ–Ω–Ω—ã–π –∫—ç—à–±—ç–∫" –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–¥–µ–ª–∫–∏.

### –§–∞–∑–∞ 3: B2B –ú–µ—Ö–∞–Ω–∏–∫–∞ (–ù–µ–¥–µ–ª–∏ 5-6)
*   [Backend] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤ (–ø—Ä–æ–≤–µ—Ä–∫–∞ Deals).
*   [Bot] –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å "–ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ" (—Å–æ–∑–¥–∞–Ω–∏–µ –∏ –ø—Ä–∏–Ω—è—Ç–∏–µ —Å–¥–µ–ª–æ–∫).
*   [Admin] –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Å–¥–µ–ª–æ–∫ –≤ –∞–¥–º–∏–Ω–∫–µ.

### –§–∞–∑–∞ 4: –ë–ª–æ–≥–µ—Ä—ã –∏ –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (–ù–µ–¥–µ–ª–∏ 7-8)
*   [Marketing] –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –ø–µ—Ä–≤—ã—Ö 5 –±–ª–æ–≥–µ—Ä–æ–≤.
*   [Marketing] –û–Ω–±–æ—Ä–¥–∏–Ω–≥ 2-3 —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤.
*   [Analytics] –î–∞—à–±–æ—Ä–¥ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫—Ä–æ—Å—Å-–ø—Ä–æ–º–æ.


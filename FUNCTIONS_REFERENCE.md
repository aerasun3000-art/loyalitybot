# üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ñ—É–Ω–∫—Ü–∏–π LoyalityBot

–ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—á–µ–Ω—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –ø–æ –º–æ–¥—É–ª—è–º —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

---

## üìë –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –±–æ—Ç (bot.py)](#–ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π-–±–æ—Ç-botpy)
2. [–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –±–æ—Ç (client_handler.py)](#–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π-–±–æ—Ç-client_handlerpy)
3. [–ê–¥–º–∏–Ω –±–æ—Ç (admin_bot.py)](#–∞–¥–º–∏–Ω-–±–æ—Ç-admin_botpy)
4. [–ú–µ–Ω–µ–¥–∂–µ—Ä –ë–î (supabase_manager.py)](#–º–µ–Ω–µ–¥–∂–µ—Ä-–±–¥-supabase_managerpy)
5. [–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å (admin_dashboard.py)](#–∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å-admin_dashboardpy)
6. [–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (logger_config.py)](#–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ-logger_configpy)

---

## ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –±–æ—Ç (bot.py)

**–¢–æ–∫–µ–Ω:** `TOKEN_PARTNER`  
**–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è:** –ü–∞—Ä—Ç–Ω—ë—Ä—ã (–≤–ª–∞–¥–µ–ª—å—Ü—ã –±–∏–∑–Ω–µ—Å–∞)

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –¥–æ—Å—Ç—É–ø

#### `handle_partner_start(message)`
**–ö–æ–º–∞–Ω–¥–∞:** `/start` –∏–ª–∏ `/partner_start`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–∞—Ä—Ç–Ω—ë—Ä–∞ (Pending/Approved/Rejected)
- –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

**–°—Ç–∞—Ç—É—Å—ã:**
- `Pending` ‚Üí "–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏"
- `Approved` ‚Üí –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø–∞—Ä—Ç–Ω—ë—Ä–∞
- `Rejected` ‚Üí "–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞"
- –ù–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω ‚Üí –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

**–ü—Ä–∏–º–µ—Ä:**
```
–ü–∞—Ä—Ç–Ω—ë—Ä: /start
–ë–æ—Ç: ü§ù **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Ä–∞–±–æ—á–µ–µ –º–µ–Ω—é –ø–∞—Ä—Ç–Ω–µ—Ä–∞!**
     [–ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é]
```

---

### 2. –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

#### `get_partner_keyboard()`
**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** ReplyKeyboardMarkup

**–ö–Ω–æ–ø–∫–∏:**
- ‚ûï –ù–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–ª—ã
- ‚ûñ –°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã
- üåü –ê–∫—Ü–∏–∏
- üõ†Ô∏è –£—Å–ª—É–≥–∏
- üë• –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
- üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- üë§ –ù–∞–π—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞
- ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏

#### `partner_main_menu(chat_id, message_text)`
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏

---

### 3. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤

#### `handle_partner_menu_buttons(message)` ‚Üí "‚ûï –ù–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–ª—ã"

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ó–∞–ø—Ä–æ—Å Chat ID –∫–ª–∏–µ–Ω—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
3. –ó–∞–ø—Ä–æ—Å —Å—É–º–º—ã —á–µ–∫–∞ (–≤ —Ä—É–±–ª—è—Ö)
4. –†–∞—Å—á—ë—Ç –±–∞–ª–ª–æ–≤ (5% –æ—Ç —Å—É–º–º—ã)
5. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤
6. –ó–∞–ø–∏—Å—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
7. –û—Ç–ø—Ä–∞–≤–∫–∞ NPS –∑–∞–ø—Ä–æ—Å–∞ –∫–ª–∏–µ–Ω—Ç—É

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏:**
- `process_client_id(message)` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ ID –∫–ª–∏–µ–Ω—Ç–∞
- `process_amount(message)` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—É–º–º—ã —á–µ–∫–∞

**–ü—Ä–∏–º–µ—Ä:**
```
–ü–∞—Ä—Ç–Ω—ë—Ä: ‚ûï –ù–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–ª—ã
–ë–æ—Ç: –í–≤–µ–¥–∏—Ç–µ Chat ID –∫–ª–∏–µ–Ω—Ç–∞
–ü–∞—Ä—Ç–Ω—ë—Ä: 123456
–ë–æ—Ç: –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: 100 –±–∞–ª–ª–æ–≤. –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —á–µ–∫–∞:
–ü–∞—Ä—Ç–Ω—ë—Ä: 1000
–ë–æ—Ç: ‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–æ: 50 –±–∞–ª–ª–æ–≤. –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: 150
```

**–†–∞—Å—á—ë—Ç:**
- –°—É–º–º–∞ —á–µ–∫–∞: 1000 —Ä—É–±
- –ö—ç—à–±—ç–∫: 5% = 50 –±–∞–ª–ª–æ–≤
- –ë–∞–ª–∞–Ω—Å: 100 + 50 = 150 –±–∞–ª–ª–æ–≤

---

### 4. –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤

#### `handle_partner_menu_buttons(message)` ‚Üí "‚ûñ –°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã"

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ó–∞–ø—Ä–æ—Å Chat ID –∫–ª–∏–µ–Ω—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
3. –ó–∞–ø—Ä–æ—Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±–∞–ª–ª–æ–≤ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è
4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤
5. –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤
6. –ó–∞–ø–∏—Å—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- –ë–∞–ª–∞–Ω—Å >= –°–ø–∏—Å–∞–Ω–∏–µ ‚Üí ‚úÖ –£—Å–ø–µ—à–Ω–æ
- –ë–∞–ª–∞–Ω—Å < –°–ø–∏—Å–∞–Ω–∏–µ ‚Üí ‚ùå "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–Ω—É—Å–æ–≤"

**–ü—Ä–∏–º–µ—Ä:**
```
–ü–∞—Ä—Ç–Ω—ë—Ä: ‚ûñ –°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã
–ë–æ—Ç: –í–≤–µ–¥–∏—Ç–µ Chat ID –∫–ª–∏–µ–Ω—Ç–∞
–ü–∞—Ä—Ç–Ω—ë—Ä: 123456
–ë–æ—Ç: –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: 150 –±–∞–ª–ª–æ–≤. –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤:
–ü–∞—Ä—Ç–Ω—ë—Ä: 50
–ë–æ—Ç: ‚úÖ –°–ø–∏—Å–∞–Ω–æ: 50 –±–∞–ª–ª–æ–≤. –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: 100
```

---

### 5. –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ (–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)

#### `handle_invite_start(message)` ‚Üí "üë• –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞"

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
- –§–æ—Ä–º–∞—Ç: `https://t.me/mindbeatybot?start=partner_{PARTNER_ID}`

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫:** `handle_invite_callbacks(call)` —Å `call.data == 'invite_by_link'`

**–ú–µ—Ö–∞–Ω–∏–∑–º:**
1. –ü–∞—Ä—Ç–Ω—ë—Ä –ø–æ–ª—É—á–∞–µ—Ç —Å—Å—ã–ª–∫—É
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
3. –ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ
4. –ö–ª–∏–µ–Ω—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è
5. –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å (100 –±–∞–ª–ª–æ–≤)
6. –ö–ª–∏–µ–Ω—Ç –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ –ø–∞—Ä—Ç–Ω—ë—Ä—É

**–ü—Ä–∏–º–µ—Ä:**
```
–ü–∞—Ä—Ç–Ω—ë—Ä: üë• –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
–ë–æ—Ç: [–ö–Ω–æ–ø–∫–∞: üîó –ü–æ–ª—É—á–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É]
–ü–∞—Ä—Ç–Ω—ë—Ä: [–Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É]
–ë–æ—Ç: üîó –í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:
     https://t.me/mindbeatybot?start=partner_123456
     
     –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–ª–∏–µ–Ω—Ç—É –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏!
```

---

### 6. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–∞

#### `handle_partner_stats(message)` ‚Üí "üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"

**–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏:**
1. **–ü—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ:**
   - –ü—Ä–∏–≤–ª–µ—á–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ (–ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º —Å—Å—ã–ª–∫–∞–º)

2. **–§–∏–Ω–∞–Ω—Å—ã:**
   - –û–±—â–∏–π –æ–±–æ—Ä–æ—Ç (—Å—É–º–º–∞ –≤—Å–µ—Ö —á–µ–∫–æ–≤ –≤ —Ä—É–±–ª—è—Ö)
   - –í—Å–µ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–æ –±–∞–ª–ª–æ–≤
   - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

3. **–ö–∞—á–µ—Å—Ç–≤–æ (NPS):**
   - –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ (Average Rating)
   - –ß–∏—Å—Ç—ã–π NPS (Net Promoter Score)
   - –ü—Ä–æ–º–æ—É—Ç–µ—Ä—ã (–æ—Ü–µ–Ω–∫–∏ 9-10)
   - –î–µ—Ç—Ä–∞–∫—Ç–æ—Ä—ã (–æ—Ü–µ–Ω–∫–∏ 0-6)

**–†–∞—Å—á—ë—Ç NPS:**
```
NPS = ((–ü—Ä–æ–º–æ—É—Ç–µ—Ä—ã - –î–µ—Ç—Ä–∞–∫—Ç–æ—Ä—ã) / –í—Å–µ–≥–æ –æ—Ü–µ–Ω–æ–∫) √ó 100
```

**–ü—Ä–∏–º–µ—Ä:**
```
üìä –í–∞—à–∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
---
–ü—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ:
üë• –ü—Ä–∏–≤–ª–µ—á–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç–æ–≤: 25 —á–µ–ª.
---
–§–∏–Ω–∞–Ω—Å—ã:
üí∞ –û–±—â–∏–π –æ–±–æ—Ä–æ—Ç: 150,000 —Ä—É–±.
üéÅ –í—Å–µ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–æ –±–∞–ª–ª–æ–≤: 7,500
üßæ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: 78
---
–ö–∞—á–µ—Å—Ç–≤–æ (NPS):
‚≠ê –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: 8.5
üìà –ß–∏—Å—Ç—ã–π NPS: 65
üü¢ –ü—Ä–æ–º–æ—É—Ç–µ—Ä—ã (9-10): 52
üî¥ –î–µ—Ç—Ä–∞–∫—Ç–æ—Ä—ã (0-6): 5
```

---

### 7. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ü–∏—è–º–∏

#### A. –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫—Ü–∏–∏ ‚Üí "üåü –ê–∫—Ü–∏–∏" ‚Üí "‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∞–∫—Ü–∏—é"

**–ü—Ä–æ—Ü–µ—Å—Å (4 —à–∞–≥–∞):**

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫:** `handle_promo_callbacks(call)` —Å `call.data == 'promo_add'`

1. **–®–∞–≥ 1:** –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∞–∫—Ü–∏–∏
   - –û–±—Ä–∞–±–æ—Ç—á–∏–∫: `process_promo_title(message)`
   - –í–∞–ª–∏–¥–∞—Ü–∏—è: –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞

2. **–®–∞–≥ 2:** –û–ø–∏—Å–∞–Ω–∏–µ –∞–∫—Ü–∏–∏
   - –û–±—Ä–∞–±–æ—Ç—á–∏–∫: `process_promo_description(message)`
   - –î–µ—Ç–∞–ª–∏ –∏ —É—Å–ª–æ–≤–∏—è

3. **–®–∞–≥ 3:** –†–∞–∑–º–µ—Ä —Å–∫–∏–¥–∫–∏/–±–æ–Ω—É—Å–∞
   - –û–±—Ä–∞–±–æ—Ç—á–∏–∫: `process_promo_discount(message)`
   - –ü—Ä–∏–º–µ—Ä: "20%" –∏–ª–∏ "x2 –±–æ–Ω—É—Å–∞"

4. **–®–∞–≥ 4:** –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
   - –û–±—Ä–∞–±–æ—Ç—á–∏–∫: `process_promo_end_date(message)`
   - –§–æ—Ä–º–∞—Ç: –î–î.–ú–ú.–ì–ì–ì–ì
   - –í–∞–ª–∏–¥–∞—Ü–∏—è: –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º

**–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:**
- –í—ã–∑–æ–≤ `sm.add_promotion(promo_data)`
- –ó–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É `promotions`
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º Web App

**–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞:**
```
–ü–∞—Ä—Ç–Ω—ë—Ä: üåü –ê–∫—Ü–∏–∏ ‚Üí ‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∞–∫—Ü–∏—é
–ë–æ—Ç: –®–∞–≥ 1/4: –í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫
–ü–∞—Ä—Ç–Ω—ë—Ä: –°–∫–∏–¥–∫–∞ 20% –Ω–∞ –¥–µ—Å–µ—Ä—Ç—ã
–ë–æ—Ç: –®–∞–≥ 2/4: –í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ
–ü–∞—Ä—Ç–Ω—ë—Ä: –°–∫–∏–¥–∫–∞ –Ω–∞ –≤—Å–µ –¥–µ—Å–µ—Ä—Ç—ã –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –æ—Ç 500 —Ä—É–±
–ë–æ—Ç: –®–∞–≥ 3/4: –†–∞–∑–º–µ—Ä —Å–∫–∏–¥–∫–∏
–ü–∞—Ä—Ç–Ω—ë—Ä: 20%
–ë–æ—Ç: –®–∞–≥ 4/4: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è (–î–î.–ú–ú.–ì–ì–ì–ì)
–ü–∞—Ä—Ç–Ω—ë—Ä: 31.12.2025
–ë–æ—Ç: üéâ –ê–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!
```

#### B. –ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∞–∫—Ü–∏–π ‚Üí "üåü –ê–∫—Ü–∏–∏" ‚Üí "‚öôÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å / –£–¥–∞–ª–∏—Ç—å"

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫:** `handle_promo_manage_list(chat_id)`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–∫—Ü–∏–π –ø–∞—Ä—Ç–Ω—ë—Ä–∞
- –î–ª—è –∫–∞–∂–¥–æ–π –∞–∫—Ü–∏–∏: ID, –∑–∞–≥–æ–ª–æ–≤–æ–∫, –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è

**–£–¥–∞–ª–µ–Ω–∏–µ –∞–∫—Ü–∏–∏:**
- –ö–æ–º–∞–Ω–¥–∞: `/delete_promo ID_–ê–ö–¶–ò–ò`
- –û–±—Ä–∞–±–æ—Ç—á–∏–∫: `handle_delete_promo(message)`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∞–∫—Ü–∏–∏ –ø–∞—Ä—Ç–Ω—ë—Ä—É
- –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –ë–î

**–ü—Ä–∏–º–µ—Ä:**
```
–ü–∞—Ä—Ç–Ω—ë—Ä: üåü –ê–∫—Ü–∏–∏ ‚Üí ‚öôÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å / –£–¥–∞–ª–∏—Ç—å
–ë–æ—Ç: üìã –í–∞—à–∏ –∞–∫—Ü–∏–∏:

     ‚Ä¢ –°–∫–∏–¥–∫–∞ 20% –Ω–∞ –¥–µ—Å–µ—Ä—Ç—ã
       ID: 15 | –î–æ: 2025-12-31

     ‚Ä¢ –î–≤–æ–π–Ω—ã–µ –±–∞–ª–ª—ã –ø–æ –ø—è—Ç–Ω–∏—Ü–∞–º
       ID: 18 | –î–æ: 2025-11-30
       
     üí° –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è: /delete_promo ID_–ê–ö–¶–ò–ò
     
–ü–∞—Ä—Ç–Ω—ë—Ä: /delete_promo 15
–ë–æ—Ç: ‚úÖ –ê–∫—Ü–∏—è ID 15 —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!
```

---

### 8. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏

#### A. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∏ ‚Üí "üõ†Ô∏è –£—Å–ª—É–≥–∏" ‚Üí "‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —É—Å–ª—É–≥—É"

**–ü—Ä–æ—Ü–µ—Å—Å (3 —à–∞–≥–∞):**

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫:** `handle_service_callbacks(call)` —Å `call.data == 'service_add'`

1. **–®–∞–≥ 1:** –ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏
   - –û–±—Ä–∞–±–æ—Ç—á–∏–∫: `process_service_title(message)`
   - –ü—Ä–∏–º–µ—Ä: "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–æ—Ñ–µ"

2. **–®–∞–≥ 2:** –û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏
   - –û–±—Ä–∞–±–æ—Ç—á–∏–∫: `process_service_description(message)`
   - –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

3. **–®–∞–≥ 3:** –°—Ç–æ–∏–º–æ—Å—Ç—å –≤ –±–∞–ª–ª–∞—Ö
   - –û–±—Ä–∞–±–æ—Ç—á–∏–∫: `process_service_price(message)`
   - –í–∞–ª–∏–¥–∞—Ü–∏—è: —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ > 0

**–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:**
- –í—ã–∑–æ–≤ `sm.add_service(service_data)`
- –°—Ç–∞—Ç—É—Å: `Pending` (–æ–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞)
- –ó–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É `services`

**–ü—Ä–∏–º–µ—Ä:**
```
–ü–∞—Ä—Ç–Ω—ë—Ä: üõ†Ô∏è –£—Å–ª—É–≥–∏ ‚Üí ‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —É—Å–ª—É–≥—É
–ë–æ—Ç: –®–∞–≥ 1/3: –ù–∞–∑–≤–∞–Ω–∏–µ
–ü–∞—Ä—Ç–Ω—ë—Ä: –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–∞–ø—É—á–∏–Ω–æ
–ë–æ—Ç: –®–∞–≥ 2/3: –û–ø–∏—Å–∞–Ω–∏–µ
–ü–∞—Ä—Ç–Ω—ë—Ä: –ü–æ–ª—É—á–∏—Ç–µ –∫–∞–ø—É—á–∏–Ω–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ. –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å 10:00 –¥–æ 12:00
–ë–æ—Ç: –®–∞–≥ 3/3: –°—Ç–æ–∏–º–æ—Å—Ç—å –≤ –±–∞–ª–ª–∞—Ö
–ü–∞—Ä—Ç–Ω—ë—Ä: 150
–ë–æ—Ç: ‚úÖ –£—Å–ª—É–≥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é!
     –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç –≤–∞—à—É –∑–∞—è–≤–∫—É.
```

#### B. –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—É—Å–∞ —É—Å–ª—É–≥ ‚Üí "üõ†Ô∏è –£—Å–ª—É–≥–∏" ‚Üí "üîç –ú–æ–∏ —É—Å–ª—É–≥–∏ (—Å—Ç–∞—Ç—É—Å)"

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫:** `handle_service_status_list(chat_id)`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ —É—Å–ª—É–≥–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–∞
- –°—Ç–∞—Ç—É—Å—ã: Pending ‚è≥, Approved ‚úÖ, Rejected ‚ùå

**–ü—Ä–∏–º–µ—Ä:**
```
–ü–∞—Ä—Ç–Ω—ë—Ä: üõ†Ô∏è –£—Å–ª—É–≥–∏ ‚Üí üîç –ú–æ–∏ —É—Å–ª—É–≥–∏
–ë–æ—Ç: üìã –í–∞—à–∏ —É—Å–ª—É–≥–∏:

     ‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–∞–ø—É—á–∏–Ω–æ
        üíé –°—Ç–æ–∏–º–æ—Å—Ç—å: 150 –±–∞–ª–ª–æ–≤ | –°—Ç–∞—Ç—É—Å: Approved
        
     ‚è≥ –°–∫–∏–¥–∫–∞ 500 —Ä—É–± –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É
        üíé –°—Ç–æ–∏–º–æ—Å—Ç—å: 500 –±–∞–ª–ª–æ–≤ | –°—Ç–∞—Ç—É—Å: Pending
        
     ‚ùå –ú–∞–Ω–∏–∫—é—Ä —Å–æ —Å–∫–∏–¥–∫–æ–π
        üíé –°—Ç–æ–∏–º–æ—Å—Ç—å: 300 –±–∞–ª–ª–æ–≤ | –°—Ç–∞—Ç—É—Å: Rejected
```

---

### 9. –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞

#### `handle_find_client(message)` ‚Üí "üë§ –ù–∞–π—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞"

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª–∏–µ–Ω—Ç–µ

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫:** `process_client_phone_search(message)`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ó–∞–ø—Ä–æ—Å –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
2. –ü–æ–∏—Å–∫ –≤ –ë–î —á–µ—Ä–µ–∑ `sm.get_client_by_phone(phone)`
3. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

**–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**
- –ò–º—è
- –¢–µ–ª–µ—Ñ–æ–Ω
- –ë–∞–ª–∞–Ω—Å
- –°—Ç–∞—Ç—É—Å
- Chat ID

**–ü—Ä–∏–º–µ—Ä:**
```
–ü–∞—Ä—Ç–Ω—ë—Ä: üë§ –ù–∞–π—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞
–ë–æ—Ç: üì± –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 79991234567)
–ü–∞—Ä—Ç–Ω—ë—Ä: 79991234567
–ë–æ—Ç: ‚úÖ –ö–ª–∏–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω:

     üë§ –ò–º—è: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤
     üì± –¢–µ–ª–µ—Ñ–æ–Ω: 79991234567
     üí∞ –ë–∞–ª–∞–Ω—Å: 250 –±–∞–ª–ª–æ–≤
     üìä –°—Ç–∞—Ç—É—Å: active
     üÜî Chat ID: 123456789
```

**–ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω:**
```
–ë–æ—Ç: ‚ùå –ö–ª–∏–µ–Ω—Ç —Å –Ω–æ–º–µ—Ä–æ–º 79999999999 –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ.
```

---

### 10. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–∞

#### `handle_partner_settings(message)` ‚Üí "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏"

**–ú–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫:**

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫:** `handle_settings_callbacks(call)`

#### A. –ú–æ—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ‚Üí `call.data == 'settings_info'`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –∏–∑ –ë–î
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
  - –ò–º—è
  - –ö–æ–º–ø–∞–Ω–∏—è
  - –¢–µ–ª–µ—Ñ–æ–Ω
  - –°—Ç–∞—Ç—É—Å
  - Chat ID

**–ü—Ä–∏–º–µ—Ä:**
```
–ü–∞—Ä—Ç–Ω—ë—Ä: ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí ‚ÑπÔ∏è –ú–æ—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
–ë–æ—Ç: **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–º –∞–∫–∫–∞—É–Ω—Ç–µ:**

     üë§ –ò–º—è: –°–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã "–í–µ—Ä—Å–∞–ª—å"
     üè¢ –ö–æ–º–ø–∞–Ω–∏—è: –û–û–û "–í–µ—Ä—Å–∞–ª—å"
     üì± –¢–µ–ª–µ—Ñ–æ–Ω: 79991234567
     üìä –°—Ç–∞—Ç—É—Å: Approved
     üÜî Chat ID: 987654321
```

#### B. –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å ‚Üí `call.data == 'settings_bonus'`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –±–æ–Ω—É—Å–∞
- –ù–∞–ø—Ä–∞–≤–ª—è–µ—Ç –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä:**
```
–ü–∞—Ä—Ç–Ω—ë—Ä: ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí üéÅ –ò–∑–º–µ–Ω–∏—Ç—å –±–æ–Ω—É—Å
–ë–æ—Ç: ‚ÑπÔ∏è –¢–µ–∫—É—â–∏–π –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å: 100 –±–∞–ª–ª–æ–≤.
     
     –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
```

---

### 11. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

#### `send_nps_request(chat_id, partner_chat_id)`
**–ò–º–ø–æ—Ä—Ç:** `from client_handler import send_nps_request`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç NPS –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç—É —á–µ—Ä–µ–∑ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –±–æ—Ç
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–∞—Ä—Ç–Ω—ë—Ä –Ω–∞—á–∏—Å–ª—è–µ—Ç –±–∞–ª–ª—ã
2. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è
3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è NPS –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç—É
4. –ö–ª–∏–µ–Ω—Ç –≤–∏–¥–∏—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –æ—Ü–µ–Ω–∫–∞–º–∏ 0-10

---

### 12. –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

```python
USER_STATE = {}    # –•—Ä–∞–Ω–∏—Ç —Ç–µ–∫—É—â–∏–π —à–∞–≥ –¥–∏–∞–ª–æ–≥–∞
TEMP_DATA = {}     # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏
```

**–°–æ—Å—Ç–æ—è–Ω–∏—è:**
- `awaiting_client_id_issue` - –æ–∂–∏–¥–∞–Ω–∏–µ ID –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
- `awaiting_client_id_spend` - –æ–∂–∏–¥–∞–Ω–∏–µ ID –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è
- `awaiting_amount` - –æ–∂–∏–¥–∞–Ω–∏–µ —Å—É–º–º—ã
- `awaiting_promo_title` - —Å–æ–∑–¥–∞–Ω–∏–µ –∞–∫—Ü–∏–∏ (—à–∞–≥ 1)
- `awaiting_promo_description` - —Å–æ–∑–¥–∞–Ω–∏–µ –∞–∫—Ü–∏–∏ (—à–∞–≥ 2)
- `awaiting_promo_discount` - —Å–æ–∑–¥–∞–Ω–∏–µ –∞–∫—Ü–∏–∏ (—à–∞–≥ 3)
- `awaiting_promo_end_date` - —Å–æ–∑–¥–∞–Ω–∏–µ –∞–∫—Ü–∏–∏ (—à–∞–≥ 4)
- `awaiting_service_title` - —Å–æ–∑–¥–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ (—à–∞–≥ 1)
- `awaiting_service_description` - —Å–æ–∑–¥–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ (—à–∞–≥ 2)
- `awaiting_service_price` - —Å–æ–∑–¥–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ (—à–∞–≥ 3)
- `awaiting_client_phone_search` - –ø–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞

---

## üë§ –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –±–æ—Ç (client_handler.py)

**–¢–æ–∫–µ–Ω:** `TOKEN_CLIENT`  
**–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è:** –ö–ª–∏–µ–Ω—Ç—ã (–∫–æ–Ω–µ—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤

#### `handle_new_user_start(message)` 
**–ö–æ–º–∞–Ω–¥—ã:** `/start`, `/help`

**–°—Ü–µ–Ω–∞—Ä–∏–∏:**

#### A. –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç (–±–µ–∑ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏)

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
2. –ï—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí –ø–æ–∫–∞–∑ –∫–Ω–æ–ø–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

**–ö–Ω–æ–ø–∫–∏:**
- "‚úÖ –Ø –ö–ª–∏–µ–Ω—Ç" ‚Üí —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- "ü§ù –Ø –•–æ—á—É —Å—Ç–∞—Ç—å –ü–∞—Ä—Ç–Ω–µ—Ä–æ–º" ‚Üí —Å—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞—è–≤–∫—É –ø–∞—Ä—Ç–Ω—ë—Ä–∞

**–°—Å—ã–ª–∫–∏:**
```
CLIENT_URL = https://tma-bot-rewards.lovable.app/register?chat_id={chat_id}&role=client
PARTNER_URL = https://tma-bot-rewards.lovable.app/partner-apply?chat_id={chat_id}&role=partner
```

**–ü—Ä–∏–º–µ—Ä:**
```
–ö–ª–∏–µ–Ω—Ç: /start
–ë–æ—Ç: üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!
     [‚úÖ –Ø –ö–ª–∏–µ–Ω—Ç]
     [ü§ù –Ø –•–æ—á—É —Å—Ç–∞—Ç—å –ü–∞—Ä—Ç–Ω–µ—Ä–æ–º]
```

#### B. –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç (–ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ)

**–§–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏:** `/start partner_12345`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–∞—Ä—Å–∏–Ω–≥ `partner_id` –∏–∑ —Å—Å—ã–ª–∫–∏ (regex: `partner_(\d+)`)
2. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ `sm.register_client_via_link()`
3. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –±–æ–Ω—É—Å–∞ (100 –±–∞–ª–ª–æ–≤)
4. –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –ø–∞—Ä—Ç–Ω—ë—Ä—É
5. –ó–∞–ø–∏—Å—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ `enrollment_bonus`

**–ü—Ä–∏–º–µ—Ä:**
```
–ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ: t.me/mindbeatybot?start=partner_12345

–ë–æ—Ç: üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!
     
     –í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –ø–æ —Å—Å—ã–ª–∫–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ 
     –∏ –ø–æ–ª—É—á–∏–ª–∏ 100 –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤!
```

**–í –ë–î:**
- –¢–∞–±–ª–∏—Ü–∞ `users`:
  - `chat_id` = ID –∫–ª–∏–µ–Ω—Ç–∞
  - `balance` = 100
  - `referral_source` = "12345"
  - `registered_via` = "partner_link"

- –¢–∞–±–ª–∏—Ü–∞ `transactions`:
  - `operation_type` = "enrollment_bonus"
  - `earned_points` = 100

#### C. –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–ª–∏–µ–Ω—Ç

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ ID (–µ—Å–ª–∏ –±—ã–ª `VIA_PARTNER_xxx`)
3. –ü–æ–∫–∞–∑ –∫–Ω–æ–ø–∫–∏ "–û—Ç–∫—Ä—ã—Ç—å –õ–∏—á–Ω—ã–π –ö–∞–±–∏–Ω–µ—Ç"

**–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–±–∏–Ω–µ—Ç:**
```
CLIENT_URL = https://tma-bot-rewards.lovable.app/client-dashboard?chat_id={chat_id}#home
```

**–ü—Ä–∏–º–µ—Ä:**
```
–ö–ª–∏–µ–Ω—Ç: /start
–ë–æ—Ç: üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!
     [üîë –û—Ç–∫—Ä—ã—Ç—å –õ–∏—á–Ω—ã–π –ö–∞–±–∏–Ω–µ—Ç]
```

---

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ ID

#### –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ `VIA_PARTNER_xxx`

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
1. –ü–∞—Ä—Ç–Ω—ë—Ä —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –≤—Ä—É—á–Ω—É—é –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
2. –í –ë–î —Å–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–ø–∏—Å—å —Å `chat_id = VIA_PARTNER_79991234567`
3. –ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –Ω–∞–∂–∏–º–∞–µ—Ç `/start` –≤ –±–æ—Ç–µ
4. –°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç ID –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π

**–§—É–Ω–∫—Ü–∏—è:** `sm.update_client_chat_id(old_id, new_id)`

**–û–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Ç–∞–±–ª–∏—Ü—ã:**
- `users` (chat_id)
- `transactions` (client_chat_id)
- `nps_ratings` (client_chat_id)

---

### 3. NPS –æ—Ü–µ–Ω–∫–∏

#### `send_nps_request(chat_id, partner_chat_id)`

**–¢—Ä–∏–≥–≥–µ—Ä:**
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–≥–æ –±–æ—Ç–∞ –ø–æ—Å–ª–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `partner_chat_id` –≤ `LAST_TRANSACTION_PARTNER[chat_id]`
2. –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å –æ—Ü–µ–Ω–∫–∞–º–∏ 0-10
3. –ö–ª–∏–µ–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—Ç –æ—Ü–µ–Ω–∫—É
4. Callback –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è

**–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞:**
```
[ 0 ][ 1 ][ 2 ][ 3 ][ 4 ][ 5 ]
[ 6 ][ 7 ][ 8 ][ 9 ][ 10 ]
```

**–°–æ–æ–±—â–µ–Ω–∏–µ:**
```
‚≠ê –û—Ü–µ–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∫–∞—á–µ—Å—Ç–≤–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è!

–ù–∞—Å–∫–æ–ª—å–∫–æ –≤–µ—Ä–æ—è—Ç–Ω–æ, —á—Ç–æ –≤—ã –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç–µ –Ω–∞—Å 
–¥—Ä—É–≥—É –∏–ª–∏ –∫–æ–ª–ª–µ–≥–µ?

(0 - –∫—Ä–∞–π–Ω–µ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ, 10 - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É—é)
```

#### `callback_nps_rating(call)`
**Trigger:** `call.data.startswith('nps_rate_')`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ –∏–∑ `call.data` (–Ω–∞–ø—Ä–∏–º–µ—Ä: `nps_rate_9` ‚Üí 9)
2. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ `partner_chat_id` –∏–∑ `LAST_TRANSACTION_PARTNER`
3. –ó–∞–ø–∏—Å—å –≤ –ë–î —á–µ—Ä–µ–∑ `sm.record_nps_rating()`
4. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏

**–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞:**
```
–ë–æ—Ç: ‚≠ê –û—Ü–µ–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è!
     [–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ 0-10]
     
–ö–ª–∏–µ–Ω—Ç: [–Ω–∞–∂–∏–º–∞–µ—Ç 9]

–ë–æ—Ç: ‚≠ê –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à—É –æ—Ü–µ–Ω–∫—É: 9!
     –í–∞—à–µ –º–Ω–µ–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞–º —Å—Ç–∞—Ç—å –ª—É—á—à–µ.
```

**–í –ë–î (—Ç–∞–±–ª–∏—Ü–∞ `nps_ratings`):**
```
client_chat_id: "123456"
partner_chat_id: "partner_1"
rating: 9
master_name: "N/A"
created_at: "2025-10-22 14:30:00"
```

---

### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

#### `handle_all_messages(message)`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ù–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ `/start`

**–ü—Ä–∏–º–µ—Ä:**
```
–ö–ª–∏–µ–Ω—Ç: –ü—Ä–∏–≤–µ—Ç
–ë–æ—Ç: –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ —Å –∫–æ–º–∞–Ω–¥—ã /start.
```

---

### 5. –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

```python
LAST_TRANSACTION_PARTNER = {}  # –•—Ä–∞–Ω–∏—Ç partner_id –¥–ª—è NPS
BASE_DOMAIN = "https://tma-bot-rewards.lovable.app"
REFERRAL_PATTERN = re.compile(r'partner_(\d+)', re.IGNORECASE)
```

---

## üë®‚Äçüíº –ê–¥–º–∏–Ω –±–æ—Ç (admin_bot.py)

**–¢–æ–∫–µ–Ω:** `ADMIN_BOT_TOKEN`  
**–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è:** –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã —Å–∏—Å—Ç–µ–º—ã

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞

#### `is_admin(chat_id)`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ `chat_id` –≤ `ADMIN_CHAT_ID`
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–æ–≤ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)

**–ü—Ä–∏–º–µ—Ä `.env`:**
```env
ADMIN_CHAT_ID=123456789,987654321
```

---

### 2. –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

#### `handle_start_admin(message)`
**–ö–æ–º–∞–Ω–¥—ã:** `/start`, `/admin`

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ï—Å–ª–∏ –Ω–µ –∞–¥–º–∏–Ω ‚Üí "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
- –ï—Å–ª–∏ –∞–¥–º–∏–Ω ‚Üí –ø–æ–∫–∞–∑ –º–µ–Ω—é

**–ö–Ω–æ–ø–∫–∏:**
- ü§ù –ó–∞—è–≤–∫–∏ –ü–∞—Ä—Ç–Ω–µ—Ä–æ–≤
- ‚ú® –ú–æ–¥–µ—Ä–∞—Ü–∏—è –£—Å–ª—É–≥
- üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

**–ü—Ä–∏–º–µ—Ä:**
```
–ê–¥–º–∏–Ω: /start
–ë–æ—Ç: üëã –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
     
     [ü§ù –ó–∞—è–≤–∫–∏ –ü–∞—Ä—Ç–Ω–µ—Ä–æ–≤]
     [‚ú® –ú–æ–¥–µ—Ä–∞—Ü–∏—è –£—Å–ª—É–≥]
     [üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞]
```

---

### 3. –ú–æ–¥–µ—Ä–∞—Ü–∏—è –∑–∞—è–≤–æ–∫ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤

#### `show_pending_partners(callback_query)`
**Trigger:** callback `admin_partners`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ –∏–∑ –ë–î
2. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É `Pending`
3. –î–ª—è –∫–∞–∂–¥–æ–π –∑–∞—è–≤–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–∞–º–∏

**–§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:**
```
**–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ (ID: 123456)**
üë§ –ò–º—è: –°–∞–ª–æ–Ω "–í–µ—Ä—Å–∞–ª—å"
üìû –¢–µ–ª–µ—Ñ–æ–Ω: 79991234567
üè¢ –ö–æ–º–ø–∞–Ω–∏—è: –û–û–û "–í–µ—Ä—Å–∞–ª—å"
üìÖ –î–∞—Ç–∞: 2025-10-20

[üü¢ –û–¥–æ–±—Ä–∏—Ç—å] [üî¥ –û—Ç–∫–ª–æ–Ω–∏—Ç—å]
```

#### `handle_partner_approval(callback_query)`
**Triggers:** 
- `partner_approve_{id}`
- `partner_reject_{id}`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–∞—Ä—Å–∏–Ω–≥ `partner_id` –∏–∑ `callback_data`
2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ `db_manager.update_partner_status()`
3. –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä—É

**–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä—É:**

**–û–¥–æ–±—Ä–µ–Ω–æ:**
```
üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –û–î–û–ë–†–ï–ù!
–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤—Å–µ–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏.
–ù–∞–∂–º–∏—Ç–µ /start, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–∞–±–æ—á–µ–µ –º–µ–Ω—é.
```

**–û—Ç–∫–ª–æ–Ω–µ–Ω–æ:**
```
‚ùå –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ü–∞—Ä—Ç–Ω–µ—Ä–∞ –±—ã–ª–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.
–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.
```

**–§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏:** `send_partner_notification(partner_chat_id, text)`

---

### 4. –ú–æ–¥–µ—Ä–∞—Ü–∏—è —É—Å–ª—É–≥

#### `show_pending_services(callback_query)`
**Trigger:** callback `admin_services`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ó–∞–≥—Ä—É–∑–∫–∞ —É—Å–ª—É–≥ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `Pending`
2. –î–ª—è –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è

**–§–æ—Ä–º–∞—Ç:**
```
**–ù–æ–≤–∞—è –£—Å–ª—É–≥–∞ –Ω–∞ –ú–æ–¥–µ—Ä–∞—Ü–∏–∏ (ID: 15)**
ü§ù –ü–∞—Ä—Ç–Ω–µ—Ä ID: partner_123
üíé –ù–∞–∑–≤–∞–Ω–∏–µ: –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–∞–ø—É—á–∏–Ω–æ
üíµ –°—Ç–æ–∏–º–æ—Å—Ç—å: 150 –±–∞–ª–ª–æ–≤
üìù –û–ø–∏—Å–∞–Ω–∏–µ: –ü–æ–ª—É—á–∏—Ç–µ –∫–∞–ø—É—á–∏–Ω–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ...

[üü¢ –û–¥–æ–±—Ä–∏—Ç—å] [üî¥ –û—Ç–∫–ª–æ–Ω–∏—Ç—å]
```

#### `handle_service_approval(callback_query)`
**Triggers:**
- `service_approve_{id}`
- `service_reject_{id}`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–∞—Ä—Å–∏–Ω–≥ `service_id`
2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `db_manager.update_service_approval_status()`
3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞)

**–ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
```
**–ù–æ–≤–∞—è –£—Å–ª—É–≥–∞ –Ω–∞ –ú–æ–¥–µ—Ä–∞—Ü–∏–∏ (ID: 15)**

**–°–¢–ê–¢–£–°: üü¢ –û–¥–æ–±—Ä–µ–Ω–∞**
```

---

### 5. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–∫–∞—Ö

#### `watch_new_partner_applications(poll_interval_sec=30)`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ (asyncio)
- –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ë–î
- –ù–∞—Ö–æ–¥–∏—Ç –Ω–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ –≤ —Å—Ç–∞—Ç—É—Å–µ `Pending`
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º

**–ú–µ—Ö–∞–Ω–∏–∑–º:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `_notified_pending_partner_ids` (set) –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
- –ï—Å–ª–∏ ID –Ω–µ –≤ –º–Ω–æ–∂–µ—Å—Ç–≤–µ ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ + –¥–æ–±–∞–≤–∏—Ç—å –≤ set

**–§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏:** `_notify_admins_about_partner(partner_row)`

**–ü—Ä–∏–º–µ—Ä:**
```
[–ü–∞—Ä—Ç–Ω—ë—Ä –ø–æ–¥–∞—ë—Ç –∑–∞—è–≤–∫—É —á–µ—Ä–µ–∑ –≤–µ–±-—Ñ–æ—Ä–º—É]

[–ß–µ—Ä–µ–∑ –º–∞–∫—Å–∏–º—É–º 30 —Å–µ–∫—É–Ω–¥ –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º –ø—Ä–∏—Ö–æ–¥–∏—Ç:]

**–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ (ID: 999888)**
üë§ –ò–º—è: –ö–∞—Ñ–µ "–£—é—Ç"
üìû –¢–µ–ª–µ—Ñ–æ–Ω: 79997778899
üè¢ –ö–æ–º–ø–∞–Ω–∏—è: –ò–ü –ò–≤–∞–Ω–æ–≤
üìÖ –î–∞—Ç–∞: 2025-10-22

[üü¢ –û–¥–æ–±—Ä–∏—Ç—å] [üî¥ –û—Ç–∫–ª–æ–Ω–∏—Ç—å]
```

---

### 6. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

#### `send_partner_notification(partner_chat_id, text)`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω—ë—Ä—É —á–µ—Ä–µ–∑ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –±–æ—Ç
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `TOKEN_PARTNER` –∏ Telegram Bot API

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
send_partner_notification(
    "123456", 
    "üéâ –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –æ–¥–æ–±—Ä–µ–Ω!"
)
```

---

## üóÑÔ∏è –ú–µ–Ω–µ–¥–∂–µ—Ä –ë–î (supabase_manager.py)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Supabase

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

#### `__init__()`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –°–æ–∑–¥–∞–Ω–∏–µ Supabase –∫–ª–∏–µ–Ω—Ç–∞
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç

**–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã:**
- `CASHBACK_PERCENT = 0.05` (5%)
- `WELCOME_BONUS_AMOUNT` (–∏–∑ .env, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 100)

**–¢–∞–±–ª–∏—Ü—ã:**
- `USER_TABLE = 'users'`
- `TRANSACTION_TABLE = 'transactions'`
- `partner_applications`
- `partners`
- `nps_ratings`
- `promotions`
- `services`

---

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è

#### `client_exists(chat_id: int) -> bool`

**–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:**
1. –ü—Ä—è–º–æ–π `chat_id`
2. –í—Ä–µ–º–µ–Ω–Ω—ã–π ID `VIA_PARTNER_{chat_id}`

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `True` –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω, –∏–Ω–∞—á–µ `False`

#### `partner_exists(chat_id: int) -> bool`

**–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:** –Ω–∞–ª–∏—á–∏–µ –≤ —Ç–∞–±–ª–∏—Ü–µ `partner_applications`

---

### 3. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤

#### `handle_manual_registration(phone, partner_id, welcome_bonus) -> tuple[str, str|None]`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º –≤—Ä—É—á–Ω—É—é (–ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É)

**–°—Ü–µ–Ω–∞—Ä–∏–∏:**

**1. –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç:**
- –°–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º ID: `VIA_PARTNER_{phone}`
- –ù–∞—á–∏—Å–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å
- –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é `enrollment_bonus`
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (—Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—Ö–∞, None)

**2. –ö–ª–∏–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –±–∞–ª–∞–Ω—Å = 0:**
- –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å
- –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç –∫ –ø–∞—Ä—Ç–Ω—ë—Ä—É
- –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (—Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –∞–∫—Ç–∏–≤–∞—Ü–∏–∏, None)

**3. –ö–ª–∏–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –±–æ–Ω—É—Å —É–∂–µ –±—ã–ª:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ `enrollment_bonus`
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (—Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, "–ë–û–ù–£–°_–£–ñ–ï_–ê–ö–¢–ò–í–ò–†–û–í–ê–ù")

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `(message_for_bot, error_code)`

#### `register_client_via_link(chat_id, partner_chat_id, phone, name, welcome_bonus) -> tuple`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
2. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ `users`
3. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–∞
4. –ó–∞–ø–∏—Å—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (success_message, None) –∏–ª–∏ (None, error_message)

---

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Chat ID

#### `update_client_chat_id(old_id: str, new_id: str) -> bool`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –û–±–Ω–æ–≤–ª—è–µ—Ç `VIA_PARTNER_xxx` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π ID
- –û–±–Ω–æ–≤–ª—è–µ—Ç 3 —Ç–∞–±–ª–∏—Ü—ã:
  - `users.chat_id`
  - `transactions.client_chat_id`
  - `nps_ratings.client_chat_id`

**–ü—Ä–∏–º–µ—Ä:**
```python
update_client_chat_id(
    "VIA_PARTNER_79991234567",
    "123456789"
)
```

---

### 5. –ë–∞–ª–∞–Ω—Å –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

#### `get_client_balance(chat_id: int) -> int`

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ –≤ –±–∞–ª–ª–∞—Ö

#### `execute_transaction(client_chat_id, partner_chat_id, txn_type, raw_amount) -> dict`

**–¢–∏–ø—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:**
- `'accrual'` - –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤
- `'spend'` - —Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤

**–ü—Ä–æ—Ü–µ—Å—Å –¥–ª—è `accrual`:**
1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞
2. –†–∞—Å—á—ë—Ç –±–∞–ª–ª–æ–≤: `int(raw_amount * 0.05)`
3. –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: `current + points`
4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
5. –ó–∞–ø–∏—Å—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**–ü—Ä–æ—Ü–µ—Å—Å –¥–ª—è `spend`:**
1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞
2. –ü—Ä–æ–≤–µ—Ä–∫–∞: `points <= balance`
3. –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Üí –æ—à–∏–±–∫–∞
4. –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: `current - points`
5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
6. –ó–∞–ø–∏—Å—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```python
{
    'success': True,
    'new_balance': 150,
    'points': 50
}
```

–ò–ª–∏:
```python
{
    'success': False,
    'error': '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–Ω—É—Å–æ–≤',
    'new_balance': 30
}
```

#### `record_transaction(client_chat_id, partner_chat_id, points, transaction_type, description, raw_amount) -> bool`

**–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ —Ç–∞–±–ª–∏—Ü—É `transactions`**

**–ü–æ–ª—è:**
- `client_chat_id`
- `partner_chat_id`
- `date_time`
- `total_amount` (—Å—É–º–º–∞ —á–µ–∫–∞ –≤ —Ä—É–±–ª—è—Ö)
- `earned_points` (–Ω–∞—á–∏—Å–ª–µ–Ω–æ)
- `spent_points` (—Å–ø–∏—Å–∞–Ω–æ)
- `operation_type` (accrual/redemption/enrollment_bonus)
- `description`

---

### 6. –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤

#### `get_client_by_phone(phone: str) -> dict | None`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –û—á–∏—â–∞–µ—Ç –Ω–æ–º–µ—Ä –æ—Ç +, –ø—Ä–æ–±–µ–ª–æ–≤, –¥–µ—Ñ–∏—Å–æ–≤
- –ò—â–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ `users` –ø–æ –ø–æ–ª—é `phone`
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–≤—É—é –Ω–∞–π–¥–µ–Ω–Ω—É—é –∑–∞–ø–∏—Å—å –∏–ª–∏ None

**–ü—Ä–∏–º–µ—Ä:**
```python
client = sm.get_client_by_phone("79991234567")
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
{
    'chat_id': '123456',
    'name': '–ò–≤–∞–Ω',
    'balance': 500,
    'phone': '79991234567',
    ...
}
```

#### `get_client_details_for_partner(client_chat_id: int) -> dict | None`

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:**
- –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
- –ê–Ω–∞–ª–∏—Ç–∏–∫—É (LTV, —á–∞—Å—Ç–æ—Ç–∞ –≤–∏–∑–∏—Ç–æ–≤)

**–ü—Ä–∏–º–µ—Ä:**
```python
{
    'chat_id': '123456',
    'name': '–ò–≤–∞–Ω',
    'balance': 500,
    'status': 'active',
    'phone': '79991234567',
    'reg_date': '2025-09-01',
    'ltv_rub': 15000.0,
    'total_transactions': 23,
    'freq_per_month': 4.6
}
```

---

### 7. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞

#### `get_client_analytics(client_chat_id: int) -> dict`

**–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç:**
1. **LTV (Lifetime Value):**
   - –°—É–º–º–∞ –≤—Å–µ—Ö —á–µ–∫–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞
   - –¢–æ–ª—å–∫–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ç–∏–ø–∞ `accrual`

2. **–ß–∞—Å—Ç–æ—Ç–∞ –≤–∏–∑–∏—Ç–æ–≤:**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π / –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—è—Ü–µ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

3. **–ú–µ—Å—è—Ü—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:**
   - –û—Ç –¥–∞—Ç—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–æ —Å–µ–≥–æ–¥–Ω—è

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```python
{
    'ltv_rub': 15000.0,
    'total_transactions': 23,
    'months_active': 5,
    'freq_per_month': 4.6,
    'reg_date': '2025-09-01'
}
```

#### `get_partner_stats(partner_chat_id: str) -> dict`

**–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–∞—Ä—Ç–Ω—ë—Ä–∞:**

1. **–ü—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ:**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å `referral_source = partner_chat_id`

2. **–§–∏–Ω–∞–Ω—Å—ã:**
   - –û–±—â–∏–π –æ–±–æ—Ä–æ—Ç (—Å—É–º–º–∞ –≤—Å–µ—Ö `total_amount` –ø–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º `accrual`)
   - –í—Å–µ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–æ –±–∞–ª–ª–æ–≤ (—Å—É–º–º–∞ `earned_points`)
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

3. **NPS:**
   - –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞
   - –ü—Ä–æ–º–æ—É—Ç–µ—Ä—ã (—Ä–µ–π—Ç–∏–Ω–≥ 9-10)
   - –î–µ—Ç—Ä–∞–∫—Ç–æ—Ä—ã (—Ä–µ–π—Ç–∏–Ω–≥ 0-6)

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```python
{
    'total_referrals': 25,
    'total_transactions': 78,
    'total_accrued_points': 7500,
    'total_spent_rub': 150000.0,
    'avg_nps_rating': 8.5,
    'promoters': 52,
    'detractors': 5
}
```

---

### 8. NPS —Ä–µ–π—Ç–∏–Ω–≥–∏

#### `record_nps_rating(client_chat_id, partner_chat_id, rating, master_name) -> bool`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –æ—Ü–µ–Ω–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É `nps_ratings`
- –í–∞–ª–∏–¥–∞—Ü–∏—è: 0 ‚â§ rating ‚â§ 10 (–Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î)

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `True` –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, `False` –ø—Ä–∏ –æ—à–∏–±–∫–µ

---

### 9. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º–∏

#### `get_partner_status(chat_id: int) -> str`

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** 'Approved', 'Pending', 'Rejected', 'Unknown'

#### `approve_partner(chat_id: int) -> bool`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ `Approved`
2. –í—ã–∑—ã–≤–∞–µ—Ç `ensure_partner_record()` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ –≤ `partners`

#### `reject_partner(chat_id: int) -> bool`

**–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ `Rejected`**

#### `update_partner_status(partner_id: str, new_status: str) -> bool`

**–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞**

#### `ensure_partner_record(partner_chat_id: str) -> bool`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `partners`
- –ö–æ–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ `partner_applications`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `upsert` (—Å–æ–∑–¥–∞—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–æ–±–ª—é–¥–µ–Ω–∏–µ foreign key constraints

---

### 10. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ü–∏—è–º–∏

#### `add_promotion(promo_data: dict) -> bool`

**–ü—Ä–∏–Ω–∏–º–∞–µ—Ç:**
```python
{
    'partner_chat_id': '123456',
    'title': '–°–∫–∏–¥–∫–∞ 20%',
    'description': '–°–∫–∏–¥–∫–∞ –Ω–∞ –≤—Å–µ –¥–µ—Å–µ—Ä—Ç—ã',
    'discount_value': '20%',
    'start_date': '2025-10-22',  # YYYY-MM-DD
    'end_date': '2025-12-31'
}
```

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
1. –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –≤ `partners` (FK)
3. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç –∫ —Ñ–æ—Ä–º–∞—Ç—É YYYY-MM-DD

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `True` –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ

---

### 11. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏

#### `add_service(service_data: dict) -> bool`

**–ü—Ä–∏–Ω–∏–º–∞–µ—Ç:**
```python
{
    'partner_chat_id': '123456',
    'title': '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–∞–ø—É—á–∏–Ω–æ',
    'description': '–ü–æ–ª—É—á–∏—Ç–µ –∫–∞–ø—É—á–∏–Ω–æ...',
    'price_points': 150
}
```

**–°—Ç–∞—Ç—É—Å:** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `Pending`

#### `get_pending_services_for_admin() -> pd.DataFrame`

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** DataFrame —Å–æ –≤—Å–µ–º–∏ —É—Å–ª—É–≥–∞–º–∏ –≤ —Å—Ç–∞—Ç—É—Å–µ `Pending`

#### `update_service_approval_status(service_id: int, new_status: str) -> bool`

**–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å:** 'Approved' –∏–ª–∏ 'Rejected'

---

### 12. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö

#### `get_all_clients() -> pd.DataFrame`

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `users`

#### `get_all_partners() -> pd.DataFrame`

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `partner_applications`

#### `get_all_transactions() -> pd.DataFrame`

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `transactions`

---

## üìä –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å (admin_dashboard.py)

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:** Streamlit  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

#### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
```python
TOKEN_PARTNER  # –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
CLIENT_RENAME_MAP  # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
PARTNER_RENAME_MAP  # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤
```

---

### 2. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö

#### `load_data(_sm)`

**–î–µ–∫–æ—Ä–∞—Ç–æ—Ä:** `@st.cache_data(ttl=5)` (–∫—ç—à –Ω–∞ 5 —Å–µ–∫—É–Ω–¥)

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞ —Ä—É—Å—Å–∫–∏–π
- –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```python
clients_df, partners_df, transactions_df
```

---

### 3. –í–∫–ª–∞–¥–∫–∞ "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞"

**–ú–µ—Ç—Ä–∏–∫–∏:**
- –í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤
- –ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- –í—Å–µ–≥–æ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤
- –ó–∞—è–≤–æ–∫ –≤ –æ–∂–∏–¥–∞–Ω–∏–∏

**–ì—Ä–∞—Ñ–∏–∫–∏:**
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É (bar chart)
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ –ø–æ –≥–æ—Ä–æ–¥—É (bar chart)

---

### 4. –í–∫–ª–∞–¥–∫–∞ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ö–ª–∏–µ–Ω—Ç–∞–º–∏"

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –¢–∞–±–ª–∏—Ü–∞ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- –ë–µ–∑ Chat ID (—Å–∫—Ä—ã—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞

---

### 5. –í–∫–ª–∞–¥–∫–∞ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–∞—Ä—Ç–Ω–µ—Ä–∞–º–∏"

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ –≤ —Å—Ç–∞—Ç—É—Å–µ `Pending`
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞:
  - –ò–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, –≥–æ—Ä–æ–¥, —Ä–∞–π–æ–Ω
  - –ö–Ω–æ–ø–∫–∏ "–û–¥–æ–±—Ä–∏—Ç—å" –∏ "–û—Ç–∫–ª–æ–Ω–∏—Ç—å"

#### `approve_partner_callback(chat_id)`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –í—ã–∑–æ–≤ `sm.approve_partner(chat_id)`
2. –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä—É
3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI

#### `reject_partner_callback(chat_id)`

**–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –æ–¥–æ–±—Ä–µ–Ω–∏—é**

#### `send_telegram_notification(chat_id, message)`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram Bot API
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `TOKEN_PARTNER`

---

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (logger_config.py)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### –§—É–Ω–∫—Ü–∏–∏:

#### `setup_logger(name, log_file, level) -> logging.Logger`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `name` - –∏–º—è –ª–æ–≥–≥–µ—Ä–∞ (–æ–±—ã—á–Ω–æ `__name__`)
- `log_file` - –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `level` - —É—Ä–æ–≤–µ–Ω—å (–∏–∑ .env –∏–ª–∏ 'INFO')

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**
- –§–æ—Ä–º–∞—Ç: `%(asctime)s - %(name)s - %(levelname)s - [%(filename)s:%(lineno)d] - %(message)s`
- Console handler (–≤—Å–µ–≥–¥–∞)
- File handler —Å —Ä–æ—Ç–∞—Ü–∏–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
  - –ú–∞–∫—Å —Ä–∞–∑–º–µ—Ä: 10 MB
  - –•—Ä–∞–Ω–∏—Ç—å: 5 —Ñ–∞–π–ª–æ–≤
  - –ö–æ–¥–∏—Ä–æ–≤–∫–∞: UTF-8

#### `log_exception(logger, exception, context)`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –õ–æ–≥–∏—Ä—É–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- –í–∫–ª—é—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π stack trace
- –§–æ—Ä–º–∞—Ç: `{context} | {ExceptionType}: {message}`

#### `get_bot_logger(bot_name) -> logging.Logger`

**–°–æ–∑–¥–∞—ë—Ç –ª–æ–≥–≥–µ—Ä –¥–ª—è –±–æ—Ç–∞:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–º—è —Ñ–∞–π–ª–∞: `logs/{bot_name}_YYYYMMDD.log`
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π logger

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
logger = get_bot_logger('partner_bot')
logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")
logger.error("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è")
log_exception(logger, e, "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞")
```

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –í—Å–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–π: **80+**

| –ú–æ–¥—É–ª—å | –§—É–Ω–∫—Ü–∏–π | –û–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ | Callback handlers |
|--------|---------|--------------|-------------------|
| bot.py | 25 | 15 | 10 |
| client_handler.py | 8 | 5 | 1 |
| admin_bot.py | 12 | 6 | 3 |
| supabase_manager.py | 30 | - | - |
| admin_dashboard.py | 5 | - | - |
| logger_config.py | 3 | - | - |

### –ö–æ–º–∞–Ω–¥—ã–±–æ—Ç–æ–≤: **15+**

| –ë–æ—Ç | –ö–æ–º–∞–Ω–¥—ã |
|-----|---------|
| –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π | /start, /partner_start, /delete_promo |
| –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π | /start, /help |
| –ê–¥–º–∏–Ω | /start, /admin |

### Callback handlers: **20+**

- invite_by_link
- promo_add, promo_manage
- service_add, service_status
- settings_info, settings_bonus
- partner_approve_{id}, partner_reject_{id}
- service_approve_{id}, service_reject_{id}
- nps_rate_{0-10}

---

**–î–æ–∫—É–º–µ–Ω—Ç –æ–±–Ω–æ–≤–ª—ë–Ω:** 22.10.2025  
**–í–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞:** 0.8.0


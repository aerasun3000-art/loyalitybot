# 📚 Справочник функций LoyalityBot

Полный перечень реализованных функций по модулям с описанием и примерами использования.

---

## 📑 Содержание

1. [Партнёрский бот (bot.py)](#партнёрский-бот-botpy)
2. [Клиентский бот (client_handler.py)](#клиентский-бот-client_handlerpy)
3. [Админ бот (admin_bot.py)](#админ-бот-admin_botpy)
4. [Менеджер БД (supabase_manager.py)](#менеджер-бд-supabase_managerpy)
5. [Админ панель (admin_dashboard.py)](#админ-панель-admin_dashboardpy)
6. [Логирование (logger_config.py)](#логирование-logger_configpy)

---

## 🤝 Партнёрский бот (bot.py)

**Токен:** `TOKEN_PARTNER`  
**Целевая аудитория:** Партнёры (владельцы бизнеса)

### 1. Регистрация и доступ

#### `handle_partner_start(message)`
**Команда:** `/start` или `/partner_start`

**Функциональность:**
- Проверяет, является ли пользователь зарегистрированным партнёром
- Проверяет статус партнёра (Pending/Approved/Rejected)
- Перенаправляет в соответствующий интерфейс

**Статусы:**
- `Pending` → "Ваша заявка на рассмотрении"
- `Approved` → Главное меню партнёра
- `Rejected` → "Заявка отклонена"
- Незарегистрирован → Предложение регистрации

**Пример:**
```
Партнёр: /start
Бот: 🤝 **Добро пожаловать в рабочее меню партнера!**
     [Кнопки меню]
```

---

### 2. Главное меню

#### `get_partner_keyboard()`
**Возвращает:** ReplyKeyboardMarkup

**Кнопки:**
- ➕ Начислить баллы
- ➖ Списать баллы
- 🌟 Акции
- 🛠️ Услуги
- 👥 Пригласить клиента
- 📊 Моя статистика
- 👤 Найти клиента
- ⚙️ Настройки

#### `partner_main_menu(chat_id, message_text)`
**Функциональность:**
- Возвращает партнёра в главное меню
- Отправляет клавиатуру с основными функциями

---

### 3. Начисление баллов

#### `handle_partner_menu_buttons(message)` → "➕ Начислить баллы"

**Процесс:**
1. Запрос Chat ID клиента
2. Проверка существования клиента
3. Запрос суммы чека (в рублях)
4. Расчёт баллов (5% от суммы)
5. Начисление баллов
6. Запись транзакции
7. Отправка NPS запроса клиенту

**Обработчики:**
- `process_client_id(message)` - обработка ID клиента
- `process_amount(message)` - обработка суммы чека

**Пример:**
```
Партнёр: ➕ Начислить баллы
Бот: Введите Chat ID клиента
Партнёр: 123456
Бот: Текущий баланс: 100 баллов. Введите сумму чека:
Партнёр: 1000
Бот: ✅ Начислено: 50 баллов. Новый баланс: 150
```

**Расчёт:**
- Сумма чека: 1000 руб
- Кэшбэк: 5% = 50 баллов
- Баланс: 100 + 50 = 150 баллов

---

### 4. Списание баллов

#### `handle_partner_menu_buttons(message)` → "➖ Списать баллы"

**Процесс:**
1. Запрос Chat ID клиента
2. Проверка баланса
3. Запрос количества баллов для списания
4. Проверка достаточности средств
5. Списание баллов
6. Запись транзакции

**Проверки:**
- Баланс >= Списание → ✅ Успешно
- Баланс < Списание → ❌ "Недостаточно бонусов"

**Пример:**
```
Партнёр: ➖ Списать баллы
Бот: Введите Chat ID клиента
Партнёр: 123456
Бот: Текущий баланс: 150 баллов. Введите количество баллов:
Партнёр: 50
Бот: ✅ Списано: 50 баллов. Новый баланс: 100
```

---

### 5. Приглашение клиентов (Реферальная система)

#### `handle_invite_start(message)` → "👥 Пригласить клиента"

**Функциональность:**
- Генерирует уникальную реферальную ссылку
- Формат: `https://t.me/mindbeatybot?start=partner_{PARTNER_ID}`

**Обработчик:** `handle_invite_callbacks(call)` с `call.data == 'invite_by_link'`

**Механизм:**
1. Партнёр получает ссылку
2. Отправляет клиенту
3. Клиент переходит по ссылке
4. Клиент регистрируется
5. Клиент получает приветственный бонус (100 баллов)
6. Клиент привязывается к партнёру

**Пример:**
```
Партнёр: 👥 Пригласить клиента
Бот: [Кнопка: 🔗 Получить реферальную ссылку]
Партнёр: [нажимает кнопку]
Бот: 🔗 Ваша реферальная ссылка:
     https://t.me/mindbeatybot?start=partner_123456
     
     Отправьте клиенту для автоматической регистрации!
```

---

### 6. Статистика партнёра

#### `handle_partner_stats(message)` → "📊 Моя статистика"

**Показатели:**
1. **Привлечение:**
   - Привлечено клиентов (по реферальным ссылкам)

2. **Финансы:**
   - Общий оборот (сумма всех чеков в рублях)
   - Всего начислено баллов
   - Общее количество транзакций

3. **Качество (NPS):**
   - Средняя оценка (Average Rating)
   - Чистый NPS (Net Promoter Score)
   - Промоутеры (оценки 9-10)
   - Детракторы (оценки 0-6)

**Расчёт NPS:**
```
NPS = ((Промоутеры - Детракторы) / Всего оценок) × 100
```

**Пример:**
```
📊 Ваша Статистика
---
Привлечение:
👥 Привлечено клиентов: 25 чел.
---
Финансы:
💰 Общий оборот: 150,000 руб.
🎁 Всего начислено баллов: 7,500
🧾 Транзакций: 78
---
Качество (NPS):
⭐ Средняя оценка: 8.5
📈 Чистый NPS: 65
🟢 Промоутеры (9-10): 52
🔴 Детракторы (0-6): 5
```

---

### 7. Управление акциями

#### A. Создание акции → "🌟 Акции" → "➕ Создать новую акцию"

**Процесс (4 шага):**

**Обработчик:** `handle_promo_callbacks(call)` с `call.data == 'promo_add'`

1. **Шаг 1:** Заголовок акции
   - Обработчик: `process_promo_title(message)`
   - Валидация: минимум 3 символа

2. **Шаг 2:** Описание акции
   - Обработчик: `process_promo_description(message)`
   - Детали и условия

3. **Шаг 3:** Размер скидки/бонуса
   - Обработчик: `process_promo_discount(message)`
   - Пример: "20%" или "x2 бонуса"

4. **Шаг 4:** Дата окончания
   - Обработчик: `process_promo_end_date(message)`
   - Формат: ДД.ММ.ГГГГ
   - Валидация: не может быть в прошлом

**Сохранение:**
- Вызов `sm.add_promotion(promo_data)`
- Запись в таблицу `promotions`
- Отображается в клиентском Web App

**Пример диалога:**
```
Партнёр: 🌟 Акции → ➕ Создать новую акцию
Бот: Шаг 1/4: Введите заголовок
Партнёр: Скидка 20% на десерты
Бот: Шаг 2/4: Введите описание
Партнёр: Скидка на все десерты при покупке от 500 руб
Бот: Шаг 3/4: Размер скидки
Партнёр: 20%
Бот: Шаг 4/4: Дата окончания (ДД.ММ.ГГГГ)
Партнёр: 31.12.2025
Бот: 🎉 Акция успешно создана!
```

#### B. Просмотр и удаление акций → "🌟 Акции" → "⚙️ Редактировать / Удалить"

**Обработчик:** `handle_promo_manage_list(chat_id)`

**Функциональность:**
- Показывает список всех акций партнёра
- Для каждой акции: ID, заголовок, дата окончания

**Удаление акции:**
- Команда: `/delete_promo ID_АКЦИИ`
- Обработчик: `handle_delete_promo(message)`
- Проверка принадлежности акции партнёру
- Удаление из БД

**Пример:**
```
Партнёр: 🌟 Акции → ⚙️ Редактировать / Удалить
Бот: 📋 Ваши акции:

     • Скидка 20% на десерты
       ID: 15 | До: 2025-12-31

     • Двойные баллы по пятницам
       ID: 18 | До: 2025-11-30
       
     💡 Для удаления: /delete_promo ID_АКЦИИ
     
Партнёр: /delete_promo 15
Бот: ✅ Акция ID 15 успешно удалена!
```

---

### 8. Управление услугами

#### A. Добавление услуги → "🛠️ Услуги" → "➕ Добавить новую услугу"

**Процесс (3 шага):**

**Обработчик:** `handle_service_callbacks(call)` с `call.data == 'service_add'`

1. **Шаг 1:** Название услуги
   - Обработчик: `process_service_title(message)`
   - Пример: "Бесплатный кофе"

2. **Шаг 2:** Описание услуги
   - Обработчик: `process_service_description(message)`
   - Подробности, ограничения

3. **Шаг 3:** Стоимость в баллах
   - Обработчик: `process_service_price(message)`
   - Валидация: целое число > 0

**Сохранение:**
- Вызов `sm.add_service(service_data)`
- Статус: `Pending` (ожидает одобрения админа)
- Запись в таблицу `services`

**Пример:**
```
Партнёр: 🛠️ Услуги → ➕ Добавить новую услугу
Бот: Шаг 1/3: Название
Партнёр: Бесплатный капучино
Бот: Шаг 2/3: Описание
Партнёр: Получите капучино бесплатно. Действительно с 10:00 до 12:00
Бот: Шаг 3/3: Стоимость в баллах
Партнёр: 150
Бот: ✅ Услуга отправлена на модерацию!
     Администратор рассмотрит вашу заявку.
```

#### B. Просмотр статуса услуг → "🛠️ Услуги" → "🔍 Мои услуги (статус)"

**Обработчик:** `handle_service_status_list(chat_id)`

**Функциональность:**
- Показывает все услуги партнёра
- Статусы: Pending ⏳, Approved ✅, Rejected ❌

**Пример:**
```
Партнёр: 🛠️ Услуги → 🔍 Мои услуги
Бот: 📋 Ваши услуги:

     ✅ Бесплатный капучино
        💎 Стоимость: 150 баллов | Статус: Approved
        
     ⏳ Скидка 500 руб на стрижку
        💎 Стоимость: 500 баллов | Статус: Pending
        
     ❌ Маникюр со скидкой
        💎 Стоимость: 300 баллов | Статус: Rejected
```

---

### 9. Поиск клиента

#### `handle_find_client(message)` → "👤 Найти клиента"

**Функциональность:**
- Поиск клиента по номеру телефона
- Отображение информации о клиенте

**Обработчик:** `process_client_phone_search(message)`

**Процесс:**
1. Запрос номера телефона
2. Поиск в БД через `sm.get_client_by_phone(phone)`
3. Отображение результата

**Отображаемая информация:**
- Имя
- Телефон
- Баланс
- Статус
- Chat ID

**Пример:**
```
Партнёр: 👤 Найти клиента
Бот: 📱 Введите номер телефона (например: 79991234567)
Партнёр: 79991234567
Бот: ✅ Клиент найден:

     👤 Имя: Иван Петров
     📱 Телефон: 79991234567
     💰 Баланс: 250 баллов
     📊 Статус: active
     🆔 Chat ID: 123456789
```

**Если не найден:**
```
Бот: ❌ Клиент с номером 79999999999 не найден в системе.
```

---

### 10. Настройки партнёра

#### `handle_partner_settings(message)` → "⚙️ Настройки"

**Меню настроек:**

**Обработчик:** `handle_settings_callbacks(call)`

#### A. Моя информация → `call.data == 'settings_info'`

**Функциональность:**
- Отображает данные партнёра из БД
- Информация:
  - Имя
  - Компания
  - Телефон
  - Статус
  - Chat ID

**Пример:**
```
Партнёр: ⚙️ Настройки → ℹ️ Моя информация
Бот: **Информация о вашем аккаунте:**

     👤 Имя: Салон красоты "Версаль"
     🏢 Компания: ООО "Версаль"
     📱 Телефон: 79991234567
     📊 Статус: Approved
     🆔 Chat ID: 987654321
```

#### B. Изменить приветственный бонус → `call.data == 'settings_bonus'`

**Функциональность:**
- Показывает текущее значение бонуса
- Направляет к администратору для изменения

**Пример:**
```
Партнёр: ⚙️ Настройки → 🎁 Изменить бонус
Бот: ℹ️ Текущий приветственный бонус: 100 баллов.
     
     Для изменения обратитесь к администратору.
```

---

### 11. Вспомогательные функции

#### `send_nps_request(chat_id, partner_chat_id)`
**Импорт:** `from client_handler import send_nps_request`

**Функциональность:**
- Отправляет NPS запрос клиенту через клиентский бот
- Вызывается после каждой транзакции начисления

**Процесс:**
1. Партнёр начисляет баллы
2. Транзакция завершается
3. Автоматически отправляется NPS запрос клиенту
4. Клиент видит клавиатуру с оценками 0-10

---

### 12. Глобальные переменные состояния

```python
USER_STATE = {}    # Хранит текущий шаг диалога
TEMP_DATA = {}     # Временные данные сессии
```

**Состояния:**
- `awaiting_client_id_issue` - ожидание ID для начисления
- `awaiting_client_id_spend` - ожидание ID для списания
- `awaiting_amount` - ожидание суммы
- `awaiting_promo_title` - создание акции (шаг 1)
- `awaiting_promo_description` - создание акции (шаг 2)
- `awaiting_promo_discount` - создание акции (шаг 3)
- `awaiting_promo_end_date` - создание акции (шаг 4)
- `awaiting_service_title` - создание услуги (шаг 1)
- `awaiting_service_description` - создание услуги (шаг 2)
- `awaiting_service_price` - создание услуги (шаг 3)
- `awaiting_client_phone_search` - поиск клиента

---

## 👤 Клиентский бот (client_handler.py)

**Токен:** `TOKEN_CLIENT`  
**Целевая аудитория:** Клиенты (конечные пользователи)

### 1. Регистрация клиентов

#### `handle_new_user_start(message)` 
**Команды:** `/start`, `/help`

**Сценарии:**

#### A. Новый клиент (без реферальной ссылки)

**Процесс:**
1. Проверка существования клиента
2. Если не существует → показ кнопок регистрации

**Кнопки:**
- "✅ Я Клиент" → ссылка на фронтенд регистрации
- "🤝 Я Хочу стать Партнером" → ссылка на заявку партнёра

**Ссылки:**
```
CLIENT_URL = https://tma-bot-rewards.lovable.app/register?chat_id={chat_id}&role=client
PARTNER_URL = https://tma-bot-rewards.lovable.app/partner-apply?chat_id={chat_id}&role=partner
```

**Пример:**
```
Клиент: /start
Бот: 👋 Добро пожаловать!
     [✅ Я Клиент]
     [🤝 Я Хочу стать Партнером]
```

#### B. Новый клиент (по реферальной ссылке)

**Формат ссылки:** `/start partner_12345`

**Процесс:**
1. Парсинг `partner_id` из ссылки (regex: `partner_(\d+)`)
2. Регистрация через `sm.register_client_via_link()`
3. Начисление приветственного бонуса (100 баллов)
4. Привязка к партнёру
5. Запись транзакции `enrollment_bonus`

**Пример:**
```
Клиент переходит по ссылке: t.me/mindbeatybot?start=partner_12345

Бот: 🎉 Добро пожаловать!
     
     Вы зарегистрировались по ссылке партнера 
     и получили 100 приветственных баллов!
```

**В БД:**
- Таблица `users`:
  - `chat_id` = ID клиента
  - `balance` = 100
  - `referral_source` = "12345"
  - `registered_via` = "partner_link"

- Таблица `transactions`:
  - `operation_type` = "enrollment_bonus"
  - `earned_points` = 100

#### C. Существующий клиент

**Процесс:**
1. Проверка, что клиент уже зарегистрирован
2. Обновление временного ID (если был `VIA_PARTNER_xxx`)
3. Показ кнопки "Открыть Личный Кабинет"

**Ссылка на кабинет:**
```
CLIENT_URL = https://tma-bot-rewards.lovable.app/client-dashboard?chat_id={chat_id}#home
```

**Пример:**
```
Клиент: /start
Бот: 👋 Здравствуйте!
     [🔑 Открыть Личный Кабинет]
```

---

### 2. Обновление временного ID

#### Логика обработки `VIA_PARTNER_xxx`

**Сценарий:**
1. Партнёр регистрирует клиента вручную по телефону
2. В БД создаётся запись с `chat_id = VIA_PARTNER_79991234567`
3. Клиент первый раз нажимает `/start` в боте
4. Система обновляет ID на реальный

**Функция:** `sm.update_client_chat_id(old_id, new_id)`

**Обновляются таблицы:**
- `users` (chat_id)
- `transactions` (client_chat_id)
- `nps_ratings` (client_chat_id)

---

### 3. NPS оценки

#### `send_nps_request(chat_id, partner_chat_id)`

**Триггер:**
- Вызывается из партнёрского бота после начисления баллов

**Процесс:**
1. Сохранение `partner_chat_id` в `LAST_TRANSACTION_PARTNER[chat_id]`
2. Отправка клавиатуры с оценками 0-10
3. Клиент выбирает оценку
4. Callback обрабатывается

**Клавиатура:**
```
[ 0 ][ 1 ][ 2 ][ 3 ][ 4 ][ 5 ]
[ 6 ][ 7 ][ 8 ][ 9 ][ 10 ]
```

**Сообщение:**
```
⭐ Оцените, пожалуйста, качество обслуживания!

Насколько вероятно, что вы порекомендуете нас 
другу или коллеге?

(0 - крайне маловероятно, 10 - обязательно порекомендую)
```

#### `callback_nps_rating(call)`
**Trigger:** `call.data.startswith('nps_rate_')`

**Процесс:**
1. Извлечение оценки из `call.data` (например: `nps_rate_9` → 9)
2. Извлечение `partner_chat_id` из `LAST_TRANSACTION_PARTNER`
3. Запись в БД через `sm.record_nps_rating()`
4. Отображение благодарности

**Пример диалога:**
```
Бот: ⭐ Оцените качество обслуживания!
     [Клавиатура 0-10]
     
Клиент: [нажимает 9]

Бот: ⭐ Спасибо за вашу оценку: 9!
     Ваше мнение помогает нам стать лучше.
```

**В БД (таблица `nps_ratings`):**
```
client_chat_id: "123456"
partner_chat_id: "partner_1"
rating: 9
master_name: "N/A"
created_at: "2025-10-22 14:30:00"
```

---

### 4. Обработка всех сообщений

#### `handle_all_messages(message)`

**Функциональность:**
- Перехватывает все текстовые сообщения
- Направляет на `/start`

**Пример:**
```
Клиент: Привет
Бот: Пожалуйста, начните с команды /start.
```

---

### 5. Глобальные переменные

```python
LAST_TRANSACTION_PARTNER = {}  # Хранит partner_id для NPS
BASE_DOMAIN = "https://tma-bot-rewards.lovable.app"
REFERRAL_PATTERN = re.compile(r'partner_(\d+)', re.IGNORECASE)
```

---

## 👨‍💼 Админ бот (admin_bot.py)

**Токен:** `ADMIN_BOT_TOKEN`  
**Целевая аудитория:** Администраторы системы

### 1. Проверка доступа

#### `is_admin(chat_id)`

**Функциональность:**
- Проверяет, есть ли `chat_id` в `ADMIN_CHAT_ID`
- Поддерживает несколько админов (через запятую)

**Пример `.env`:**
```env
ADMIN_CHAT_ID=123456789,987654321
```

---

### 2. Главное меню

#### `handle_start_admin(message)`
**Команды:** `/start`, `/admin`

**Проверка:**
- Если не админ → "У вас нет прав администратора"
- Если админ → показ меню

**Кнопки:**
- 🤝 Заявки Партнеров
- ✨ Модерация Услуг
- 📊 Общая статистика

**Пример:**
```
Админ: /start
Бот: 👋 Админ-панель
     
     [🤝 Заявки Партнеров]
     [✨ Модерация Услуг]
     [📊 Общая статистика]
```

---

### 3. Модерация заявок партнёров

#### `show_pending_partners(callback_query)`
**Trigger:** callback `admin_partners`

**Процесс:**
1. Загрузка всех партнёров из БД
2. Фильтрация по статусу `Pending`
3. Для каждой заявки отправка отдельного сообщения с кнопками

**Формат сообщения:**
```
**Новая заявка на Партнерство (ID: 123456)**
👤 Имя: Салон "Версаль"
📞 Телефон: 79991234567
🏢 Компания: ООО "Версаль"
📅 Дата: 2025-10-20

[🟢 Одобрить] [🔴 Отклонить]
```

#### `handle_partner_approval(callback_query)`
**Triggers:** 
- `partner_approve_{id}`
- `partner_reject_{id}`

**Процесс:**
1. Парсинг `partner_id` из `callback_data`
2. Обновление статуса через `db_manager.update_partner_status()`
3. Отправка уведомления партнёру

**Уведомления партнёру:**

**Одобрено:**
```
🎉 Поздравляем! Ваш аккаунт партнера ОДОБРЕН!
Теперь вы можете пользоваться всеми функциями.
Нажмите /start, чтобы увидеть рабочее меню.
```

**Отклонено:**
```
❌ Ваша заявка Партнера была отклонена.
Пожалуйста, свяжитесь с Администратором.
```

**Функция отправки:** `send_partner_notification(partner_chat_id, text)`

---

### 4. Модерация услуг

#### `show_pending_services(callback_query)`
**Trigger:** callback `admin_services`

**Процесс:**
1. Загрузка услуг со статусом `Pending`
2. Для каждой услуги отправка сообщения

**Формат:**
```
**Новая Услуга на Модерации (ID: 15)**
🤝 Партнер ID: partner_123
💎 Название: Бесплатный капучино
💵 Стоимость: 150 баллов
📝 Описание: Получите капучино бесплатно...

[🟢 Одобрить] [🔴 Отклонить]
```

#### `handle_service_approval(callback_query)`
**Triggers:**
- `service_approve_{id}`
- `service_reject_{id}`

**Процесс:**
1. Парсинг `service_id`
2. Обновление через `db_manager.update_service_approval_status()`
3. Обновление сообщения (добавление статуса)

**После обработки:**
```
**Новая Услуга на Модерации (ID: 15)**

**СТАТУС: 🟢 Одобрена**
```

---

### 5. Автоматические уведомления о новых заявках

#### `watch_new_partner_applications(poll_interval_sec=30)`

**Функциональность:**
- Фоновая задача (asyncio)
- Каждые 30 секунд проверяет БД
- Находит новые заявки в статусе `Pending`
- Отправляет уведомление всем админам

**Механизм:**
- Использует `_notified_pending_partner_ids` (set) для отслеживания
- Если ID не в множестве → отправить уведомление + добавить в set

**Функция отправки:** `_notify_admins_about_partner(partner_row)`

**Пример:**
```
[Партнёр подаёт заявку через веб-форму]

[Через максимум 30 секунд всем админам приходит:]

**Новая заявка на Партнерство (ID: 999888)**
👤 Имя: Кафе "Уют"
📞 Телефон: 79997778899
🏢 Компания: ИП Иванов
📅 Дата: 2025-10-22

[🟢 Одобрить] [🔴 Отклонить]
```

---

### 6. Вспомогательные функции

#### `send_partner_notification(partner_chat_id, text)`

**Функциональность:**
- Отправляет сообщение партнёру через партнёрский бот
- Использует `TOKEN_PARTNER` и Telegram Bot API

**Пример использования:**
```python
send_partner_notification(
    "123456", 
    "🎉 Ваш аккаунт одобрен!"
)
```

---

## 🗄️ Менеджер БД (supabase_manager.py)

**Назначение:** Единая точка доступа к базе данных Supabase

### 1. Инициализация

#### `__init__()`

**Функциональность:**
- Загрузка переменных окружения
- Создание Supabase клиента
- Установка констант

**Константы:**
- `CASHBACK_PERCENT = 0.05` (5%)
- `WELCOME_BONUS_AMOUNT` (из .env, по умолчанию 100)

**Таблицы:**
- `USER_TABLE = 'users'`
- `TRANSACTION_TABLE = 'transactions'`
- `partner_applications`
- `partners`
- `nps_ratings`
- `promotions`
- `services`

---

### 2. Проверка существования

#### `client_exists(chat_id: int) -> bool`

**Проверяет:**
1. Прямой `chat_id`
2. Временный ID `VIA_PARTNER_{chat_id}`

**Возвращает:** `True` если клиент найден, иначе `False`

#### `partner_exists(chat_id: int) -> bool`

**Проверяет:** наличие в таблице `partner_applications`

---

### 3. Регистрация клиентов

#### `handle_manual_registration(phone, partner_id, welcome_bonus) -> tuple[str, str|None]`

**Назначение:** Регистрация клиента партнёром вручную (по телефону)

**Сценарии:**

**1. Новый клиент:**
- Создаёт запись с временным ID: `VIA_PARTNER_{phone}`
- Начисляет приветственный бонус
- Записывает транзакцию `enrollment_bonus`
- Возвращает: (сообщение успеха, None)

**2. Клиент существует, баланс = 0:**
- Обновляет баланс
- Привязывает к партнёру
- Записывает транзакцию
- Возвращает: (сообщение об активации, None)

**3. Клиент существует, бонус уже был:**
- Проверяет наличие транзакции `enrollment_bonus`
- Возвращает: (сообщение об ошибке, "БОНУС_УЖЕ_АКТИВИРОВАН")

**Возвращает:** `(message_for_bot, error_code)`

#### `register_client_via_link(chat_id, partner_chat_id, phone, name, welcome_bonus) -> tuple`

**Назначение:** Регистрация по реферальной ссылке

**Процесс:**
1. Проверка, что клиент не существует
2. Создание записи в `users`
3. Начисление бонуса
4. Запись транзакции
5. Возвращает: (success_message, None) или (None, error_message)

---

### 4. Обновление Chat ID

#### `update_client_chat_id(old_id: str, new_id: str) -> bool`

**Функциональность:**
- Обновляет `VIA_PARTNER_xxx` на реальный ID
- Обновляет 3 таблицы:
  - `users.chat_id`
  - `transactions.client_chat_id`
  - `nps_ratings.client_chat_id`

**Пример:**
```python
update_client_chat_id(
    "VIA_PARTNER_79991234567",
    "123456789"
)
```

---

### 5. Баланс и транзакции

#### `get_client_balance(chat_id: int) -> int`

**Возвращает:** текущий баланс клиента в баллах

#### `execute_transaction(client_chat_id, partner_chat_id, txn_type, raw_amount) -> dict`

**Типы транзакций:**
- `'accrual'` - начисление баллов
- `'spend'` - списание баллов

**Процесс для `accrual`:**
1. Получение текущего баланса
2. Расчёт баллов: `int(raw_amount * 0.05)`
3. Новый баланс: `current + points`
4. Обновление баланса
5. Запись транзакции

**Процесс для `spend`:**
1. Получение текущего баланса
2. Проверка: `points <= balance`
3. Если недостаточно → ошибка
4. Новый баланс: `current - points`
5. Обновление баланса
6. Запись транзакции

**Возвращает:**
```python
{
    'success': True,
    'new_balance': 150,
    'points': 50
}
```

Или:
```python
{
    'success': False,
    'error': 'Недостаточно бонусов',
    'new_balance': 30
}
```

#### `record_transaction(client_chat_id, partner_chat_id, points, transaction_type, description, raw_amount) -> bool`

**Записывает транзакцию в таблицу `transactions`**

**Поля:**
- `client_chat_id`
- `partner_chat_id`
- `date_time`
- `total_amount` (сумма чека в рублях)
- `earned_points` (начислено)
- `spent_points` (списано)
- `operation_type` (accrual/redemption/enrollment_bonus)
- `description`

---

### 6. Поиск клиентов

#### `get_client_by_phone(phone: str) -> dict | None`

**Функциональность:**
- Очищает номер от +, пробелов, дефисов
- Ищет в таблице `users` по полю `phone`
- Возвращает первую найденную запись или None

**Пример:**
```python
client = sm.get_client_by_phone("79991234567")
# Возвращает:
{
    'chat_id': '123456',
    'name': 'Иван',
    'balance': 500,
    'phone': '79991234567',
    ...
}
```

#### `get_client_details_for_partner(client_chat_id: int) -> dict | None`

**Возвращает расширенную информацию:**
- Основные данные клиента
- Аналитику (LTV, частота визитов)

**Пример:**
```python
{
    'chat_id': '123456',
    'name': 'Иван',
    'balance': 500,
    'status': 'active',
    'phone': '79991234567',
    'reg_date': '2025-09-01',
    'ltv_rub': 15000.0,
    'total_transactions': 23,
    'freq_per_month': 4.6
}
```

---

### 7. Аналитика

#### `get_client_analytics(client_chat_id: int) -> dict`

**Рассчитывает:**
1. **LTV (Lifetime Value):**
   - Сумма всех чеков клиента
   - Только транзакции типа `accrual`

2. **Частота визитов:**
   - Количество транзакций / количество месяцев активности

3. **Месяцы активности:**
   - От даты регистрации до сегодня

**Возвращает:**
```python
{
    'ltv_rub': 15000.0,
    'total_transactions': 23,
    'months_active': 5,
    'freq_per_month': 4.6,
    'reg_date': '2025-09-01'
}
```

#### `get_partner_stats(partner_chat_id: str) -> dict`

**Рассчитывает статистику партнёра:**

1. **Привлечение:**
   - Количество клиентов с `referral_source = partner_chat_id`

2. **Финансы:**
   - Общий оборот (сумма всех `total_amount` по транзакциям `accrual`)
   - Всего начислено баллов (сумма `earned_points`)
   - Количество транзакций

3. **NPS:**
   - Средняя оценка
   - Промоутеры (рейтинг 9-10)
   - Детракторы (рейтинг 0-6)

**Возвращает:**
```python
{
    'total_referrals': 25,
    'total_transactions': 78,
    'total_accrued_points': 7500,
    'total_spent_rub': 150000.0,
    'avg_nps_rating': 8.5,
    'promoters': 52,
    'detractors': 5
}
```

---

### 8. NPS рейтинги

#### `record_nps_rating(client_chat_id, partner_chat_id, rating, master_name) -> bool`

**Функциональность:**
- Записывает оценку в таблицу `nps_ratings`
- Валидация: 0 ≤ rating ≤ 10 (на уровне БД)

**Возвращает:** `True` если успешно, `False` при ошибке

---

### 9. Управление партнёрами

#### `get_partner_status(chat_id: int) -> str`

**Возвращает:** 'Approved', 'Pending', 'Rejected', 'Unknown'

#### `approve_partner(chat_id: int) -> bool`

**Процесс:**
1. Обновляет статус на `Approved`
2. Вызывает `ensure_partner_record()` для создания записи в `partners`

#### `reject_partner(chat_id: int) -> bool`

**Обновляет статус на `Rejected`**

#### `update_partner_status(partner_id: str, new_status: str) -> bool`

**Универсальная функция обновления статуса**

#### `ensure_partner_record(partner_chat_id: str) -> bool`

**Функциональность:**
- Гарантирует наличие записи в таблице `partners`
- Копирует данные из `partner_applications`
- Использует `upsert` (создать или обновить)

**Назначение:** Соблюдение foreign key constraints

---

### 10. Управление акциями

#### `add_promotion(promo_data: dict) -> bool`

**Принимает:**
```python
{
    'partner_chat_id': '123456',
    'title': 'Скидка 20%',
    'description': 'Скидка на все десерты',
    'discount_value': '20%',
    'start_date': '2025-10-22',  # YYYY-MM-DD
    'end_date': '2025-12-31'
}
```

**Проверки:**
1. Валидация обязательных полей
2. Проверка существования партнёра в `partners` (FK)
3. Нормализация дат к формату YYYY-MM-DD

**Возвращает:** `True` если успешно

---

### 11. Управление услугами

#### `add_service(service_data: dict) -> bool`

**Принимает:**
```python
{
    'partner_chat_id': '123456',
    'title': 'Бесплатный капучино',
    'description': 'Получите капучино...',
    'price_points': 150
}
```

**Статус:** автоматически устанавливается `Pending`

#### `get_pending_services_for_admin() -> pd.DataFrame`

**Возвращает:** DataFrame со всеми услугами в статусе `Pending`

#### `update_service_approval_status(service_id: int, new_status: str) -> bool`

**Обновляет статус:** 'Approved' или 'Rejected'

---

### 12. Загрузка данных

#### `get_all_clients() -> pd.DataFrame`

**Возвращает:** все записи из таблицы `users`

#### `get_all_partners() -> pd.DataFrame`

**Возвращает:** все записи из таблицы `partner_applications`

#### `get_all_transactions() -> pd.DataFrame`

**Возвращает:** все записи из таблицы `transactions`

---

## 📊 Админ панель (admin_dashboard.py)

**Технология:** Streamlit  
**Назначение:** Визуализация данных и управление

### 1. Конфигурация

#### Переменные:
```python
TOKEN_PARTNER  # Для отправки уведомлений
CLIENT_RENAME_MAP  # Переименование колонок клиентов
PARTNER_RENAME_MAP  # Переименование колонок партнёров
```

---

### 2. Загрузка данных

#### `load_data(_sm)`

**Декоратор:** `@st.cache_data(ttl=5)` (кэш на 5 секунд)

**Функциональность:**
- Загружает данные из БД
- Переименовывает колонки на русский
- Нормализует типы данных

**Возвращает:**
```python
clients_df, partners_df, transactions_df
```

---

### 3. Вкладка "Аналитика"

**Метрики:**
- Всего клиентов
- Активных клиентов
- Всего партнёров
- Заявок в ожидании

**Графики:**
- Распределение клиентов по статусу (bar chart)
- Распределение партнёров по городу (bar chart)

---

### 4. Вкладка "Управление Клиентами"

**Функциональность:**
- Таблица всех клиентов
- Без Chat ID (скрыт для безопасности)
- Полноэкранная ширина

---

### 5. Вкладка "Управление Партнерами"

**Функциональность:**
- Показывает только партнёров в статусе `Pending`
- Для каждого партнёра:
  - Имя, телефон, город, район
  - Кнопки "Одобрить" и "Отклонить"

#### `approve_partner_callback(chat_id)`

**Процесс:**
1. Вызов `sm.approve_partner(chat_id)`
2. Отправка уведомления партнёру
3. Обновление UI

#### `reject_partner_callback(chat_id)`

**Аналогично одобрению**

#### `send_telegram_notification(chat_id, message)`

**Функциональность:**
- Отправка через Telegram Bot API
- Использует `TOKEN_PARTNER`

---

## 📝 Логирование (logger_config.py)

**Назначение:** Централизованная система логирования

### Функции:

#### `setup_logger(name, log_file, level) -> logging.Logger`

**Параметры:**
- `name` - имя логгера (обычно `__name__`)
- `log_file` - путь к файлу (опционально)
- `level` - уровень (из .env или 'INFO')

**Настройки:**
- Формат: `%(asctime)s - %(name)s - %(levelname)s - [%(filename)s:%(lineno)d] - %(message)s`
- Console handler (всегда)
- File handler с ротацией (опционально):
  - Макс размер: 10 MB
  - Хранить: 5 файлов
  - Кодировка: UTF-8

#### `log_exception(logger, exception, context)`

**Функциональность:**
- Логирует исключение с контекстом
- Включает полный stack trace
- Формат: `{context} | {ExceptionType}: {message}`

#### `get_bot_logger(bot_name) -> logging.Logger`

**Создаёт логгер для бота:**
- Автоматическое имя файла: `logs/{bot_name}_YYYYMMDD.log`
- Возвращает настроенный logger

**Пример использования:**
```python
logger = get_bot_logger('partner_bot')
logger.info("Бот запущен")
logger.error("Ошибка соединения")
log_exception(logger, e, "Критическая ошибка")
```

---

## 📊 Итоговая статистика

### Всего функций: **80+**

| Модуль | Функций | Обработчиков | Callback handlers |
|--------|---------|--------------|-------------------|
| bot.py | 25 | 15 | 10 |
| client_handler.py | 8 | 5 | 1 |
| admin_bot.py | 12 | 6 | 3 |
| supabase_manager.py | 30 | - | - |
| admin_dashboard.py | 5 | - | - |
| logger_config.py | 3 | - | - |

### Командыботов: **15+**

| Бот | Команды |
|-----|---------|
| Партнёрский | /start, /partner_start, /delete_promo |
| Клиентский | /start, /help |
| Админ | /start, /admin |

### Callback handlers: **20+**

- invite_by_link
- promo_add, promo_manage
- service_add, service_status
- settings_info, settings_bonus
- partner_approve_{id}, partner_reject_{id}
- service_approve_{id}, service_reject_{id}
- nps_rate_{0-10}

---

**Документ обновлён:** 22.10.2025  
**Версия проекта:** 0.8.0


#!/usr/bin/env python3
"""
–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –≤ Linear –¥–ª—è –¥–Ω–µ–π 3-6 –≠–∫–æ—Å–∏—Å—Ç–µ–º—ã 2.0
"""

import os
import sys
import time
from linear_task_creator import create_linear_task, get_teams

# –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
PRIORITY_MAP = {
    "P0": 1,  # Urgent
    "P1": 2,  # High
    "P2": 3,  # Medium
    "P3": 4   # Low
}

TASKS = [
    {
        "id": "DAY3-WORKMODE",
        "title": "–î–µ–Ω—å 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –ø–æ work_mode",
        "description": """**–ó–∞–¥–∞—á–∞:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –ø–æ —Ä–µ–∂–∏–º—É —Ä–∞–±–æ—Ç—ã.

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
1. –û–Ω–ª–∞–π–Ω –ø–∞—Ä—Ç–Ω–µ—Ä—ã (work_mode='online') –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤–æ –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–∞—Ö
2. –ì–∏–±—Ä–∏–¥–Ω—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä—ã (work_mode='hybrid') –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤–æ –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–∞—Ö
3. –û—Ñ—Ñ–ª–∞–π–Ω –ø–∞—Ä—Ç–Ω–µ—Ä—ã (work_mode='offline') –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Å–≤–æ–µ–º –≥–æ—Ä–æ–¥–µ

**–§–∞–π–ª—ã:**
- `frontend/src/services/supabase.js` - —Ñ—É–Ω–∫—Ü–∏—è `getFilteredServices`
- `frontend/src/pages/Services.jsx` - —Ñ—É–Ω–∫—Ü–∏—è `isOnlinePartner`

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ö–ª–∏–µ–Ω—Ç –≤ –ù—è—á–∞–Ω–≥–µ –≤–∏–¥–∏—Ç –æ–Ω–ª–∞–π–Ω-–ø—Å–∏—Ö–æ–ª–æ–≥–∞ –∏–∑ –ú–æ—Å–∫–≤—ã
- –ö–ª–∏–µ–Ω—Ç –≤ –ú–æ—Å–∫–≤–µ –ù–ï –≤–∏–¥–∏—Ç –æ—Ñ—Ñ–ª–∞–π–Ω-—Å–∞–ª–æ–Ω –∏–∑ –ù—è—á–∞–Ω–≥–∞
- –ì–∏–±—Ä–∏–¥–Ω—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä—ã –≤–∏–¥–Ω—ã –≤–µ–∑–¥–µ""",
        "priority": PRIORITY_MAP["P1"]
    },
    {
        "id": "DAY4-CATEGORY-FILTERS",
        "title": "–î–µ–Ω—å 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –Ω–∞ –≥–ª–∞–≤–Ω–æ–π",
        "description": """**–ó–∞–¥–∞—á–∞:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ category_group –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
1. –¢–∞–±—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è: –í—Å–µ / –ö—Ä–∞—Å–æ—Ç–∞ / –ï–¥–∞ / –ú–∞–≥–∞–∑–∏–Ω—ã / –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ / –ë–ª–æ–≥–µ—Ä—ã
2. –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ç–∞–± —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è —É—Å–ª—É–≥–∏ –ø–æ category_group –ø–∞—Ä—Ç–Ω–µ—Ä–∞
3. –¢–∞–± "–í—Å–µ" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ —É—Å–ª—É–≥–∏ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
4. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

**–§–∞–π–ª—ã:**
- `frontend/src/pages/Home.jsx` - —Ñ—É–Ω–∫—Ü–∏—è `getServiceTiles()` –∏ —Ç–∞–±—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ö–ª–∏–∫ –Ω–∞ "–ï–¥–∞" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã
- –ö–ª–∏–∫ –Ω–∞ "–ë–ª–æ–≥–µ—Ä—ã" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –±–ª–æ–≥–µ—Ä–æ–≤
- –ö–ª–∏–∫ –Ω–∞ "–í—Å–µ" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ —É—Å–ª—É–≥–∏""",
        "priority": PRIORITY_MAP["P1"]
    },
    {
        "id": "DAY5-B2B-DEALS-CHECK",
        "title": "–î–µ–Ω—å 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ B2B deals –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏",
        "description": """**–ó–∞–¥–∞—á–∞:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ B2B deals –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –±–∞–ª–ª–æ–≤.

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
1. –ú–µ—Ç–æ–¥ `_calculate_accrual_points_with_deals` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ `execute_transaction`
2. –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–¥–µ–ª–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Ü–µ–Ω—Ç –∏–∑ —Å–¥–µ–ª–∫–∏, –∞ –Ω–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π
3. –í –æ–ø–∏—Å–∞–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –º–µ—Ç–∫–∞ "(B2B Deal üî•)"
4. –ï—Å–ª–∏ —Å–¥–µ–ª–∫–∏ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `default_cashback_percent` –ø–∞—Ä—Ç–Ω–µ—Ä–∞

**–§–∞–π–ª—ã:**
- `supabase_manager.py` - –º–µ—Ç–æ–¥—ã `_calculate_accrual_points_with_deals`, `get_active_deal`, `execute_transaction`

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ö–ª–∏–µ–Ω—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç –±–ª–æ–≥–µ—Ä–∞ –∫ —Å–∞–ª–æ–Ω—É ‚Üí –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–æ—Ü–µ–Ω—Ç –∏–∑ —Å–¥–µ–ª–∫–∏
- –ö–ª–∏–µ–Ω—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∞–ø—Ä—è–º—É—é ‚Üí –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –ø–∞—Ä—Ç–Ω–µ—Ä–∞""",
        "priority": PRIORITY_MAP["P0"]
    },
    {
        "id": "DAY6-B2B-BOT-UI",
        "title": "–î–µ–Ω—å 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ MVP –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ B2B deals –≤ –±–æ—Ç–µ",
        "description": """**–ó–∞–¥–∞—á–∞:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è B2B deals –≤ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–º –±–æ—Ç–µ.

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
1. –ö–Ω–æ–ø–∫–∞ "ü§ù –ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ" –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –º–µ–Ω—é "‚öôÔ∏è –ï—â—ë"
2. –°–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏: –≤—ã–±–æ—Ä –ø–∞—Ä—Ç–Ω–µ—Ä–∞ ‚Üí –≤–≤–æ–¥ –∫—ç—à–±—ç–∫–∞ ‚Üí –≤–≤–æ–¥ –∫–æ–º–∏—Å—Å–∏–∏ ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ
3. –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Ö–æ–¥—è—â–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Å –∫–Ω–æ–ø–∫–∞–º–∏ –ü—Ä–∏–Ω—è—Ç—å/–û—Ç–∫–ª–æ–Ω–∏—Ç—å
4. –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
5. –ü—Ä–∏–Ω—è—Ç–∏–µ/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–§–∞–π–ª—ã:**
- `bot.py` - —Ñ—É–Ω–∫—Ü–∏–∏ `handle_partnership_menu`, `show_incoming_deals`, `show_my_deals`, FSM –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–∞—Ä—Ç–Ω–µ—Ä –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É —á–µ—Ä–µ–∑ –±–æ—Ç–∞
- –ü–∞—Ä—Ç–Ω–µ—Ä –≤–∏–¥–∏—Ç –≤—Ö–æ–¥—è—â–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ –º–æ–∂–µ—Ç –∏—Ö –ø—Ä–∏–Ω—è—Ç—å/–æ—Ç–∫–ª–æ–Ω–∏—Ç—å
- –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ""",
        "priority": PRIORITY_MAP["P1"]
    },
    {
        "id": "INTEGRATION-TEST",
        "title": "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª B2B deal",
        "description": """**–ó–∞–¥–∞—á–∞:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã B2B deal –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤.

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
1. –ë–ª–æ–≥–µ—Ä —Å–æ–∑–¥–∞–µ—Ç —Å–¥–µ–ª–∫—É —Å —Å–∞–ª–æ–Ω–æ–º (15% –∫—ç—à–±—ç–∫, 20% –∫–æ–º–∏—Å—Å–∏—è)
2. –°–∞–ª–æ–Ω –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–¥–µ–ª–∫—É
3. –ö–ª–∏–µ–Ω—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ —Å—Å—ã–ª–∫–µ –±–ª–æ–≥–µ—Ä–∞
4. –ö–ª–∏–µ–Ω—Ç –¥–µ–ª–∞–µ—Ç –ø–æ–∫—É–ø–∫—É –≤ —Å–∞–ª–æ–Ω–µ –Ω–∞ 1000 —Ä—É–±
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 150 –±–∞–ª–ª–æ–≤ (15% –æ—Ç 1000)
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å "(B2B Deal üî•)"

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°–¥–µ–ª–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è
- –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É –∏–∑ —Å–¥–µ–ª–∫–∏
- –í —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –µ—Å—Ç—å –º–µ—Ç–∫–∞ –æ B2B deal""",
        "priority": PRIORITY_MAP["P0"]
    }
]

def main():
    """–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á–∏ –≤ Linear"""
    print("üöÄ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –¥–ª—è –¥–Ω–µ–π 3-6 –≠–∫–æ—Å–∏—Å—Ç–µ–º—ã 2.0...\n")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞
    if not os.getenv("LINEAR_API_KEY"):
        print("‚ùå –û—à–∏–±–∫–∞: LINEAR_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
        print("   –î–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á –≤ .env —Ñ–∞–π–ª: LINEAR_API_KEY=your_key_here")
        return
    
    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–∞–Ω–¥—É –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é
    team_key = sys.argv[1] if len(sys.argv) > 1 else None
    project_id = sys.argv[2] if len(sys.argv) > 2 else None
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
    teams_result = get_teams()
    if teams_result["success"]:
        print("üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:")
        for team in teams_result["teams"]:
            print(f"   - {team['key']}: {team['name']}")
        print()
    
    # –°–æ–∑–¥–∞—ë–º –∑–∞–¥–∞—á–∏
    success_count = 0
    failed_count = 0
    
    for task in TASKS:
        result = create_linear_task(
            title=task["title"],
            description=task["description"],
            team_key=team_key,
            priority=task["priority"],
            project_id=project_id
        )
        
        if result["success"]:
            print(f"‚úÖ {task['id']}: {result['identifier']} - {task['title']}")
            print(f"   üîó {result['url']}\n")
            success_count += 1
        else:
            print(f"‚ùå {task['id']}: –û—à–∏–±–∫–∞ - {result.get('error', 'Unknown error')}\n")
            failed_count += 1
        
        time.sleep(0.5)  # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
    
    print(f"\n‚ú® –ì–æ—Ç–æ–≤–æ! –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ: {success_count} –∏–∑ {len(TASKS)}")
    if failed_count > 0:
        print(f"‚ö†Ô∏è  –û—à–∏–±–æ–∫: {failed_count}")

if __name__ == "__main__":
    main()

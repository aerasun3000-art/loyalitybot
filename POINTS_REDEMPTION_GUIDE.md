# üí∏ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –æ–±–º–µ–Ω—É –±–∞–ª–ª–æ–≤ –Ω–∞ —É—Å–ª—É–≥–∏

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –æ–±–º–µ–Ω–∞ –±–∞–ª–ª–æ–≤ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞–º –æ–±–º–µ–Ω–∏–≤–∞—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –±–∞–ª–ª—ã –Ω–∞ —É—Å–ª—É–≥–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤. –í–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω –∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ API.

---

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend  ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> ‚îÇ  Secure API  ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> ‚îÇ  Supabase   ‚îÇ
‚îÇ  (React)    ‚îÇ         ‚îÇ  (FastAPI)   ‚îÇ         ‚îÇ   (Postgres)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ                         ‚îÇ                         ‚îÇ
     ‚îÇ                         ‚îÇ                         ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±–º–µ–Ω –±–∞–ª–ª–æ–≤
```

### 2. **–ü—Ä–æ—Ü–µ—Å—Å –æ–±–º–µ–Ω–∞ –±–∞–ª–ª–æ–≤**

#### –®–∞–≥ 1: –ö–ª–∏–µ–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—Ç —É—Å–ª—É–≥—É
- –ö–ª–∏–µ–Ω—Ç –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É "–ú–æ–∏ –º–∞—Å—Ç–µ—Ä–∞" (`/services`)
- –í–∏–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤ –±–∞–ª–ª–∞—Ö
- –í—ã–±–∏—Ä–∞–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â—É—é —É—Å–ª—É–≥—É

#### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
- –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞
- –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å —Å–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å—é —É—Å–ª—É–≥–∏
- –ï—Å–ª–∏ –±–∞–ª–ª–æ–≤ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ

#### –®–∞–≥ 3: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–±–º–µ–Ω–∞
- –ö–ª–∏–µ–Ω—Ç –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "üí∏ –û–±–º–µ–Ω—è—Ç—å X –±–∞–ª–ª–æ–≤"
- –ü–æ—è–≤–ª—è–µ—Ç—Å—è –¥–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
- –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä

#### –®–∞–≥ 4: –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
```python
# Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
1. –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É—Å–ª—É–≥–∞?
2. –û–¥–æ–±—Ä–µ–Ω–∞ –ª–∏ —É—Å–ª—É–≥–∞ (approval_status = 'Approved')?
3. –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ —É—Å–ª—É–≥–∞ (is_active = True)?
4. –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –±–∞–ª–ª–æ–≤ —É –∫–ª–∏–µ–Ω—Ç–∞?
5. –ü—Ä–∏–≤—è–∑–∞–Ω–∞ –ª–∏ —É—Å–ª—É–≥–∞ –∫ –ø–∞—Ä—Ç–Ω–µ—Ä—É?
```

#### –®–∞–≥ 5: –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤
- –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã ‚Üí –±–∞–ª–ª—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `execute_transaction`
- –°–æ–∑–¥–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Ç–∏–ø–∞ `redemption` –≤ —Ç–∞–±–ª–∏—Ü–µ `transactions`
- –ë–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `users`

#### –®–∞–≥ 6: –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
- Frontend –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç —Å –Ω–æ–≤—ã–º –±–∞–ª–∞–Ω—Å–æ–º
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è UI —Å –Ω–æ–≤—ã–º –±–∞–ª–∞–Ω—Å–æ–º
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞

### Backend (Python)

#### 1. –ú–µ—Ç–æ–¥ –≤ `supabase_manager.py`

```python
def redeem_points_for_service(self, client_chat_id: str, service_id: str) -> dict:
    """
    –û–±–º–µ–Ω–∏–≤–∞–µ—Ç –±–∞–ª–ª—ã –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ —É—Å–ª—É–≥—É.
    
    –ü—Ä–æ—Ü–µ—Å—Å:
    1. –ü–æ–ª—É—á–∞–µ—Ç —É—Å–ª—É–≥—É –ø–æ UUID
    2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å (Approved, is_active)
    3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞
    4. –°–ø–∏—Å—ã–≤–∞–µ—Ç –±–∞–ª–ª—ã —á–µ—Ä–µ–∑ execute_transaction
    5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    """
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:**
- ‚úÖ –£—Å–ª—É–≥–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚úÖ –£—Å–ª—É–≥–∞ –æ–¥–æ–±—Ä–µ–Ω–∞ (`approval_status = 'Approved'`)
- ‚úÖ –£—Å–ª—É–≥–∞ –∞–∫—Ç–∏–≤–Ω–∞ (`is_active = True`)
- ‚úÖ –£—Å–ª—É–≥–∞ –∏–º–µ–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å (`price_points > 0`)
- ‚úÖ –£—Å–ª—É–≥–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –ø–∞—Ä—Ç–Ω–µ—Ä—É
- ‚úÖ –£ –∫–ª–∏–µ–Ω—Ç–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤

#### 2. API Endpoint –≤ `secure_api.py`

```python
POST /api/redeem

Request:
{
    "client_chat_id": "123456789",
    "service_id": "550e8400-e29b-41d4-a716-446655440000"
}

Response (success):
{
    "success": true,
    "new_balance": 50,
    "points_spent": 100,
    "service": {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "title": "–ú–∞–Ω–∏–∫—é—Ä",
        "description": "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –º–∞–Ω–∏–∫—é—Ä",
        "partner_chat_id": "987654321"
    }
}

Response (error):
{
    "success": false,
    "error": "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤. –¢—Ä–µ–±—É–µ—Ç—Å—è: 100, –¥–æ—Å—Ç—É–ø–Ω–æ: 50",
    "new_balance": 50,
    "points_spent": 0
}
```

**Rate Limit:** 10 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É

### Frontend (React)

#### 1. –§—É–Ω–∫—Ü–∏—è –≤ `supabase.js`

```javascript
export const redeemService = async (clientChatId, serviceId) => {
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –∑–∞–ø—Ä–æ—Å –Ω–∞ /api/redeem
  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç
  // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
}
```

#### 2. UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ `Services.jsx`

**–°–æ—Å—Ç–æ—è–Ω–∏—è:**
- `isRedeeming` - –∏–¥–µ—Ç –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –æ–±–º–µ–Ω–∞
- `redeemError` - –æ—à–∏–±–∫–∞ –æ–±–º–µ–Ω–∞
- `redeemSuccess` - —É—Å–ø–µ—à–Ω—ã–π –æ–±–º–µ–Ω

**–§—É–Ω–∫—Ü–∏–∏:**
- `handleRedeemPoints()` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±–º–µ–Ω–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –ø–µ—Ä–µ–¥ –æ–±–º–µ–Ω–æ–º
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `window.confirm()`
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ü—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ `client_chat_id` –∏ `service_id`
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —É—Å–ª—É–≥–∏

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —É—Å–ª—É–≥–∏**
   - –¢–æ–ª—å–∫–æ –æ–¥–æ–±—Ä–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏ (`Approved`)
   - –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ —É—Å–ª—É–≥–∏ (`is_active = True`)

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞**
   - –ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∞–Ω–∏—è
   - –ó–∞—â–∏—Ç–∞ –æ—Ç race conditions —á–µ—Ä–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ë–î

4. **Rate Limiting**
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: 10 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
   - –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π

### –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫

- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –∏ —Å–µ—Ä–≤–µ—Ä–µ
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –æ—á–µ—Ä–µ–¥–∏ –ø—Ä–∏ —Å–±–æ—è—Ö –ë–î

---

## üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `services`

```sql
CREATE TABLE services (
    id UUID PRIMARY KEY,
    partner_chat_id TEXT NOT NULL,
    title TEXT NOT NULL,
    description TEXT,
    price_points INTEGER NOT NULL,
    approval_status TEXT DEFAULT 'Pending',
    is_active BOOLEAN DEFAULT true,
    ...
);
```

**–í–∞–∂–Ω—ã–µ –ø–æ–ª—è:**
- `price_points` - —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ –±–∞–ª–ª–∞—Ö
- `approval_status` - —Å—Ç–∞—Ç—É—Å –æ–¥–æ–±—Ä–µ–Ω–∏—è (`Pending`, `Approved`, `Rejected`)
- `is_active` - –∞–∫—Ç–∏–≤–Ω–∞ –ª–∏ —É—Å–ª—É–≥–∞

### –¢–∞–±–ª–∏—Ü–∞ `transactions`

–ü–æ—Å–ª–µ –æ–±–º–µ–Ω–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å:

```sql
INSERT INTO transactions (
    client_chat_id,
    partner_chat_id,
    operation_type,  -- 'redemption'
    spent_points,    -- –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–∏—Å–∞–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤
    description,     -- "–°–ø–∏—Å–∞–Ω–∏–µ X –±–æ–Ω—É—Å–æ–≤ (–ü–∞—Ä—Ç–Ω–µ—Ä: Y)"
    ...
);
```

### –¢–∞–±–ª–∏—Ü–∞ `users`

–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å:

```sql
UPDATE users 
SET balance = balance - price_points 
WHERE chat_id = client_chat_id;
```

---

## üéØ –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –£—Å–ø–µ—à–Ω—ã–π –æ–±–º–µ–Ω

1. **–ö–ª–∏–µ–Ω—Ç:** –ë–∞–ª–∞–Ω—Å = 150 –±–∞–ª–ª–æ–≤
2. **–£—Å–ª—É–≥–∞:** –ú–∞–Ω–∏–∫—é—Ä, —Å—Ç–æ–∏–º–æ—Å—Ç—å = 100 –±–∞–ª–ª–æ–≤
3. **–î–µ–π—Å—Ç–≤–∏–µ:** –ö–ª–∏–µ–Ω—Ç –Ω–∞–∂–∏–º–∞–µ—Ç "–û–±–º–µ–Ω—è—Ç—å 100 –±–∞–ª–ª–æ–≤"
4. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚úÖ –ë–∞–ª–ª—ã —Å–ø–∏—Å–∞–Ω—ã
   - ‚úÖ –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å = 50 –±–∞–ª–ª–æ–≤
   - ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Ç–∏–ø–∞ `redemption`
   - ‚úÖ –ü–æ–∫–∞–∑–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤

1. **–ö–ª–∏–µ–Ω—Ç:** –ë–∞–ª–∞–Ω—Å = 50 –±–∞–ª–ª–æ–≤
2. **–£—Å–ª—É–≥–∞:** –ú–∞–Ω–∏–∫—é—Ä, —Å—Ç–æ–∏–º–æ—Å—Ç—å = 100 –±–∞–ª–ª–æ–≤
3. **–î–µ–π—Å—Ç–≤–∏–µ:** –ö–ª–∏–µ–Ω—Ç –Ω–∞–∂–∏–º–∞–µ—Ç "–û–±–º–µ–Ω—è—Ç—å 100 –±–∞–ª–ª–æ–≤"
4. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚ùå –ö–Ω–æ–ø–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ (disabled)
   - ‚ùå –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
   - ‚ùå –û–±–º–µ–Ω –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –£—Å–ª—É–≥–∞ –Ω–µ –æ–¥–æ–±—Ä–µ–Ω–∞

1. **–£—Å–ª—É–≥–∞:** –°—Ç–∞—Ç—É—Å = `Pending`
2. **–î–µ–π—Å—Ç–≤–∏–µ:** –ü–æ–ø—ã—Ç–∫–∞ –æ–±–º–µ–Ω–∞
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚ùå –û—à–∏–±–∫–∞: "–£—Å–ª—É–≥–∞ –Ω–µ –æ–¥–æ–±—Ä–µ–Ω–∞ –¥–ª—è –æ–±–º–µ–Ω–∞"
   - ‚ùå –û–±–º–µ–Ω –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è

---

## üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

**Frontend (Netlify):**
```bash
VITE_API_URL=https://your-api-domain.com
```

**Backend (Fly.io):**
```bash
SUPABASE_URL=your-supabase-url
SUPABASE_SERVICE_KEY=your-service-key
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ API:**
```bash
curl -X POST https://your-api-domain.com/api/redeem \
  -H "Content-Type: application/json" \
  -d '{
    "client_chat_id": "123456789",
    "service_id": "550e8400-e29b-41d4-a716-446655440000"
  }'
```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ UI:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —É—Å–ª—É–≥
   - –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É
   - –ù–∞–∂–º–∏—Ç–µ "–û–±–º–µ–Ω—è—Ç—å –±–∞–ª–ª—ã"
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

---

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```python
# –í supabase_manager.py
logging.info(f"Redeeming {price_points} points for service {service_id}")
logging.error(f"Error redeeming points: {e}")
```

### –õ–æ–≥–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
console.log('Redeeming service:', serviceId)
console.error('Redeem error:', error)
```

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **"API URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"**
   - –†–µ—à–µ–Ω–∏–µ: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `VITE_API_URL` –≤ Netlify

2. **"–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `service_id` –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π UUID
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —É—Å–ª—É–≥–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î

3. **"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤"**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `price_points` –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π

4. **"–£—Å–ª—É–≥–∞ –Ω–µ –æ–¥–æ–±—Ä–µ–Ω–∞"**
   - –£—Å–ª—É–≥–∞ –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å `approval_status = 'Approved'`
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

---

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

1. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–º–µ–Ω–æ–≤**
   ```sql
   SELECT COUNT(*) 
   FROM transactions 
   WHERE operation_type = 'redemption';
   ```

2. **–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–±–º–µ–Ω–∞**
   ```sql
   SELECT AVG(spent_points) 
   FROM transactions 
   WHERE operation_type = 'redemption';
   ```

3. **–¢–æ–ø —É—Å–ª—É–≥ –ø–æ –æ–±–º–µ–Ω–∞–º**
   ```sql
   SELECT s.title, COUNT(*) as exchanges
   FROM transactions t
   JOIN services s ON t.partner_chat_id = s.partner_chat_id
   WHERE t.operation_type = 'redemption'
   GROUP BY s.title
   ORDER BY exchanges DESC;
   ```

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º

- [ ] API endpoint `/api/redeem` –¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `VITE_API_URL` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ Netlify
- [ ] –£—Å–ª—É–≥–∏ –∏–º–µ—é—Ç `approval_status = 'Approved'`
- [ ] –£—Å–ª—É–≥–∏ –∏–º–µ—é—Ç `price_points > 0`
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –±–∞–ª–∞–Ω—Å–æ–º
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –±–∞–ª–∞–Ω—Å–æ–º
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –≤ UI

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `supabase_manager.py` - –º–µ—Ç–æ–¥ `redeem_points_for_service()`
- `secure_api.py` - endpoint `/api/redeem`
- `frontend/src/services/supabase.js` - —Ñ—É–Ω–∫—Ü–∏—è `redeemService()`
- `frontend/src/pages/Services.jsx` - UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ–±–º–µ–Ω–∞

---

**–ì–æ—Ç–æ–≤–æ!** üéâ –°–∏—Å—Ç–µ–º–∞ –æ–±–º–µ–Ω–∞ –±–∞–ª–ª–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.






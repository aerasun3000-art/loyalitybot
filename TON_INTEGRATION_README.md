# üí∞ TON –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é

**–î–∞—Ç–∞:** –Ø–Ω–≤–∞—Ä—å 2025  
**–°—Ç–∞—Ç—É—Å:** –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

---

## üìã –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ä–∞–∑–¥–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:
- **–ö—ç—à–±—ç–∫-–±–∞–ª–ª—ã (Off-chain)** - –æ—Å—Ç–∞—é—Ç—Å—è –≤ –ë–î, –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ, –¥–ª—è –≤–æ–≤–ª–µ—á–µ–Ω–∏—è
- **–ö–æ–º–∏—Å—Å–∏–∏ (On-chain)** - –≤—ã–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ TON –±–ª–æ–∫—á–µ–π–Ω, —Ä–µ–∞–ª—å–Ω—ã–µ –¥–µ–Ω—å–≥–∏

---

## üóÑÔ∏è –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

### –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏:**
   ```sql
   -- –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —ç—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:
   -- migrations/create_currency_exchange_rates.sql
   -- migrations/add_currency_to_transactions.sql
   -- migrations/insert_initial_exchange_rates.sql
   ```

2. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è TON:**
   ```sql
   -- 1. –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è TON –≤—ã–ø–ª–∞—Ç
   -- migrations/create_ton_payments_table.sql
   
   -- 2. –ü–æ–ª—è –¥–ª—è TON –≤ partners
   -- migrations/add_ton_to_partners.sql
   
   -- 3. –ü–æ–ª—è USD –≤ partner_revenue_share
   -- migrations/add_usd_to_revenue_share.sql
   
   -- 4. –ü–æ–ª—è USD –≤ referral_rewards
   -- migrations/add_usd_to_referral_rewards.sql
   
   -- 5. –¢–∞–±–ª–∏—Ü–∞ –∫—É—Ä—Å–æ–≤ TON/USD
   -- migrations/create_ton_exchange_rates_table.sql
   ```

**–í–∞–∂–Ω–æ:** –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ Supabase Dashboard ‚Üí SQL Editor

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env` –∏ –≤ Fly.io Secrets:

```bash
# TON Wallet Configuration
TON_WALLET_ADDRESS=EQ...  # –ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
TON_WALLET_SEED=your_seed_phrase_here  # Seed —Ñ—Ä–∞–∑–∞ (–ö–†–ò–¢–ò–ß–ù–û: –≤ —Å–µ–∫—Ä–µ—Ç–∞—Ö!)
TON_NETWORK=testnet  # testnet –∏–ª–∏ mainnet

# TON API Configuration (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ TON Center API)
TON_API_KEY=your_api_key
```

**‚ö†Ô∏è –í–ê–ñ–ù–û:** `TON_WALLET_SEED` - —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è! –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ –≤ git, —Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–ª—å–∫–æ –≤ —Å–µ–∫—Ä–µ—Ç–∞—Ö.

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞ TON/USD

```bash
# –û–±–Ω–æ–≤–∏—Ç—å –∫—É—Ä—Å –∏–∑ Binance
python3 ton_exchange_rate_updater.py --source binance

# –û–±–Ω–æ–≤–∏—Ç—å –∫—É—Ä—Å –∏–∑ CoinGecko
python3 ton_exchange_rate_updater.py --source coingecko
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å cron –∑–∞–¥–∞—á—É –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–∑ –≤ —á–∞—Å.

### 2. –í—ã–ø–ª–∞—Ç–∞ Revenue Share

```bash
# –í—ã–ø–ª–∞—Ç–∏—Ç—å Revenue Share –∑–∞ –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü
python3 cron_payout_processor.py --revenue-share
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:** –ó–∞–ø—É—Å–∫–∞—Ç—å 1-–≥–æ —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞.

### 3. –í—ã–ø–ª–∞—Ç–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–º–∏—Å—Å–∏–π

```bash
# –í—ã–ø–ª–∞—Ç–∏—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –∫–æ–º–∏—Å—Å–∏–∏ (–º–∏–Ω–∏–º—É–º $10)
python3 cron_payout_processor.py --referrals

# –° –¥—Ä—É–≥–∏–º –ø–æ—Ä–æ–≥–æ–º
python3 cron_payout_processor.py --referrals --min-amount 20.0
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:** –ó–∞–ø—É—Å–∫–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –∏–ª–∏ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ.

### 4. –í—Å–µ –≤—ã–ø–ª–∞—Ç—ã

```bash
# –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ —Ç–∏–ø—ã –≤—ã–ø–ª–∞—Ç
python3 cron_payout_processor.py --all
```

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—É—Ä—Å TON/USD:

```sql
SELECT * FROM ton_exchange_rates 
ORDER BY effective_from DESC 
LIMIT 1;
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å pending –∫–æ–º–∏—Å—Å–∏–∏:

```sql
-- Revenue Share
SELECT COUNT(*), SUM(amount_usd) 
FROM partner_revenue_share 
WHERE status = 'approved' AND ton_tx_hash IS NULL;

-- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –∫–æ–º–∏—Å—Å–∏–∏
SELECT referrer_chat_id, SUM(amount_usd) as total
FROM referral_rewards 
WHERE status = 'pending' AND reward_type LIKE 'commission_%'
GROUP BY referrer_chat_id;
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å TON –≤—ã–ø–ª–∞—Ç—ã:

```sql
SELECT * FROM ton_payments 
ORDER BY created_at DESC 
LIMIT 10;
```

---

## üîß –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

- [x] –°–æ–∑–¥–∞–Ω—ã –∑–∞–¥–∞—á–∏ –≤ Linear (MAR-90 - MAR-98)
- [x] –°–æ–∑–¥–∞–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –¥–ª—è TON –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- [x] –°–æ–∑–¥–∞–Ω `ton_payment_service.py` (–±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
- [x] –°–æ–∑–¥–∞–Ω `ton_exchange_rate_updater.py`
- [x] –û–±–Ω–æ–≤–ª–µ–Ω `partner_revenue_share.py` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è `amount_usd`
- [x] –û–±–Ω–æ–≤–ª–µ–Ω `supabase_manager.py` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–º–∏—Å—Å–∏–π —Å `amount_usd`
- [x] –°–æ–∑–¥–∞–Ω `cron_payout_processor.py` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã–ø–ª–∞—Ç

### ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏:

- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É TON —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —á–µ—Ä–µ–∑ pytonlib
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã –≤ Telegram Bot –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å cron –∑–∞–¥–∞—á–∏ –≤ Fly.io
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ testnet
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ mainnet

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏** –≤ Supabase
2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å TON –∫–æ—à–µ–ª–µ–∫** (testnet –¥–ª—è –Ω–∞—á–∞–ª–∞)
3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞ TON/USD
4. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å** —Ä–µ–∞–ª—å–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —á–µ—Ä–µ–∑ pytonlib
5. **–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã** –≤ Telegram Bot
6. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å cron** –∑–∞–¥–∞—á–∏
7. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** –Ω–∞ testnet
8. **–ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å** –Ω–∞ mainnet

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ Seed —Ñ—Ä–∞–∑–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Å–µ–∫—Ä–µ—Ç–∞—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚úÖ –í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `ton_payments`
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–¥—Ä–µ—Å–æ–≤ –∫–æ—à–µ–ª—å–∫–æ–≤
- ‚ö†Ô∏è TODO: –î–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å—É–º–º—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚ö†Ô∏è TODO: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –≤—ã–ø–ª–∞—Ç–∞–º–∏

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- –¢–ó: –°–º. —Ñ–∞–π–ª —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –∑–∞–¥–∞–Ω–∏–µ–º (—Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ä–∞–Ω–µ–µ)
- Linear –∑–∞–¥–∞—á–∏: MAR-90 - MAR-98
- –ú–∏–≥—Ä–∞—Ü–∏–∏: `migrations/*.sql`
- –ö–æ–¥: `ton_payment_service.py`, `ton_exchange_rate_updater.py`, `cron_payout_processor.py`

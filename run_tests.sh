#!/bin/bash
# ะกะบัะธะฟั ะดะปั ะทะฐะฟััะบะฐ ัะตััะพะฒ LoyalityBot

echo "=== LoyalityBot Test Runner ==="
echo ""

# ะัะพะฒะตัะบะฐ ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั
if [ ! -d "venv" ]; then
    echo "โ ะะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต ะฝะต ะฝะฐะนะดะตะฝะพ. ะกะพะทะดะฐะนัะต ะตะณะพ: python3 -m venv venv"
    exit 1
fi

# ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั
echo "๐ฆ ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั..."
source venv/bin/activate

# ะฃััะฐะฝะพะฒะบะฐ ัะตััะพะฒัั ะทะฐะฒะธัะธะผะพััะตะน
echo "๐ฅ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน ะดะปั ัะตััะธัะพะฒะฐะฝะธั..."
pip install -q -r requirements-dev.txt

echo ""
echo "๐งช ะะฐะฟััะบ ัะตััะพะฒ..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# ะะฐะฟััะบ ัะตััะพะฒ ั ะฟะพะบัััะธะตะผ
pytest tests/ -v --cov=. --cov-report=term-missing --cov-report=html

TEST_EXIT_CODE=$?

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

if [ $TEST_EXIT_CODE -eq 0 ]; then
    echo "โ ะัะต ัะตััั ะฟัะพะนะดะตะฝั ััะฟะตัะฝะพ!"
    echo ""
    echo "๐ HTML ะพัััั ะพ ะฟะพะบัััะธะธ ะบะพะดะฐ ัะพะทะดะฐะฝ ะฒ: htmlcov/index.html"
    echo "   ะัะบัะพะนัะต ะฒ ะฑัะฐัะทะตัะต: open htmlcov/index.html"
else
    echo "โ ะะตะบะพัะพััะต ัะตััั ะฟัะพะฒะฐะปะธะปะธัั. ะะพะด ะฒััะพะดะฐ: $TEST_EXIT_CODE"
    exit $TEST_EXIT_CODE
fi

echo ""
echo "=== ะขะตััะธัะพะฒะฐะฝะธะต ะทะฐะฒะตััะตะฝะพ ==="


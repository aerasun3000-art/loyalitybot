# üöÄ –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Cloudflare Webhooks

**–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:** {{ current_date }}  
**–°—Ç–∞—Ç—É—Å:** –í –ø—Ä–æ—Ü–µ—Å—Å–µ  
**–¶–µ–ª—å:** –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤—Å–µ –±–æ—Ç—ã –Ω–∞ webhooks + Cloudflare –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

---

## üìã –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- **3 –±–æ—Ç–∞:** –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π, –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π, –ê–¥–º–∏–Ω-–±–æ—Ç
- **1 REST API:** secure_api.py (FastAPI)
- **–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:** Fly.io (long polling)
- **–ü—Ä–æ–±–ª–µ–º—ã:** –ó–∞–¥–µ—Ä–∂–∫–∞ –≤–æ –í—å–µ—Ç–Ω–∞–º–µ, —Å–ª–æ–∂–Ω–æ—Å—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

### –¶–µ–ª–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- **3 webhook endpoints:** –î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–æ—Ç–∞ (Cloudflare Workers)
- **1 REST API:** –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ Cloudflare Workers
- **–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:** Cloudflare Edge Network
- **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:** –ù–∏–∑–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –≤–µ–∑–¥–µ, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üéØ –≠—Ç–∞–ø—ã –º–∏–≥—Ä–∞—Ü–∏–∏

### ‚úÖ –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–í –ü–†–û–¶–ï–°–°–ï)
- [x] –°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏
- [x] –°–æ–∑–¥–∞—Ç—å TODO –ª–∏—Å—Ç
- [ ] –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è Cloudflare
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º –æ–∫—Ä—É–∂–µ–Ω–∏—è

### ‚è≥ –≠—Ç–∞–ø 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Cloudflare (–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨)
- [ ] –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç Cloudflare (–µ—Å–ª–∏ –Ω–µ—Ç)
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Wrangler CLI
- [ ] –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ `wrangler login`
- [ ] –°–æ–∑–¥–∞—Ç—å workers.dev –¥–æ–º–µ–Ω –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–≤–æ–π –¥–æ–º–µ–Ω

### ‚è≥ –≠—Ç–∞–ø 3: Webhook endpoints –¥–ª—è –±–æ—Ç–æ–≤
- [ ] –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –±–æ—Ç webhook
- [ ] –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π –±–æ—Ç webhook
- [ ] –ê–¥–º–∏–Ω-–±–æ—Ç webhook

### ‚è≥ –≠—Ç–∞–ø 4: –ú–∏–≥—Ä–∞—Ü–∏—è REST API
- [ ] –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å secure_api.py –¥–ª—è Cloudflare Workers
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å endpoints

### ‚è≥ –≠—Ç–∞–ø 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤ –∏ –¥–µ–ø–ª–æ–π
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –≤ Cloudflare
- [ ] –î–µ–ø–ª–æ–π –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –±–æ—Ç–æ–≤ –Ω–∞ webhooks

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
loyalitybot/
‚îú‚îÄ‚îÄ cloudflare/
‚îÇ   ‚îú‚îÄ‚îÄ workers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client-webhook/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ wrangler.toml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ partner-webhook/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ wrangler.toml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin-webhook/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ wrangler.toml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ api/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ index.js
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ wrangler.toml
‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ partner.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ common.js
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ supabase.js
‚îÇ       ‚îî‚îÄ‚îÄ telegram.js
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ setup_webhooks.py
‚îî‚îÄ‚îÄ CLOUDFLARE_MIGRATION_PLAN.md
```

---

## üîê –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–µ–∫—Ä–µ—Ç—ã

–°–ª–µ–¥—É—é—â–∏–µ —Å–µ–∫—Ä–µ—Ç—ã –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ Cloudflare —á–µ—Ä–µ–∑ `wrangler secret put`:

### Telegram –±–æ—Ç—ã
- `TOKEN_CLIENT`
- `TOKEN_PARTNER`
- `ADMIN_BOT_TOKEN`
- `ADMIN_CHAT_ID`

### Supabase
- `SUPABASE_URL`
- `SUPABASE_KEY`

### Sentry
- `SENTRY_DSN`
- `SENTRY_ENVIRONMENT`
- `SENTRY_ALERT_TELEGRAM_TOKEN`
- `SENTRY_ALERT_CHAT_ID`
- `SENTRY_WEBHOOK_SECRET`

### AI
- `OPENAI_API_KEY`
- `OPENAI_MODEL`

### –î—Ä—É–≥–æ–µ
- `WELCOME_BONUS_AMOUNT`
- `LOG_LEVEL`
- `FRONTEND_URL`

---

## üìù –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–µ–ø–ª–æ—è

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Wrangler
npm install -g wrangler

# –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
wrangler login

# –î–µ–ø–ª–æ–π –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –±–æ—Ç–∞
cd cloudflare/workers/client-webhook
wrangler deploy

# –î–µ–ø–ª–æ–π –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–≥–æ –±–æ—Ç–∞
cd cloudflare/workers/partner-webhook
wrangler deploy

# –ò —Ç–∞–∫ –¥–∞–ª–µ–µ...
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ù–µ —É–¥–∞–ª—è—Ç—å —Å—Ç–∞—Ä—ã–π –∫–æ–¥ —Å—Ä–∞–∑—É** - –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ backup
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥–µ** –ø–µ—Ä–µ–¥ production
3. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –≤ Cloudflare Dashboard
4. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**

---

## üìä –ü—Ä–æ–≥—Ä–µ—Å—Å

- [ ] –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
- [ ] –≠—Ç–∞–ø 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Cloudflare
- [ ] –≠—Ç–∞–ø 3: Webhook endpoints
- [ ] –≠—Ç–∞–ø 4: REST API –º–∏–≥—Ä–∞—Ü–∏—è
- [ ] –≠—Ç–∞–ø 5: –î–µ–ø–ª–æ–π –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ

**–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø:** –≠—Ç–∞–ø 1 - –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

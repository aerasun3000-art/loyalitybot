# üí∏ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –æ–ø–ª–∞—Ç–µ –±–∞–ª–ª–∞–º–∏ –≤ –∞–∫—Ü–∏—è—Ö

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞–º **—á–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–∏–≤–∞—Ç—å —É—Å–ª—É–≥–∏ –≤ –∞–∫—Ü–∏—è—Ö –±–∞–ª–ª–∞–º–∏**. –ù–∞–ø—Ä–∏–º–µ—Ä, —É—Å–ª—É–≥–∞ —Å—Ç–æ–∏—Ç $100, –Ω–æ –º–æ–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å $50 –±–∞–ª–ª–∞–º–∏, –∞ –æ—Å—Ç–∞–ª—å–Ω–æ–µ –Ω–∞–ª–∏—á–Ω—ã–º–∏. –ú–∞—Å—Ç–µ—Ä —Å–∫–∞–Ω–∏—Ä—É–µ—Ç QR-–∫–æ–¥, –≤–∏–¥–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π.

---

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–æ—Ü–µ—Å—Å (7 —à–∞–≥–æ–≤):

1. **–ö–ª–∏–µ–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—Ç –∞–∫—Ü–∏—é** ‚Üí –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–∫—Ü–∏–π, –≤–∏–¥–∏—Ç –∞–∫—Ü–∏—é —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –æ–ø–ª–∞—Ç—ã –±–∞–ª–ª–∞–º–∏
2. **–í–≤–æ–¥–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤** ‚Üí –°–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ –¥–æ–ø–ª–∞—Ç–∏—Ç—å –Ω–∞–ª–∏—á–Ω—ã–º–∏
3. **–ù–∞–∂–∏–º–∞–µ—Ç "–û–ø–ª–∞—Ç–∏—Ç—å –±–∞–ª–ª–∞–º–∏"** ‚Üí –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è QR-–∫–æ–¥ —Å –¥–∞–Ω–Ω—ã–º–∏ –æ–± –∞–∫—Ü–∏–∏
4. **–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç QR –º–∞—Å—Ç–µ—Ä—É** ‚Üí –ú–∞—Å—Ç–µ—Ä —Å–∫–∞–Ω–∏—Ä—É–µ—Ç QR-–∫–æ–¥ —á–µ—Ä–µ–∑ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π –±–æ—Ç
5. **–ú–∞—Å—Ç–µ—Ä –≤–∏–¥–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ** ‚Üí –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
   - ‚ûñ –°–ø–∏—Å–∞—Ç—å X –±–∞–ª–ª–æ–≤
   - ‚ûï –ù–∞—á–∏—Å–ª–∏—Ç—å Y –±–∞–ª–ª–æ–≤ (–∑–∞ –ø–æ–∫—É–ø–∫—É)
   - –ö–Ω–æ–ø–∫–∞ "‚úÖ –û–¥–æ–±—Ä–∏—Ç—å"
6. **–ú–∞—Å—Ç–µ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "–û–¥–æ–±—Ä–∏—Ç—å"** ‚Üí –í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –æ–±–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
   - –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ (–æ–ø–ª–∞—Ç–∞)
   - –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –±–∞–ª–ª–æ–≤ (–∫—ç—à–±—ç–∫ –∑–∞ –ø–æ–∫—É–ø–∫—É)
7. **–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ** ‚Üí –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞

### Backend (Python)

#### 1. –ú–µ—Ç–æ–¥ –≤ `supabase_manager.py`

```python
def redeem_points_for_promotion(self, client_chat_id: str, promotion_id: int, points_to_spend: int) -> dict:
    """
    –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –æ–±–º–µ–Ω –±–∞–ª–ª–æ–≤ –¥–ª—è –∞–∫—Ü–∏–∏ (—á–∞—Å—Ç–∏—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞).
    –ë–∞–ª–ª—ã –ù–ï —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Å—Ä–∞–∑—É - —Å–æ–∑–¥–∞–µ—Ç—Å—è QR-–∫–æ–¥ –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞.
    
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
    - –ê–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∞–∫—Ç–∏–≤–Ω–∞
    - –î–∞—Ç—ã –∞–∫—Ü–∏–∏ –≤–∞–ª–∏–¥–Ω—ã
    - –ú–æ–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å –±–∞–ª–ª–∞–º–∏ (max_points_payment > 0)
    - –£ –∫–ª–∏–µ–Ω—Ç–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤
    - –°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –º–∞–∫—Å–∏–º—É–º
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç QR-–∫–æ–¥: PROMOTION:id:client_id:points:usd_value
    """
```

#### 2. –ú–µ—Ç–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

```python
def execute_promotion_transaction(self, client_chat_id: str, partner_chat_id: str, 
                                 promotion_id: int, points_to_spend: int, 
                                 purchase_amount: float) -> dict:
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø–æ –∞–∫—Ü–∏–∏:
    1. –°–ø–∏—Å—ã–≤–∞–µ—Ç –±–∞–ª–ª—ã (spend)
    2. –ù–∞—á–∏—Å–ª—è–µ—Ç –Ω–æ–≤—ã–µ –±–∞–ª–ª—ã –∑–∞ –ø–æ–∫—É–ø–∫—É (accrual)
    
    –ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è - –æ–±–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤–º–µ—Å—Ç–µ.
    """
```

#### 3. API Endpoint –≤ `secure_api.py`

```python
POST /api/redeem-promotion

Request:
{
    "client_chat_id": "123456789",
    "promotion_id": 123,
    "points_to_spend": 50
}

Response:
{
    "success": true,
    "current_balance": 150,
    "points_to_spend": 50,
    "points_value_usd": 50.0,
    "service_price": 100.0,
    "cash_payment": 50.0,
    "qr_data": "PROMOTION:123:123456789:50:50.00"
}
```

### Frontend (React)

#### 1. –§—É–Ω–∫—Ü–∏—è –≤ `supabase.js`

```javascript
export const redeemPromotion = async (clientChatId, promotionId, pointsToSpend) => {
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –∑–∞–ø—Ä–æ—Å –Ω–∞ /api/redeem-promotion
  // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è QR-–∫–æ–¥–∞
}
```

#### 2. UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ `PromotionDetail.jsx`

- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±–∞–ª–ª–æ–≤
- –ü–æ–∫–∞–∑ –±–∞–ª–∞–Ω—Å–∞ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –æ–ø–ª–∞—Ç—ã
- –†–∞—Å—á–µ—Ç –¥–æ–ø–ª–∞—Ç—ã –Ω–∞–ª–∏—á–Ω—ã–º–∏
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –æ–± –∞–∫—Ü–∏–∏

### –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π –±–æ—Ç (`bot.py`)

#### 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ QR-–∫–æ–¥–∞

```python
# –§–æ—Ä–º–∞—Ç QR: PROMOTION:promotion_id:client_chat_id:points_to_spend:points_value_usd
# –ü—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏:
# 1. –ü–∞—Ä—Å–∏—Ç—Å—è QR-–∫–æ–¥
# 2. –ü–æ–ª—É—á–∞–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫—Ü–∏–∏
# 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
```

#### 2. –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ

```
üéÅ –û–ø–ª–∞—Ç–∞ –ø–æ –∞–∫—Ü–∏–∏

–ê–∫—Ü–∏—è: –°–∫–∏–¥–∫–∞ 20% –Ω–∞ –º–∞–Ω–∏–∫—é—Ä
–ö–ª–∏–µ–Ω—Ç ID: 123456789
–ë–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞: 150 –±–∞–ª–ª–æ–≤

üìä –û–ø–µ—Ä–∞—Ü–∏–∏:
‚ûñ –°–ø–∏—Å–∞—Ç—å: 50 –±–∞–ª–ª–æ–≤ ($50.00)
‚ûï –ù–∞—á–∏—Å–ª–∏—Ç—å: 2.5 –±–∞–ª–ª–æ–≤ (–∑–∞ –ø–æ–∫—É–ø–∫—É $100.00)

üí∞ –î–æ–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏: $50.00

‚úÖ –ù–∞–∂–º–∏—Ç–µ '–û–¥–æ–±—Ä–∏—Ç—å' –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

[‚úÖ –û–¥–æ–±—Ä–∏—Ç—å] [‚ùå –û—Ç–º–µ–Ω–∞]
```

#### 3. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–û–¥–æ–±—Ä–∏—Ç—å":
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `execute_promotion_transaction()`
- –°–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –±–∞–ª–ª—ã
- –ù–∞—á–∏—Å–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ –±–∞–ª–ª—ã
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É

---

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `promotions` (–æ–±–Ω–æ–≤–ª–µ–Ω–∞)

```sql
ALTER TABLE promotions 
ADD COLUMN service_price NUMERIC;  -- –°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥–∏ –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö

ADD COLUMN max_points_payment NUMERIC;  -- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏

ADD COLUMN points_to_dollar_rate NUMERIC DEFAULT 1.0;  -- –ö—É—Ä—Å –æ–±–º–µ–Ω–∞
```

**–ü—Ä–∏–º–µ—Ä –∞–∫—Ü–∏–∏:**
- `service_price`: 100.0 (—Å—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥–∏ $100)
- `max_points_payment`: 50.0 (–º–æ–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å –¥–æ $50 –±–∞–ª–ª–∞–º–∏)
- `points_to_dollar_rate`: 1.0 (1 –±–∞–ª–ª = $1)

### –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–æ–∑–¥–∞—é—Ç—Å—è **2 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**:

1. **–°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤:**
```sql
operation_type: 'redemption'
spent_points: 50
description: "–°–ø–∏—Å–∞–Ω–∏–µ 50 –±–æ–Ω—É—Å–æ–≤ (–ê–∫—Ü–∏—è: –°–∫–∏–¥–∫–∞ 20% –Ω–∞ –º–∞–Ω–∏–∫—é—Ä)"
```

2. **–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤:**
```sql
operation_type: 'accrual'
earned_points: 2.5  -- 2.5% –æ—Ç $100
description: "–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ 2.5 –±–æ–Ω—É—Å–æ–≤ –∑–∞ —á–µ–∫ 100.0 —Ä—É–±. (–ü–∞—Ä—Ç–Ω–µ—Ä: 987654321)"
```

---

## üéØ –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π: –ß–∞—Å—Ç–∏—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏

1. **–ê–∫—Ü–∏—è:** "–°–∫–∏–¥–∫–∞ 20% –Ω–∞ –º–∞–Ω–∏–∫—é—Ä"
   - –°—Ç–æ–∏–º–æ—Å—Ç—å: $100
   - –ú–æ–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å –±–∞–ª–ª–∞–º–∏: –¥–æ $50

2. **–ö–ª–∏–µ–Ω—Ç:**
   - –ë–∞–ª–∞–Ω—Å: 150 –±–∞–ª–ª–æ–≤
   - –í—ã–±–∏—Ä–∞–µ—Ç –æ–ø–ª–∞—Ç–∏—Ç—å 50 –±–∞–ª–ª–æ–≤ ($50)
   - –í–∏–¥–∏—Ç: –¥–æ–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏ $50

3. **QR-–∫–æ–¥:** `PROMOTION:123:456789:50:50.00`

4. **–ú–∞—Å—Ç–µ—Ä —Å–∫–∞–Ω–∏—Ä—É–µ—Ç:**
   - –í–∏–¥–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
   - –ù–∞–∂–∏–º–∞–µ—Ç "‚úÖ –û–¥–æ–±—Ä–∏—Ç—å"

5. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚úÖ –°–ø–∏—Å–∞–Ω–æ: 50 –±–∞–ª–ª–æ–≤
   - ‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–æ: 2.5 –±–∞–ª–ª–æ–≤ (2.5% –æ—Ç $100)
   - ‚úÖ –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: 102.5 –±–∞–ª–ª–æ–≤
   - ‚úÖ –ö–ª–∏–µ–Ω—Ç –¥–æ–ø–ª–∞—á–∏–≤–∞–µ—Ç $50 –Ω–∞–ª–∏—á–Ω—ã–º–∏

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ü—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è –∞–∫—Ü–∏–∏**
   - –ê–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   - –ê–∫—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞ (`is_active = True`)
   - –ê–∫—Ü–∏—è –Ω–µ –∏—Å—Ç–µ–∫–ª–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç)

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–ø–ª–∞—Ç—ã**
   - `max_points_payment > 0`
   - –°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –º–∞–∫—Å–∏–º—É–º
   - –ö—É—Ä—Å –æ–±–º–µ–Ω–∞ –≤–∞–ª–∏–¥–µ–Ω

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞**
   - –£ –∫–ª–∏–µ–Ω—Ç–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤
   - –ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è (–æ–±–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤–º–µ—Å—Ç–µ)

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∞**
   - –ü–∞—Ä—Ç–Ω–µ—Ä –æ–¥–æ–±—Ä–µ–Ω
   - –ü–∞—Ä—Ç–Ω–µ—Ä —è–≤–ª—è–µ—Ç—Å—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –∞–∫—Ü–∏–∏

### –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫

- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–æ–±–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–º–µ—Å—Ç–µ)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É –∏ –ø–∞—Ä—Ç–Ω–µ—Ä—É

---

## üìä –§–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
PROMOTION:promotion_id:client_chat_id:points_to_spend:points_value_usd
```

**–ü—Ä–∏–º–µ—Ä:**
```
PROMOTION:123:456789:50:50.00
```

**–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞:**
- `123` - ID –∞–∫—Ü–∏–∏
- `456789` - Chat ID –∫–ª–∏–µ–Ω—Ç–∞
- `50` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è
- `50.00` - –°—Ç–æ–∏–º–æ—Å—Ç—å –±–∞–ª–ª–æ–≤ –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö

---

## üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–∫—Ü–∏–∏ –¥–ª—è –æ–ø–ª–∞—Ç—ã –±–∞–ª–ª–∞–º–∏

### SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π

```sql
-- –í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é add_points_payment_to_promotions.sql
ALTER TABLE promotions 
ADD COLUMN service_price NUMERIC,
ADD COLUMN max_points_payment NUMERIC,
ADD COLUMN points_to_dollar_rate NUMERIC DEFAULT 1.0;
```

### –ü—Ä–∏–º–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫—Ü–∏–∏ —Å –æ–ø–ª–∞—Ç–æ–π –±–∞–ª–ª–∞–º–∏

```sql
INSERT INTO promotions (
    partner_chat_id,
    title,
    description,
    discount_value,
    service_price,          -- $100
    max_points_payment,     -- $50 –º–æ–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å –±–∞–ª–ª–∞–º–∏
    points_to_dollar_rate,   -- 1.0 (1 –±–∞–ª–ª = $1)
    start_date,
    end_date,
    is_active
) VALUES (
    '987654321',
    '–°–∫–∏–¥–∫–∞ 20% –Ω–∞ –º–∞–Ω–∏–∫—é—Ä',
    '–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –Ω–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤',
    '20%',
    100.0,    -- –°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥–∏
    50.0,     -- –ú–æ–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å –¥–æ $50 –±–∞–ª–ª–∞–º–∏
    1.0,      -- –ö—É—Ä—Å –æ–±–º–µ–Ω–∞
    '2025-01-01',
    '2025-12-31',
    true
);
```

---

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```python
# –í supabase_manager.py
logging.info(f"Preparing promotion redemption: promotion_id={promotion_id}, points={points_to_spend}")
logging.info(f"Executing promotion transaction: spent={points_to_spend}, earned={points_earned}")
```

### –õ–æ–≥–∏ –≤ –±–æ—Ç–µ

```python
# –í bot.py
logger.info(f"–ü–∞—Ä—Ç–Ω—ë—Ä {chat_id} –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–ª QR-–∫–æ–¥ –∞–∫—Ü–∏–∏ {promotion_id}")
logger.info(f"–ü–∞—Ä—Ç–Ω—ë—Ä {chat_id} –æ–¥–æ–±—Ä–∏–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø–æ –∞–∫—Ü–∏–∏ {promotion_id}")
```

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **"–ê–∫—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–ø–ª–∞—Ç—É –±–∞–ª–ª–∞–º–∏"**
   - –†–µ—à–µ–Ω–∏–µ: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `max_points_payment > 0` –¥–ª—è –∞–∫—Ü–∏–∏

2. **"–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∞"**
   - –†–µ—à–µ–Ω–∏–µ: –£–º–µ–Ω—å—à–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤ –∏–ª–∏ —É–≤–µ–ª–∏—á—å—Ç–µ `max_points_payment`

3. **"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤"**
   - –†–µ—à–µ–Ω–∏–µ: –ö–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –Ω–∞–∫–æ–ø–∏—Ç—å –±–æ–ª—å—à–µ –±–∞–ª–ª–æ–≤

4. **QR-–∫–æ–¥ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç—Å—è**
   - –†–µ—à–µ–Ω–∏–µ: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ QR-–∫–æ–¥ —á–µ—Ç–∫–æ –≤–∏–¥–µ–Ω, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º

- [ ] SQL –º–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (`add_points_payment_to_promotions.sql`)
- [ ] –ê–∫—Ü–∏–∏ –∏–º–µ—é—Ç –ø–æ–ª—è `service_price` –∏ `max_points_payment`
- [ ] API endpoint `/api/redeem-promotion` –¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `VITE_API_URL` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ Netlify
- [ ] –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π –±–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç QR-–∫–æ–¥—ã —Ñ–æ—Ä–º–∞—Ç–∞ `PROMOTION:...`
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR-–∫–æ–¥–∞ –º–∞—Å—Ç–µ—Ä–æ–º
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç—É
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `add_points_payment_to_promotions.sql` - SQL –º–∏–≥—Ä–∞—Ü–∏—è
- `supabase_manager.py` - –º–µ—Ç–æ–¥—ã `redeem_points_for_promotion()` –∏ `execute_promotion_transaction()`
- `secure_api.py` - endpoint `/api/redeem-promotion`
- `frontend/src/services/supabase.js` - —Ñ—É–Ω–∫—Ü–∏—è `redeemPromotion()`
- `frontend/src/pages/PromotionDetail.jsx` - UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- `bot.py` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ QR-–∫–æ–¥–æ–≤ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

---

**–ì–æ—Ç–æ–≤–æ!** üéâ –°–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã –±–∞–ª–ª–∞–º–∏ –≤ –∞–∫—Ü–∏—è—Ö –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞!


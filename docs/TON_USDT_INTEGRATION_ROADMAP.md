# Отчёт: Интеграция TON/USDT в LoyalityBot (Sarafano)

**Дата:** 2026-02  
**Версия:** 1.0  
**Статус:** Дорожная карта и CJM

---

## 1. Ключевые выводы из анализа

### Плюсы TON для TMA

| Аспект | Описание |
|--------|----------|
| **Бесшовная интеграция** | TON Connect 2.0 — подключение кошелька (Wallet/Tonkeeper) в пару кликов без выхода из Telegram |
| **Низкие комиссии** | ~$0.01–0.05 против 2–5% в фиате |
| **Скорость** | Подтверждение за секунды вместо дней |
| **Смарт-контракты** | Холдирование, эскроу, автоматическое распределение долей |
| **Отсутствие фиатных барьеров** | Подходит для Вьетнама и других локаций без эквайринга |

### Риски и митигации

| Риск | Решение |
|------|---------|
| Волатильность TON | **USDT (Jetton) на TON** — фиксированная цена |
| Порог входа | Онбординг, инструкции, упрощённый UX |
| Регуляция Apple/Google | Для физических услуг/товаров — меньше ограничений |

### Рекомендуемый стек

- **TON Connect 2.0** — авторизация кошелька в Mini App
- **TonAPI / TonCenter** — отслеживание транзакций, вебхуки
- **USDT (Jetton)** — расчёты в стейблкоине
- **n8n** — вебхуки для автоматизации (опционально)

---

## 2. Текущее состояние проекта

### Роли и денежные потоки

| Роль | Текущие потоки | TON/USDT |
|------|----------------|----------|
| **Клиент** | Баллы (USD), кэшбэк, оплата баллами в акциях | Нет |
| **Партнёр** | `deposit_balance` для кэшбэка, Revenue Share | `ton_payments`, `ton_wallet_address`, `payment_method` в миграциях |
| **Амбассадор** | `balance_pending`, выплаты (card/SBP/crypto) | `payment_method: 'crypto'` в `ambassador_payout_requests` |

### Уже есть в проекте

- Миграции: `add_ton_to_partners.sql`, `create_ton_payments_table.sql`
- Документация: `TON_COIN_INTEGRATION_PLAN.md`, `TON_COIN_PAYMENT_OPTIMIZATION.md`, `PAYMENT_METHODS_COMPARISON.md`
- `ton_payment_service.py` (Python) — но продакшн на Cloudflare Workers
- `ambassador_payout_requests` с `payment_method IN ('card', 'sbp', 'crypto')`

### Чего нет

- TON Connect 2.0 во фронтенде (Mini App)
- USDT (Jetton) — везде используется TON
- TonAPI/TonCenter для вебхуков
- Интеграция TON в Cloudflare Workers (вместо Python)

---

## 3. Дорожная карта внедрения

### Фаза 0: Подготовка (1–2 недели)

| # | Задача | Результат |
|---|--------|-----------|
| 0.1 | Выбор: TON vs USDT | Рекомендация: **USDT на TON** для расчётов |
| 0.2 | Создание платформенного кошелька | Холодный/горячий кошелёк, хранение seed |
| 0.3 | Регистрация TonAPI / TonCenter | API-ключи для мониторинга транзакций |
| 0.4 | Миграция БД для USDT | Поля `usdt_amount`, `jetton_contract` в `ton_payments` |

### Фаза 1: Партнёры — выплаты (2–3 недели)

| # | Задача | Файлы/компоненты |
|---|--------|------------------|
| 1.1 | TON Payment Service в Workers | `cloudflare/workers/api/ton.js` или отдельный worker |
| 1.2 | `/setup_wallet` в партнёрском боте | `partner-webhook/index.js` |
| 1.3 | `/payment_method` (bank / ton / usdt) | `partner-webhook/index.js` |
| 1.4 | Автоматические выплаты Revenue Share в USDT | Интеграция с расчётом комиссий |
| 1.5 | Вебхуки TonAPI для подтверждения | Cloudflare Worker или n8n |

### Фаза 2: Амбассадоры — выплаты (1–2 недели)

| # | Задача | Файлы/компоненты |
|---|--------|------------------|
| 2.1 | Расширить `payment_method` | Добавить `'ton'` / `'usdt'` в `ambassador_payout_requests` |
| 2.2 | Поле `ton_wallet_address` в `ambassadors` | Миграция |
| 2.3 | Выплаты в USDT при `payment_method = 'crypto'` | `client-webhook` + TON service |
| 2.4 | Кабинет амбассадора: выбор метода выплат | UI в боте / Mini App |

### Фаза 3: Клиенты — пополнение депозита партнёра (2–3 недели)

| # | Задача | Файлы/компоненты |
|---|--------|------------------|
| 3.1 | TON Connect 2.0 во фронтенде | `frontend/` — React-компонент |
| 3.2 | Страница «Пополнить депозит» в Mini App | Для партнёра: пополнение `deposit_balance` |
| 3.3 | Генерация адреса/инвойса для оплаты | API + TonAPI для отслеживания |
| 3.4 | Вебхук при получении USDT | Обновление `partners.deposit_balance` |

### Фаза 4: Клиенты — оплата услуг (3–4 недели)

| # | Задача | Файлы/компоненты |
|---|--------|------------------|
| 4.1 | Оплата услуг USDT в Mini App | TON Connect + Jetton transfer |
| 4.2 | Эскроу/холдирование | Смарт-контракт или доверенная логика |
| 4.3 | Подтверждение оплаты мастером | QR / deep link в партнёрском боте |
| 4.4 | Конвертация USDT → баллы (опция) | Альтернатива прямому кэшбэку |

### Фаза 5: Оптимизация и масштабирование (ongoing)

| # | Задача |
|---|--------|
| 5.1 | Batch-выплаты для снижения комиссий |
| 5.2 | Дашборд TON-транзакций для админов |
| 5.3 | Автоматические отчёты и налоговая документация |
| 5.4 | Онбординг: «Как купить USDT» для новых пользователей |

---

## 4. CJM и взаимодействия ролей

### 4.1. Клиент (Client)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ CJM: КЛИЕНТ                                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [Регистрация] → [Выбор партнёра/услуги] → [Оплата] → [Получение кэшбэка]  │
│                                                                             │
│  Текущий поток (баллы):                                                      │
│  • Оплата наличными/картой у партнёра → QR → Мастер подтверждает → Баллы   │
│                                                                             │
│  Будущий поток (USDT):                                                       │
│  • Mini App → TON Connect → Выбор услуги → Оплата USDT → Подтверждение     │
│  • Или: пополнение баллов USDT (конвертация 1 USDT = 1 балл)                │
│                                                                             │
│  Точки касания с TON:                                                        │
│  • Подключение кошелька (Wallet/Tonkeeper)                                  │
│  • Оплата услуг USDT                                                         │
│  • (Опционально) Покупка баллов за USDT                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2. Партнёр (Partner)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ CJM: ПАРТНЁР                                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [Онбординг] → [Настройка TON] → [Пополнение депозита] → [Выплаты]          │
│                                                                             │
│  Текущий поток:                                                              │
│  • deposit_balance — источник кэшбэка                                       │
│  • Revenue Share — комиссия платформе, выплата банком/TON                    │
│                                                                             │
│  Будущий поток (USDT):                                                       │
│  1. /setup_wallet → привязка TON-кошелька                                   │
│  2. /payment_method → выбор: bank / usdt                                    │
│  3. Пополнение deposit: клиент платит USDT → вебхук → deposit_balance ↑     │
│  4. Выплата Revenue Share: платформа отправляет USDT на кошелёк партнёра    │
│                                                                             │
│  Точки касания с TON:                                                        │
│  • Настройка кошелька (бот)                                                 │
│  • Получение USDT от клиентов (пополнение депозита)                         │
│  • Получение USDT от платформы (Revenue Share)                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.3. Амбассадор (Ambassador)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ CJM: АМБАССАДОР                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [Silver+] → [Выбор партнёров] → [Продвижение] → [Запрос выплаты]           │
│                                                                             │
│  Текущий поток:                                                              │
│  • balance_pending накапливается от комиссий                                  │
│  • «Запросить выплату» → card / sbp / crypto                                │
│  • Админ одобряет → ручной перевод                                          │
│                                                                             │
│  Будущий поток (USDT):                                                       │
│  • payment_method = 'usdt' → привязка TON-кошелька                           │
│  • Запрос выплаты → проверка balance_pending ≥ 500                           │
│  • Админ одобряет → автоматическая отправка USDT                             │
│                                                                             │
│  Точки касания с TON:                                                        │
│  • Настройка кошелька (кабинет амбассадора)                                 │
│  • Получение USDT от платформы (автоматически после одобрения)              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.4. Админ (Admin)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ CJM: АДМИН                                                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [Модерация] → [Одобрение выплат] → [Мониторинг TON] → [Отчёты]             │
│                                                                             │
│  Текущий поток:                                                              │
│  • Одобрение ambassador_payout_requests                                      │
│  • Ручные выплаты (card/SBP)                                                │
│                                                                             │
│  Будущий поток (USDT):                                                       │
│  1. Одобрение заявки амбассадора → триггер автоматической USDT-выплаты      │
│  2. Дашборд: pending / sent / confirmed / failed                            │
│  3. Ручной retry для failed                                                 │
│  4. Отчёты: ton_payments, курс на момент выплаты                            │
│                                                                             │
│  Точки касания с TON:                                                        │
│  • Админ-панель: список TON-транзакций                                      │
│  • Одобрение выплат с автоматической отправкой                              │
│  • Мониторинг баланса платформенного кошелька                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Матрица взаимодействий

| От кого | Кому | Что передаётся | Канал | TON/USDT |
|---------|------|----------------|-------|----------|
| Клиент | Партнёр | Оплата услуги | Mini App → USDT | Да (Фаза 4) |
| Клиент | Платформа | Пополнение баллов | Mini App → USDT | Опционально |
| Партнёр | Платформа | Депозит для кэшбэка | USDT → deposit_balance | Да (Фаза 3) |
| Платформа | Партнёр | Revenue Share | USDT на кошелёк | Да (Фаза 1) |
| Платформа | Амбассадор | Комиссия за продвижение | USDT на кошелёк | Да (Фаза 2) |
| Админ | Партнёр/Амбассадор | Одобрение выплаты | Триггер USDT-транзакции | Да |

---

## 6. Рекомендации

### Приоритет 1: USDT вместо TON

- Снижение волатильности
- Понятная цена для пользователей
- Совместимо с текущей логикой (1 балл = $1)

### Приоритет 2: Cloudflare Workers вместо Python

- Продакшн уже на Workers
- `ton_payment_service.py` нужно портировать в JS или вынести в отдельный worker

### Приоритет 3: TON Connect в Mini App

- Единая точка входа для кошелька
- Используется и для клиентов, и для партнёров (в кабинете)

### Приоритет 4: Онбординг

- Краткая инструкция «Как купить USDT» (Telegram Wallet, Tonkeeper, биржи)
- Видео/гайд в боте и в Mini App

---

## 7. Риски и митигации

| Риск | Митигация |
|------|-----------|
| Регуляция Apple/Google | Фокус на физических услугах; при необходимости — PWA вне магазинов |
| Нежелание использовать крипту | Сохранить card/SBP; USDT как опция |
| Технические сбои TON | Retry, fallback на банк, мониторинг |
| Взлом/утечка seed | Отдельный кошелёк для выплат, минимальный горячий баланс |

---

## 8. Итог

Интеграция TON/USDT логично дополняет текущую архитектуру LoyalityBot. Оптимальный порядок: сначала выплаты партнёрам и амбассадорам в USDT, затем пополнение депозита партнёров, и в конце — прямая оплата услуг клиентами через Mini App.

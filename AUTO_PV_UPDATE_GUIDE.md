# 🔄 Автоматическое обновление PV при росте доходов партнера

**Дата:** Ноябрь 2025  
**Версия:** 1.0

---

## 🎯 Обзор

Система автоматически увеличивает PV (Partner Value) процент для партнера при росте его личного дохода от использования системы.

### Логика автоматического обновления:

```
Личный доход партнера → Автоматический PV
├─ $0-999/мес        → PV = 3%  (Новичок)
├─ $1,000-1,999/мес  → PV = 5%  (Активный)
├─ $2,000-4,999/мес  → PV = 7%  (Растущий)
└─ $5,000+/мес       → PV = 10% (Премиум)
```

---

## 📊 Таблица уровней PV

```
╔═══════════════════════════════════════════════════════════════════════════╗
║              УРОВНИ PV НА ОСНОВЕ ЛИЧНОГО ДОХОДА                             ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                           ║
║  УРОВЕНЬ    │ ДОХОД/МЕС    │ PV    │ ОПИСАНИЕ                              ║
║  ───────────┼──────────────┼───────┼────────────────────────────────────── ║
║  Новичок    │ $0-999       │ 3%    │ Низкий барьер входа                   ║
║  Активный   │ $1,000-1,999 │ 5%    │ Мотивация к росту                     ║
║  Растущий   │ $2,000-4,999 │ 7%    │ Вознаграждение за рост                ║
║  Премиум    │ $5,000+      │ 10%   │ Максимальная лояльность                ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

---

## 🚀 Использование

### Автоматическое обновление (по умолчанию)

```python
from partner_revenue_share import PartnerRevenueShare
from supabase_manager import SupabaseManager

db = SupabaseManager()
revenue_share = PartnerRevenueShare(db)

# При обновлении дохода PV обновляется автоматически
revenue_share.update_partner_income_and_clients(
    partner_chat_id="123456789",
    personal_income=1200.0,  # $1,200/мес
    client_count=30,
    auto_update_pv=True  # По умолчанию True
)

# PV автоматически установится в 5% (так как доход $1,000-1,999)
```

### Ручное управление PV

```python
# Если нужно установить PV вручную (переопределить автоматику)
revenue_share.set_partner_pv(
    partner_chat_id="123456789",
    pv_percent=8.0,  # Ручная установка 8%
    industry_type="salon"
)

# При следующем обновлении дохода автоматика снова сработает
# (если auto_update_pv=True)
```

### Расчет PV вручную

```python
# Рассчитать PV на основе дохода без обновления в БД
pv = revenue_share.calculate_pv_by_income(2500.0)  # $2,500/мес
print(f"PV для дохода $2,500/мес: {pv}%")  # Выведет: 7%
```

---

## 📈 Примеры роста

### Пример 1: Постепенный рост

```
МЕСЯЦ 1: НОВИЧОК
├─ Личный доход: $600/мес
├─ PV: 3% (автоматически)
├─ Доход системы: $20,000 × 3% = $600/мес
└─ Revenue Share: $600 × 5% = $30/мес

МЕСЯЦ 3: РОСТ
├─ Личный доход: $1,200/мес (+100%)
├─ PV: 5% (автоматически увеличен)
├─ Доход системы: $20,000 × 5% = $1,000/мес (+67%)
└─ Revenue Share: $1,000 × 5% = $50/мес (+67%)

МЕСЯЦ 6: ЗНАЧИТЕЛЬНЫЙ РОСТ
├─ Личный доход: $2,500/мес (+317%)
├─ PV: 7% (автоматически увеличен)
├─ Доход системы: $20,000 × 7% = $1,400/мес (+133%)
└─ Revenue Share: $1,400 × 5% = $70/мес (+133%)

МЕСЯЦ 12: ПРЕМИУМ
├─ Личный доход: $5,500/мес (+817%)
├─ PV: 10% (максимальный)
├─ Доход системы: $20,000 × 10% = $2,000/мес (+233%)
└─ Revenue Share: $2,000 × 5% = $100/мес (+233%)
```

### Пример 2: Влияние на Revenue Share

```
ПАРТНЕР А (получает Revenue Share):
├─ Личный доход: $1,000/мес
└─ Лимит Revenue Share: $1,000 × 30% = $300/мес

ПАРТНЕР Б (источник Revenue Share):
├─ Оборот: $20,000/мес
├─ Личный доход: $600/мес → PV = 3%
├─ Доход системы: $20,000 × 3% = $600/мес
└─ Revenue Share для А: $600 × 5% = $30/мес

ПАРТНЕР Б (после роста):
├─ Оборот: $20,000/мес (тот же)
├─ Личный доход: $2,500/мес → PV = 7% (автоматически)
├─ Доход системы: $20,000 × 7% = $1,400/мес (+133%)
└─ Revenue Share для А: $1,400 × 5% = $70/мес (+133%)
```

---

## 🔧 Техническая реализация

### SQL функция

```sql
-- Функция автоматически вызывается при обновлении personal_income_monthly
SELECT calculate_pv_by_income(1200.0);  -- Вернет 5.0
SELECT calculate_pv_by_income(2500.0);  -- Вернет 7.0
SELECT calculate_pv_by_income(5500.0);  -- Вернет 10.0
```

### Python метод

```python
# Метод calculate_pv_by_income() автоматически вызывается
# при обновлении дохода партнера
pv = revenue_share.calculate_pv_by_income(1200.0)
# Вернет: 5.0
```

### Триггер в БД

```sql
-- Триггер автоматически обновляет PV при изменении дохода
-- Срабатывает при UPDATE personal_income_monthly
```

---

## ⚙️ Настройка уровней PV

### Изменение уровней

```python
# В partner_revenue_share.py можно изменить PV_LEVELS:

PV_LEVELS = [
    {'min': 0, 'max': 999, 'pv': 3.0},      # Новичок
    {'min': 1000, 'max': 1999, 'pv': 5.0},  # Активный
    {'min': 2000, 'max': 4999, 'pv': 7.0},  # Растущий
    {'min': 5000, 'max': float('inf'), 'pv': 10.0}  # Премиум
]
```

### Пример: Более агрессивная прогрессия

```python
PV_LEVELS = [
    {'min': 0, 'max': 499, 'pv': 2.0},      # Новичок: 2%
    {'min': 500, 'max': 1499, 'pv': 4.0},   # Активный: 4%
    {'min': 1500, 'max': 2999, 'pv': 6.0},  # Растущий: 6%
    {'min': 3000, 'max': 9999, 'pv': 8.0},  # Премиум: 8%
    {'min': 10000, 'max': float('inf'), 'pv': 12.0}  # VIP: 12%
]
```

---

## 📊 Мониторинг автоматического обновления

### Просмотр истории изменений PV

```sql
-- Можно добавить таблицу для отслеживания изменений PV
SELECT 
    chat_id,
    personal_income_monthly,
    pv_percent,
    last_revenue_share_calculation
FROM partners
WHERE partner_type != 'regular'
ORDER BY personal_income_monthly DESC;
```

### Статистика по уровням PV

```sql
SELECT 
    CASE 
        WHEN personal_income_monthly < 1000 THEN 'Новичок (3%)'
        WHEN personal_income_monthly < 2000 THEN 'Активный (5%)'
        WHEN personal_income_monthly < 5000 THEN 'Растущий (7%)'
        ELSE 'Премиум (10%)'
    END as pv_level,
    COUNT(*) as partners_count,
    AVG(personal_income_monthly) as avg_income,
    AVG(pv_percent) as avg_pv
FROM partners
WHERE partner_type != 'regular'
GROUP BY pv_level
ORDER BY avg_pv;
```

---

## ⚠️ Важные замечания

1. **Автоматическое обновление по умолчанию**
   - При вызове `update_partner_income_and_clients()` PV обновляется автоматически
   - Можно отключить: `auto_update_pv=False`

2. **Ручная установка переопределяет автоматику**
   - Если установить PV вручную, он сохранится
   - При следующем обновлении дохода автоматика снова сработает (если `auto_update_pv=True`)

3. **PV не уменьшается автоматически**
   - Если доход снизился, PV остается на том же уровне
   - Это мотивирует партнеров не снижать активность

4. **Максимальный PV = 10%**
   - Даже при очень высоком доходе PV не превышает 10%
   - Это защита от чрезмерных выплат

---

## ✅ Преимущества

```
✅ МОТИВАЦИЯ К РОСТУ
├─ Партнеры заинтересованы увеличивать доход
├─ Больше доход = больше PV = больше Revenue Share
└─ Справедливое вознаграждение за активность

✅ НИЗКИЙ БАРЬЕР ВХОДА
├─ Новички начинают с PV = 3%
├─ Легко привлечь новых партнеров
└─ Постепенное увеличение при росте

✅ АВТОМАТИЗАЦИЯ
├─ Не нужно вручную настраивать PV
├─ Система сама обновляет при росте
└─ Прозрачная и справедливая система
```

---

**Документ подготовлен:** Ноябрь 2025  
**Версия:** 1.0


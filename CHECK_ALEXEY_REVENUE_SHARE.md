# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ê–ª–µ–∫—Å–µ–π –∏ Revenue Share –æ—Ç 3 –º–∞—Å—Ç–µ—Ä–æ–≤

## üìã –ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

–î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã **–ê–ª–µ–∫—Å–µ–π –ø–æ–ª—É—á–∞–ª Revenue Share** –æ—Ç –º–∞—Å—Ç–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω –ø—Ä–∏–≥–ª–∞—Å–∏–ª, –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —Å–≤—è–∑–∏:

### 1. ‚úÖ –í —Ç–∞–±–ª–∏—Ü–µ `partners`:
- –£ –∫–∞–∂–¥–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–µ `referred_by_chat_id` = chat_id –ê–ª–µ–∫—Å–µ—è
- –£ –∫–∞–∂–¥–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `partner_type = 'master'` –∏ `partner_level = 3` (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

### 2. ‚úÖ –í —Ç–∞–±–ª–∏—Ü–µ `partner_network`:
- –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞:
  - `referrer_chat_id` = chat_id –ê–ª–µ–∫—Å–µ—è
  - `referred_chat_id` = chat_id –º–∞—Å—Ç–µ—Ä–∞
  - `level` = 1 (–ø—Ä—è–º–æ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ)
  - `is_active` = true

## üîç –®–∞–≥ 1: –ù–∞–π—Ç–∏ chat_id

–°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ chat_id –ê–ª–µ–∫—Å–µ—è –∏ 3 –º–∞—Å—Ç–µ—Ä–æ–≤.

### –í–∞—Ä–∏–∞–Ω—Ç –ê: –ï—Å–ª–∏ –∑–Ω–∞–µ—Ç–µ –∏–º–µ–Ω–∞

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ SQL Editor Supabase:

```sql
-- –ù–∞–π—Ç–∏ –ê–ª–µ–∫—Å–µ—è
SELECT chat_id, name, company_name, partner_type 
FROM partners 
WHERE name ILIKE '%–ê–ª–µ–∫—Å–µ–π%' OR name ILIKE '%Alex%';

-- –ù–∞–π—Ç–∏ –º–∞—Å—Ç–µ—Ä–æ–≤ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞)
SELECT chat_id, name, company_name, partner_type, referred_by_chat_id
FROM partners 
WHERE name ILIKE '%–ò–ú–Ø_–ú–ê–°–¢–ï–†–ê_1%' 
   OR name ILIKE '%–ò–ú–Ø_–ú–ê–°–¢–ï–†–ê_2%'
   OR name ILIKE '%–ò–ú–Ø_–ú–ê–°–¢–ï–†–ê_3%';
```

### –í–∞—Ä–∏–∞–Ω—Ç –ë: –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä—ã

```sql
SELECT chat_id, name, company_name, created_at, partner_type, referred_by_chat_id
FROM partners 
ORDER BY created_at DESC 
LIMIT 10;
```

## üîç –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `check_alexey_revenue_share.sql` –≤ SQL Editor Supabase.

**–í–ê–ñ–ù–û:** –ó–∞–º–µ–Ω–∏—Ç–µ –≤—Å–µ `CHAT_ID_–ê–õ–ï–ö–°–ï–Ø` –∏ `CHAT_ID_–ú–ê–°–¢–ï–†–ê_X` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ chat_id –∏–∑ –®–∞–≥–∞ 1.

–ó–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ –æ—á–µ—Ä–µ–¥–∏:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ referred_by_chat_id** - –ø–æ–∫–∞–∂–µ—Ç, –µ—Å—Ç—å –ª–∏ —Å–≤—è–∑—å –º–∞—Å—Ç–µ—Ä–æ–≤ —Å –ê–ª–µ–∫—Å–µ–µ–º
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ partner_network** - –ø–æ–∫–∞–∂–µ—Ç, –µ—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å–∏ –≤ —Å–µ—Ç–∏
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ partner_type** - –ø–æ–∫–∞–∂–µ—Ç, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ —Ç–µ–≥ 'master'

## üîß –®–∞–≥ 3: –ò—Å–ø—Ä–∞–≤–∏—Ç—å (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `fix_alexey_revenue_share.sql` –≤ SQL Editor Supabase.

**–í–ê–ñ–ù–û:** –ó–∞–º–µ–Ω–∏—Ç–µ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è:
- `–ó–ê–ú–ï–ù–ò–¢–ï_–ù–ê_CHAT_ID_–ê–õ–ï–ö–°–ï–Ø` ‚Üí —Ä–µ–∞–ª—å–Ω—ã–π chat_id –ê–ª–µ–∫—Å–µ—è
- `–ó–ê–ú–ï–ù–ò–¢–ï_–ù–ê_CHAT_ID_–ú–ê–°–¢–ï–†–ê_1` ‚Üí —Ä–µ–∞–ª—å–Ω—ã–π chat_id –ø–µ—Ä–≤–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞
- `–ó–ê–ú–ï–ù–ò–¢–ï_–ù–ê_CHAT_ID_–ú–ê–°–¢–ï–†–ê_2` ‚Üí —Ä–µ–∞–ª—å–Ω—ã–π chat_id –≤—Ç–æ—Ä–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞
- `–ó–ê–ú–ï–ù–ò–¢–ï_–ù–ê_CHAT_ID_–ú–ê–°–¢–ï–†–ê_3` ‚Üí —Ä–µ–∞–ª—å–Ω—ã–π chat_id —Ç—Ä–µ—Ç—å–µ–≥–æ –º–∞—Å—Ç–µ—Ä–∞

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ –ø–æ—Ä—è–¥–∫—É:

1. **UPDATE partners** - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç `referred_by_chat_id` –¥–ª—è –º–∞—Å—Ç–µ—Ä–æ–≤
2. **UPDATE partners** - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç `partner_type='master'` –∏ `partner_level=3`
3. **INSERT INTO partner_network** - —Å–æ–∑–¥–∞—Å—Ç –∑–∞–ø–∏—Å–∏ –≤ —Å–µ—Ç–∏ (–µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç)
4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** - –ø–æ–∫–∞–∂–µ—Ç –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

## ‚úÖ –®–∞–≥ 4: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ñ–∏–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –∏–∑ —Ñ–∞–π–ª–∞ `check_alexey_revenue_share.sql` (–®–ê–ì 4).

–í—Å–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ‚úÖ:

```
‚úÖ referred_by_chat_id = chat_id –ê–ª–µ–∫—Å–µ—è
‚úÖ partner_type = 'master'
‚úÖ partner_level = 3
‚úÖ –ó–∞–ø–∏—Å—å –≤ partner_network —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
```

## üìä –ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –∫–∞–∂–¥–∞—è —Å–≤—è–∑—å

### `partners.referred_by_chat_id`
- –•—Ä–∞–Ω–∏—Ç chat_id –ø–∞—Ä—Ç–Ω–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–≥–ª–∞—Å–∏–ª
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∏–µ—Ä–∞—Ä—Ö–∏–∏
- **–ö—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–Ω–æ** –¥–ª—è Revenue Share

### `partner_network`
- –•—Ä–∞–Ω–∏—Ç —Å–≤—è–∑–∏ –º–µ–∂–¥—É –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º–∏
- –£—Ä–æ–≤–µ–Ω—å 1 = –ø—Ä—è–º–æ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ (–ê–ª–µ–∫—Å–µ–π ‚Üí –ú–∞—Å—Ç–µ—Ä)
- –£—Ä–æ–≤–µ–Ω—å 2 = –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã–π –ø—Ä–∏–≥–ª–∞—Å–∏–ª –¥—Ä—É–≥–æ–≥–æ
- –£—Ä–æ–≤–µ–Ω—å 3 = —Ç—Ä–µ—Ç–∏–π —É—Ä–æ–≤–µ–Ω—å
- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ Revenue Share**

### `partner_type` –∏ `partner_level`
- `partner_type = 'master'` - —Ç–µ–≥ –¥–ª—è –º–∞—Å—Ç–µ—Ä-–ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
- `partner_level = 3` - —É—Ä–æ–≤–µ–Ω—å –≤ MLM —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
- **–ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è Revenue Share**, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **chat_id –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π** (TEXT), –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ —á–∏—Å–ª–æ
2. **–í—Å–µ chat_id –¥–æ–ª–∂–Ω—ã —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å** –≤ —Ç–∞–±–ª–∏—Ü–µ `partners` –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–µ–π
3. **partner_network –∏–º–µ–µ—Ç UNIQUE constraint** - –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å —É–∂–µ –µ—Å—Ç—å, –æ–Ω–∞ –Ω–µ –±—É–¥–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è
4. **Revenue Share —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –Ω–∞ –æ—Å–Ω–æ–≤–µ `partner_network`

## üÜò –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–æ–±–ª–µ–º–∞: "foreign key violation"
- **–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ chat_id —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ `partners`

### –ü—Ä–æ–±–ª–µ–º–∞: "duplicate key violation" –≤ partner_network
- **–†–µ—à–µ–Ω–∏–µ:** –ó–∞–ø–∏—Å—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `ON CONFLICT DO UPDATE`

### –ü—Ä–æ–±–ª–µ–º–∞: –ê–ª–µ–∫—Å–µ–π –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç Revenue Share
- **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
  1. –ï—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å–∏ –≤ `partner_network` —Å `referrer_chat_id` = chat_id –ê–ª–µ–∫—Å–µ—è?
  2. –£ –º–∞—Å—Ç–µ—Ä–æ–≤ –µ—Å—Ç—å `referred_by_chat_id` = chat_id –ê–ª–µ–∫—Å–µ—è?
  3. Revenue Share —Å–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç?

## üìû –î–∞–ª—å–Ω–µ–π—à–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–≤—è–∑–µ–π:
1. ‚úÖ –ú–∞—Å—Ç–µ—Ä–∞ –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∏ –Ω–∞—á–∏—Å–ª—è—Ç—å –±–∞–ª–ª—ã –∫–ª–∏–µ–Ω—Ç–∞–º
2. ‚úÖ –ö–æ–≥–¥–∞ –º–∞—Å—Ç–µ—Ä–∞ –∑–∞—Ä–∞–±–æ—Ç–∞—é—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ (—É—Å–ª–æ–≤–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏), –ê–ª–µ–∫—Å–µ–π –Ω–∞—á–Ω–µ—Ç –ø–æ–ª—É—á–∞—Ç—å Revenue Share
3. ‚úÖ Revenue Share —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (—Å–º. `partner_revenue_share.py`)

